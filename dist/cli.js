#!/usr/bin/env node
import{createRequire as m1}from"node:module";var u1=Object.create;var{getPrototypeOf:g1,defineProperty:y0,getOwnPropertyNames:l1}=Object;var c1=Object.prototype.hasOwnProperty;var s1=($,J,X)=>{X=$!=null?u1(g1($)):{};let z=J||!$||!$.__esModule?y0(X,"default",{value:$,enumerable:!0}):X;for(let Z of l1($))if(!c1.call(z,Z))y0(z,Z,{get:()=>$[Z],enumerable:!0});return z};var q=($,J)=>()=>(J||$((J={exports:{}}).exports,J),J.exports);var D=m1(import.meta.url);var v=q((i1)=>{class W0 extends Error{constructor($,J,X){super(X);Error.captureStackTrace(this,this.constructor),this.name=this.constructor.name,this.code=J,this.exitCode=$,this.nestedError=void 0}}class w0 extends W0{constructor($){super(1,"commander.invalidArgument",$);Error.captureStackTrace(this,this.constructor),this.name=this.constructor.name}}i1.CommanderError=W0;i1.InvalidArgumentError=w0});var m=q((t1)=>{var{InvalidArgumentError:r1}=v();class b0{constructor($,J){switch(this.description=J||"",this.variadic=!1,this.parseArg=void 0,this.defaultValue=void 0,this.defaultValueDescription=void 0,this.argChoices=void 0,$[0]){case"<":this.required=!0,this._name=$.slice(1,-1);break;case"[":this.required=!1,this._name=$.slice(1,-1);break;default:this.required=!0,this._name=$;break}if(this._name.length>3&&this._name.slice(-3)==="...")this.variadic=!0,this._name=this._name.slice(0,-3)}name(){return this._name}_concatValue($,J){if(J===this.defaultValue||!Array.isArray(J))return[$];return J.concat($)}default($,J){return this.defaultValue=$,this.defaultValueDescription=J,this}argParser($){return this.parseArg=$,this}choices($){return this.argChoices=$.slice(),this.parseArg=(J,X)=>{if(!this.argChoices.includes(J))throw new r1(`Allowed choices are ${this.argChoices.join(", ")}.`);if(this.variadic)return this._concatValue(J,X);return J},this}argRequired(){return this.required=!0,this}argOptional(){return this.required=!1,this}}function n1($){let J=$.name()+($.variadic===!0?"...":"");return $.required?"<"+J+">":"["+J+"]"}t1.Argument=b0;t1.humanReadableArgName=n1});var f0=q(($$)=>{var{humanReadableArgName:e1}=m();class C0{constructor(){this.helpWidth=void 0,this.sortSubcommands=!1,this.sortOptions=!1,this.showGlobalOptions=!1}visibleCommands($){let J=$.commands.filter((z)=>!z._hidden),X=$._getHelpCommand();if(X&&!X._hidden)J.push(X);if(this.sortSubcommands)J.sort((z,Z)=>{return z.name().localeCompare(Z.name())});return J}compareOptions($,J){let X=(z)=>{return z.short?z.short.replace(/^-/,""):z.long.replace(/^--/,"")};return X($).localeCompare(X(J))}visibleOptions($){let J=$.options.filter((z)=>!z.hidden),X=$._getHelpOption();if(X&&!X.hidden){let z=X.short&&$._findOption(X.short),Z=X.long&&$._findOption(X.long);if(!z&&!Z)J.push(X);else if(X.long&&!Z)J.push($.createOption(X.long,X.description));else if(X.short&&!z)J.push($.createOption(X.short,X.description))}if(this.sortOptions)J.sort(this.compareOptions);return J}visibleGlobalOptions($){if(!this.showGlobalOptions)return[];let J=[];for(let X=$.parent;X;X=X.parent){let z=X.options.filter((Z)=>!Z.hidden);J.push(...z)}if(this.sortOptions)J.sort(this.compareOptions);return J}visibleArguments($){if($._argsDescription)$.registeredArguments.forEach((J)=>{J.description=J.description||$._argsDescription[J.name()]||""});if($.registeredArguments.find((J)=>J.description))return $.registeredArguments;return[]}subcommandTerm($){let J=$.registeredArguments.map((X)=>e1(X)).join(" ");return $._name+($._aliases[0]?"|"+$._aliases[0]:"")+($.options.length?" [options]":"")+(J?" "+J:"")}optionTerm($){return $.flags}argumentTerm($){return $.name()}longestSubcommandTermLength($,J){return J.visibleCommands($).reduce((X,z)=>{return Math.max(X,J.subcommandTerm(z).length)},0)}longestOptionTermLength($,J){return J.visibleOptions($).reduce((X,z)=>{return Math.max(X,J.optionTerm(z).length)},0)}longestGlobalOptionTermLength($,J){return J.visibleGlobalOptions($).reduce((X,z)=>{return Math.max(X,J.optionTerm(z).length)},0)}longestArgumentTermLength($,J){return J.visibleArguments($).reduce((X,z)=>{return Math.max(X,J.argumentTerm(z).length)},0)}commandUsage($){let J=$._name;if($._aliases[0])J=J+"|"+$._aliases[0];let X="";for(let z=$.parent;z;z=z.parent)X=z.name()+" "+X;return X+J+" "+$.usage()}commandDescription($){return $.description()}subcommandDescription($){return $.summary()||$.description()}optionDescription($){let J=[];if($.argChoices)J.push(`choices: ${$.argChoices.map((X)=>JSON.stringify(X)).join(", ")}`);if($.defaultValue!==void 0){if($.required||$.optional||$.isBoolean()&&typeof $.defaultValue==="boolean")J.push(`default: ${$.defaultValueDescription||JSON.stringify($.defaultValue)}`)}if($.presetArg!==void 0&&$.optional)J.push(`preset: ${JSON.stringify($.presetArg)}`);if($.envVar!==void 0)J.push(`env: ${$.envVar}`);if(J.length>0)return`${$.description} (${J.join(", ")})`;return $.description}argumentDescription($){let J=[];if($.argChoices)J.push(`choices: ${$.argChoices.map((X)=>JSON.stringify(X)).join(", ")}`);if($.defaultValue!==void 0)J.push(`default: ${$.defaultValueDescription||JSON.stringify($.defaultValue)}`);if(J.length>0){let X=`(${J.join(", ")})`;if($.description)return`${$.description} ${X}`;return X}return $.description}formatHelp($,J){let X=J.padWidth($,J),z=J.helpWidth||80,Z=2,Y=2;function G(N,R){if(R){let S=`${N.padEnd(X+2)}${R}`;return J.wrap(S,z-2,X+2)}return N}function Q(N){return N.join(`
`).replace(/^/gm," ".repeat(2))}let P=[`Usage: ${J.commandUsage($)}`,""],W=J.commandDescription($);if(W.length>0)P=P.concat([J.wrap(W,z,0),""]);let f=J.visibleArguments($).map((N)=>{return G(J.argumentTerm(N),J.argumentDescription(N))});if(f.length>0)P=P.concat(["Arguments:",Q(f),""]);let B=J.visibleOptions($).map((N)=>{return G(J.optionTerm(N),J.optionDescription(N))});if(B.length>0)P=P.concat(["Options:",Q(B),""]);if(this.showGlobalOptions){let N=J.visibleGlobalOptions($).map((R)=>{return G(J.optionTerm(R),J.optionDescription(R))});if(N.length>0)P=P.concat(["Global Options:",Q(N),""])}let U=J.visibleCommands($).map((N)=>{return G(J.subcommandTerm(N),J.subcommandDescription(N))});if(U.length>0)P=P.concat(["Commands:",Q(U),""]);return P.join(`
`)}padWidth($,J){return Math.max(J.longestOptionTermLength($,J),J.longestGlobalOptionTermLength($,J),J.longestSubcommandTermLength($,J),J.longestArgumentTermLength($,J))}wrap($,J,X,z=40){let Y=new RegExp(`[\\n][${" \\f\\t\\v   -   　\uFEFF"}]+`);if($.match(Y))return $;let G=J-X;if(G<z)return $;let Q=$.slice(0,X),P=$.slice(X).replace(`\r
`,`
`),W=" ".repeat(X),B=`\\s${"​"}`,U=new RegExp(`
|.{1,${G-1}}([${B}]|$)|[^${B}]+?([${B}]|$)`,"g"),N=P.match(U)||[];return Q+N.map((R,S)=>{if(R===`
`)return"";return(S>0?W:"")+R.trimEnd()}).join(`
`)}}$$.Help=C0});var B0=q((Y$)=>{var{InvalidArgumentError:X$}=v();class k0{constructor($,J){this.flags=$,this.description=J||"",this.required=$.includes("<"),this.optional=$.includes("["),this.variadic=/\w\.\.\.[>\]]$/.test($),this.mandatory=!1;let X=Z$($);if(this.short=X.shortFlag,this.long=X.longFlag,this.negate=!1,this.long)this.negate=this.long.startsWith("--no-");this.defaultValue=void 0,this.defaultValueDescription=void 0,this.presetArg=void 0,this.envVar=void 0,this.parseArg=void 0,this.hidden=!1,this.argChoices=void 0,this.conflictsWith=[],this.implied=void 0}default($,J){return this.defaultValue=$,this.defaultValueDescription=J,this}preset($){return this.presetArg=$,this}conflicts($){return this.conflictsWith=this.conflictsWith.concat($),this}implies($){let J=$;if(typeof $==="string")J={[$]:!0};return this.implied=Object.assign(this.implied||{},J),this}env($){return this.envVar=$,this}argParser($){return this.parseArg=$,this}makeOptionMandatory($=!0){return this.mandatory=!!$,this}hideHelp($=!0){return this.hidden=!!$,this}_concatValue($,J){if(J===this.defaultValue||!Array.isArray(J))return[$];return J.concat($)}choices($){return this.argChoices=$.slice(),this.parseArg=(J,X)=>{if(!this.argChoices.includes(J))throw new X$(`Allowed choices are ${this.argChoices.join(", ")}.`);if(this.variadic)return this._concatValue(J,X);return J},this}name(){if(this.long)return this.long.replace(/^--/,"");return this.short.replace(/^-/,"")}attributeName(){return z$(this.name().replace(/^no-/,""))}is($){return this.short===$||this.long===$}isBoolean(){return!this.required&&!this.optional&&!this.negate}}class v0{constructor($){this.positiveOptions=new Map,this.negativeOptions=new Map,this.dualOptions=new Set,$.forEach((J)=>{if(J.negate)this.negativeOptions.set(J.attributeName(),J);else this.positiveOptions.set(J.attributeName(),J)}),this.negativeOptions.forEach((J,X)=>{if(this.positiveOptions.has(X))this.dualOptions.add(X)})}valueFromOption($,J){let X=J.attributeName();if(!this.dualOptions.has(X))return!0;let z=this.negativeOptions.get(X).presetArg,Z=z!==void 0?z:!1;return J.negate===(Z===$)}}function z$($){return $.split("-").reduce((J,X)=>{return J+X[0].toUpperCase()+X.slice(1)})}function Z$($){let J,X,z=$.split(/[ |,]+/);if(z.length>1&&!/^[[<]/.test(z[1]))J=z.shift();if(X=z.shift(),!J&&/^-[^-]$/.test(X))J=X,X=void 0;return{shortFlag:J,longFlag:X}}Y$.Option=k0;Y$.DualOptions=v0});var h0=q((f$)=>{function P$($,J){if(Math.abs($.length-J.length)>3)return Math.max($.length,J.length);let X=[];for(let z=0;z<=$.length;z++)X[z]=[z];for(let z=0;z<=J.length;z++)X[0][z]=z;for(let z=1;z<=J.length;z++)for(let Z=1;Z<=$.length;Z++){let Y=1;if($[Z-1]===J[z-1])Y=0;else Y=1;if(X[Z][z]=Math.min(X[Z-1][z]+1,X[Z][z-1]+1,X[Z-1][z-1]+Y),Z>1&&z>1&&$[Z-1]===J[z-2]&&$[Z-2]===J[z-1])X[Z][z]=Math.min(X[Z][z],X[Z-2][z-2]+1)}return X[$.length][J.length]}function W$($,J){if(!J||J.length===0)return"";J=Array.from(new Set(J));let X=$.startsWith("--");if(X)$=$.slice(2),J=J.map((G)=>G.slice(2));let z=[],Z=3,Y=0.4;if(J.forEach((G)=>{if(G.length<=1)return;let Q=P$($,G),P=Math.max($.length,G.length);if((P-Q)/P>Y){if(Q<Z)Z=Q,z=[G];else if(Q===Z)z.push(G)}}),z.sort((G,Q)=>G.localeCompare(Q)),X)z=z.map((G)=>`--${G}`);if(z.length>1)return`
(Did you mean one of ${z.join(", ")}?)`;if(z.length===1)return`
(Did you mean ${z[0]}?)`;return""}f$.suggestSimilar=W$});var c0=q((R$)=>{var N$=D("node:events").EventEmitter,N0=D("node:child_process"),V=D("node:path"),U0=D("node:fs"),L=D("node:process"),{Argument:U$,humanReadableArgName:K$}=m(),{CommanderError:K0}=v(),{Help:S$}=f0(),{Option:u0,DualOptions:L$}=B0(),{suggestSimilar:g0}=h0();class S0 extends N${constructor($){super();this.commands=[],this.options=[],this.parent=null,this._allowUnknownOption=!1,this._allowExcessArguments=!0,this.registeredArguments=[],this._args=this.registeredArguments,this.args=[],this.rawArgs=[],this.processedArgs=[],this._scriptPath=null,this._name=$||"",this._optionValues={},this._optionValueSources={},this._storeOptionsAsProperties=!1,this._actionHandler=null,this._executableHandler=!1,this._executableFile=null,this._executableDir=null,this._defaultCommandName=null,this._exitCallback=null,this._aliases=[],this._combineFlagAndOptionalValue=!0,this._description="",this._summary="",this._argsDescription=void 0,this._enablePositionalOptions=!1,this._passThroughOptions=!1,this._lifeCycleHooks={},this._showHelpAfterError=!1,this._showSuggestionAfterError=!0,this._outputConfiguration={writeOut:(J)=>L.stdout.write(J),writeErr:(J)=>L.stderr.write(J),getOutHelpWidth:()=>L.stdout.isTTY?L.stdout.columns:void 0,getErrHelpWidth:()=>L.stderr.isTTY?L.stderr.columns:void 0,outputError:(J,X)=>X(J)},this._hidden=!1,this._helpOption=void 0,this._addImplicitHelpCommand=void 0,this._helpCommand=void 0,this._helpConfiguration={}}copyInheritedSettings($){return this._outputConfiguration=$._outputConfiguration,this._helpOption=$._helpOption,this._helpCommand=$._helpCommand,this._helpConfiguration=$._helpConfiguration,this._exitCallback=$._exitCallback,this._storeOptionsAsProperties=$._storeOptionsAsProperties,this._combineFlagAndOptionalValue=$._combineFlagAndOptionalValue,this._allowExcessArguments=$._allowExcessArguments,this._enablePositionalOptions=$._enablePositionalOptions,this._showHelpAfterError=$._showHelpAfterError,this._showSuggestionAfterError=$._showSuggestionAfterError,this}_getCommandAndAncestors(){let $=[];for(let J=this;J;J=J.parent)$.push(J);return $}command($,J,X){let z=J,Z=X;if(typeof z==="object"&&z!==null)Z=z,z=null;Z=Z||{};let[,Y,G]=$.match(/([^ ]+) *(.*)/),Q=this.createCommand(Y);if(z)Q.description(z),Q._executableHandler=!0;if(Z.isDefault)this._defaultCommandName=Q._name;if(Q._hidden=!!(Z.noHelp||Z.hidden),Q._executableFile=Z.executableFile||null,G)Q.arguments(G);if(this._registerCommand(Q),Q.parent=this,Q.copyInheritedSettings(this),z)return this;return Q}createCommand($){return new S0($)}createHelp(){return Object.assign(new S$,this.configureHelp())}configureHelp($){if($===void 0)return this._helpConfiguration;return this._helpConfiguration=$,this}configureOutput($){if($===void 0)return this._outputConfiguration;return Object.assign(this._outputConfiguration,$),this}showHelpAfterError($=!0){if(typeof $!=="string")$=!!$;return this._showHelpAfterError=$,this}showSuggestionAfterError($=!0){return this._showSuggestionAfterError=!!$,this}addCommand($,J){if(!$._name)throw Error(`Command passed to .addCommand() must have a name
- specify the name in Command constructor or using .name()`);if(J=J||{},J.isDefault)this._defaultCommandName=$._name;if(J.noHelp||J.hidden)$._hidden=!0;return this._registerCommand($),$.parent=this,$._checkForBrokenPassThrough(),this}createArgument($,J){return new U$($,J)}argument($,J,X,z){let Z=this.createArgument($,J);if(typeof X==="function")Z.default(z).argParser(X);else Z.default(X);return this.addArgument(Z),this}arguments($){return $.trim().split(/ +/).forEach((J)=>{this.argument(J)}),this}addArgument($){let J=this.registeredArguments.slice(-1)[0];if(J&&J.variadic)throw Error(`only the last argument can be variadic '${J.name()}'`);if($.required&&$.defaultValue!==void 0&&$.parseArg===void 0)throw Error(`a default value for a required argument is never used: '${$.name()}'`);return this.registeredArguments.push($),this}helpCommand($,J){if(typeof $==="boolean")return this._addImplicitHelpCommand=$,this;$=$??"help [command]";let[,X,z]=$.match(/([^ ]+) *(.*)/),Z=J??"display help for command",Y=this.createCommand(X);if(Y.helpOption(!1),z)Y.arguments(z);if(Z)Y.description(Z);return this._addImplicitHelpCommand=!0,this._helpCommand=Y,this}addHelpCommand($,J){if(typeof $!=="object")return this.helpCommand($,J),this;return this._addImplicitHelpCommand=!0,this._helpCommand=$,this}_getHelpCommand(){if(this._addImplicitHelpCommand??(this.commands.length&&!this._actionHandler&&!this._findCommand("help"))){if(this._helpCommand===void 0)this.helpCommand(void 0,void 0);return this._helpCommand}return null}hook($,J){let X=["preSubcommand","preAction","postAction"];if(!X.includes($))throw Error(`Unexpected value for event passed to hook : '${$}'.
Expecting one of '${X.join("', '")}'`);if(this._lifeCycleHooks[$])this._lifeCycleHooks[$].push(J);else this._lifeCycleHooks[$]=[J];return this}exitOverride($){if($)this._exitCallback=$;else this._exitCallback=(J)=>{if(J.code!=="commander.executeSubCommandAsync")throw J};return this}_exit($,J,X){if(this._exitCallback)this._exitCallback(new K0($,J,X));L.exit($)}action($){let J=(X)=>{let z=this.registeredArguments.length,Z=X.slice(0,z);if(this._storeOptionsAsProperties)Z[z]=this;else Z[z]=this.opts();return Z.push(this),$.apply(this,Z)};return this._actionHandler=J,this}createOption($,J){return new u0($,J)}_callParseArg($,J,X,z){try{return $.parseArg(J,X)}catch(Z){if(Z.code==="commander.invalidArgument"){let Y=`${z} ${Z.message}`;this.error(Y,{exitCode:Z.exitCode,code:Z.code})}throw Z}}_registerOption($){let J=$.short&&this._findOption($.short)||$.long&&this._findOption($.long);if(J){let X=$.long&&this._findOption($.long)?$.long:$.short;throw Error(`Cannot add option '${$.flags}'${this._name&&` to command '${this._name}'`} due to conflicting flag '${X}'
-  already used by option '${J.flags}'`)}this.options.push($)}_registerCommand($){let J=(z)=>{return[z.name()].concat(z.aliases())},X=J($).find((z)=>this._findCommand(z));if(X){let z=J(this._findCommand(X)).join("|"),Z=J($).join("|");throw Error(`cannot add command '${Z}' as already have command '${z}'`)}this.commands.push($)}addOption($){this._registerOption($);let J=$.name(),X=$.attributeName();if($.negate){let Z=$.long.replace(/^--no-/,"--");if(!this._findOption(Z))this.setOptionValueWithSource(X,$.defaultValue===void 0?!0:$.defaultValue,"default")}else if($.defaultValue!==void 0)this.setOptionValueWithSource(X,$.defaultValue,"default");let z=(Z,Y,G)=>{if(Z==null&&$.presetArg!==void 0)Z=$.presetArg;let Q=this.getOptionValue(X);if(Z!==null&&$.parseArg)Z=this._callParseArg($,Z,Q,Y);else if(Z!==null&&$.variadic)Z=$._concatValue(Z,Q);if(Z==null)if($.negate)Z=!1;else if($.isBoolean()||$.optional)Z=!0;else Z="";this.setOptionValueWithSource(X,Z,G)};if(this.on("option:"+J,(Z)=>{let Y=`error: option '${$.flags}' argument '${Z}' is invalid.`;z(Z,Y,"cli")}),$.envVar)this.on("optionEnv:"+J,(Z)=>{let Y=`error: option '${$.flags}' value '${Z}' from env '${$.envVar}' is invalid.`;z(Z,Y,"env")});return this}_optionEx($,J,X,z,Z){if(typeof J==="object"&&J instanceof u0)throw Error("To add an Option object use addOption() instead of option() or requiredOption()");let Y=this.createOption(J,X);if(Y.makeOptionMandatory(!!$.mandatory),typeof z==="function")Y.default(Z).argParser(z);else if(z instanceof RegExp){let G=z;z=(Q,P)=>{let W=G.exec(Q);return W?W[0]:P},Y.default(Z).argParser(z)}else Y.default(z);return this.addOption(Y)}option($,J,X,z){return this._optionEx({},$,J,X,z)}requiredOption($,J,X,z){return this._optionEx({mandatory:!0},$,J,X,z)}combineFlagAndOptionalValue($=!0){return this._combineFlagAndOptionalValue=!!$,this}allowUnknownOption($=!0){return this._allowUnknownOption=!!$,this}allowExcessArguments($=!0){return this._allowExcessArguments=!!$,this}enablePositionalOptions($=!0){return this._enablePositionalOptions=!!$,this}passThroughOptions($=!0){return this._passThroughOptions=!!$,this._checkForBrokenPassThrough(),this}_checkForBrokenPassThrough(){if(this.parent&&this._passThroughOptions&&!this.parent._enablePositionalOptions)throw Error(`passThroughOptions cannot be used for '${this._name}' without turning on enablePositionalOptions for parent command(s)`)}storeOptionsAsProperties($=!0){if(this.options.length)throw Error("call .storeOptionsAsProperties() before adding options");if(Object.keys(this._optionValues).length)throw Error("call .storeOptionsAsProperties() before setting option values");return this._storeOptionsAsProperties=!!$,this}getOptionValue($){if(this._storeOptionsAsProperties)return this[$];return this._optionValues[$]}setOptionValue($,J){return this.setOptionValueWithSource($,J,void 0)}setOptionValueWithSource($,J,X){if(this._storeOptionsAsProperties)this[$]=J;else this._optionValues[$]=J;return this._optionValueSources[$]=X,this}getOptionValueSource($){return this._optionValueSources[$]}getOptionValueSourceWithGlobals($){let J;return this._getCommandAndAncestors().forEach((X)=>{if(X.getOptionValueSource($)!==void 0)J=X.getOptionValueSource($)}),J}_prepareUserArgs($,J){if($!==void 0&&!Array.isArray($))throw Error("first parameter to parse must be array or undefined");if(J=J||{},$===void 0&&J.from===void 0){if(L.versions?.electron)J.from="electron";let z=L.execArgv??[];if(z.includes("-e")||z.includes("--eval")||z.includes("-p")||z.includes("--print"))J.from="eval"}if($===void 0)$=L.argv;this.rawArgs=$.slice();let X;switch(J.from){case void 0:case"node":this._scriptPath=$[1],X=$.slice(2);break;case"electron":if(L.defaultApp)this._scriptPath=$[1],X=$.slice(2);else X=$.slice(1);break;case"user":X=$.slice(0);break;case"eval":X=$.slice(1);break;default:throw Error(`unexpected parse option { from: '${J.from}' }`)}if(!this._name&&this._scriptPath)this.nameFromFilename(this._scriptPath);return this._name=this._name||"program",X}parse($,J){let X=this._prepareUserArgs($,J);return this._parseCommand([],X),this}async parseAsync($,J){let X=this._prepareUserArgs($,J);return await this._parseCommand([],X),this}_executeSubCommand($,J){J=J.slice();let X=!1,z=[".js",".ts",".tsx",".mjs",".cjs"];function Z(W,f){let B=V.resolve(W,f);if(U0.existsSync(B))return B;if(z.includes(V.extname(f)))return;let U=z.find((N)=>U0.existsSync(`${B}${N}`));if(U)return`${B}${U}`;return}this._checkForMissingMandatoryOptions(),this._checkForConflictingOptions();let Y=$._executableFile||`${this._name}-${$._name}`,G=this._executableDir||"";if(this._scriptPath){let W;try{W=U0.realpathSync(this._scriptPath)}catch(f){W=this._scriptPath}G=V.resolve(V.dirname(W),G)}if(G){let W=Z(G,Y);if(!W&&!$._executableFile&&this._scriptPath){let f=V.basename(this._scriptPath,V.extname(this._scriptPath));if(f!==this._name)W=Z(G,`${f}-${$._name}`)}Y=W||Y}X=z.includes(V.extname(Y));let Q;if(L.platform!=="win32")if(X)J.unshift(Y),J=l0(L.execArgv).concat(J),Q=N0.spawn(L.argv[0],J,{stdio:"inherit"});else Q=N0.spawn(Y,J,{stdio:"inherit"});else J.unshift(Y),J=l0(L.execArgv).concat(J),Q=N0.spawn(L.execPath,J,{stdio:"inherit"});if(!Q.killed)["SIGUSR1","SIGUSR2","SIGTERM","SIGINT","SIGHUP"].forEach((f)=>{L.on(f,()=>{if(Q.killed===!1&&Q.exitCode===null)Q.kill(f)})});let P=this._exitCallback;Q.on("close",(W)=>{if(W=W??1,!P)L.exit(W);else P(new K0(W,"commander.executeSubCommandAsync","(close)"))}),Q.on("error",(W)=>{if(W.code==="ENOENT"){let f=G?`searched for local subcommand relative to directory '${G}'`:"no directory for search for local subcommand, use .executableDir() to supply a custom directory",B=`'${Y}' does not exist
 - if '${$._name}' is not meant to be an executable command, remove description parameter from '.command()' and use '.description()' instead
 - if the default executable name is not suitable, use the executableFile option to supply a custom name or path
 - ${f}`;throw Error(B)}else if(W.code==="EACCES")throw Error(`'${Y}' not executable`);if(!P)L.exit(1);else{let f=new K0(1,"commander.executeSubCommandAsync","(error)");f.nestedError=W,P(f)}}),this.runningCommand=Q}_dispatchSubcommand($,J,X){let z=this._findCommand($);if(!z)this.help({error:!0});let Z;return Z=this._chainOrCallSubCommandHook(Z,z,"preSubcommand"),Z=this._chainOrCall(Z,()=>{if(z._executableHandler)this._executeSubCommand(z,J.concat(X));else return z._parseCommand(J,X)}),Z}_dispatchHelpCommand($){if(!$)this.help();let J=this._findCommand($);if(J&&!J._executableHandler)J.help();return this._dispatchSubcommand($,[],[this._getHelpOption()?.long??this._getHelpOption()?.short??"--help"])}_checkNumberOfArguments(){if(this.registeredArguments.forEach(($,J)=>{if($.required&&this.args[J]==null)this.missingArgument($.name())}),this.registeredArguments.length>0&&this.registeredArguments[this.registeredArguments.length-1].variadic)return;if(this.args.length>this.registeredArguments.length)this._excessArguments(this.args)}_processArguments(){let $=(X,z,Z)=>{let Y=z;if(z!==null&&X.parseArg){let G=`error: command-argument value '${z}' is invalid for argument '${X.name()}'.`;Y=this._callParseArg(X,z,Z,G)}return Y};this._checkNumberOfArguments();let J=[];this.registeredArguments.forEach((X,z)=>{let Z=X.defaultValue;if(X.variadic){if(z<this.args.length){if(Z=this.args.slice(z),X.parseArg)Z=Z.reduce((Y,G)=>{return $(X,G,Y)},X.defaultValue)}else if(Z===void 0)Z=[]}else if(z<this.args.length){if(Z=this.args[z],X.parseArg)Z=$(X,Z,X.defaultValue)}J[z]=Z}),this.processedArgs=J}_chainOrCall($,J){if($&&$.then&&typeof $.then==="function")return $.then(()=>J());return J()}_chainOrCallHooks($,J){let X=$,z=[];if(this._getCommandAndAncestors().reverse().filter((Z)=>Z._lifeCycleHooks[J]!==void 0).forEach((Z)=>{Z._lifeCycleHooks[J].forEach((Y)=>{z.push({hookedCommand:Z,callback:Y})})}),J==="postAction")z.reverse();return z.forEach((Z)=>{X=this._chainOrCall(X,()=>{return Z.callback(Z.hookedCommand,this)})}),X}_chainOrCallSubCommandHook($,J,X){let z=$;if(this._lifeCycleHooks[X]!==void 0)this._lifeCycleHooks[X].forEach((Z)=>{z=this._chainOrCall(z,()=>{return Z(this,J)})});return z}_parseCommand($,J){let X=this.parseOptions(J);if(this._parseOptionsEnv(),this._parseOptionsImplied(),$=$.concat(X.operands),J=X.unknown,this.args=$.concat(J),$&&this._findCommand($[0]))return this._dispatchSubcommand($[0],$.slice(1),J);if(this._getHelpCommand()&&$[0]===this._getHelpCommand().name())return this._dispatchHelpCommand($[1]);if(this._defaultCommandName)return this._outputHelpIfRequested(J),this._dispatchSubcommand(this._defaultCommandName,$,J);if(this.commands.length&&this.args.length===0&&!this._actionHandler&&!this._defaultCommandName)this.help({error:!0});this._outputHelpIfRequested(X.unknown),this._checkForMissingMandatoryOptions(),this._checkForConflictingOptions();let z=()=>{if(X.unknown.length>0)this.unknownOption(X.unknown[0])},Z=`command:${this.name()}`;if(this._actionHandler){z(),this._processArguments();let Y;if(Y=this._chainOrCallHooks(Y,"preAction"),Y=this._chainOrCall(Y,()=>this._actionHandler(this.processedArgs)),this.parent)Y=this._chainOrCall(Y,()=>{this.parent.emit(Z,$,J)});return Y=this._chainOrCallHooks(Y,"postAction"),Y}if(this.parent&&this.parent.listenerCount(Z))z(),this._processArguments(),this.parent.emit(Z,$,J);else if($.length){if(this._findCommand("*"))return this._dispatchSubcommand("*",$,J);if(this.listenerCount("command:*"))this.emit("command:*",$,J);else if(this.commands.length)this.unknownCommand();else z(),this._processArguments()}else if(this.commands.length)z(),this.help({error:!0});else z(),this._processArguments()}_findCommand($){if(!$)return;return this.commands.find((J)=>J._name===$||J._aliases.includes($))}_findOption($){return this.options.find((J)=>J.is($))}_checkForMissingMandatoryOptions(){this._getCommandAndAncestors().forEach(($)=>{$.options.forEach((J)=>{if(J.mandatory&&$.getOptionValue(J.attributeName())===void 0)$.missingMandatoryOptionValue(J)})})}_checkForConflictingLocalOptions(){let $=this.options.filter((X)=>{let z=X.attributeName();if(this.getOptionValue(z)===void 0)return!1;return this.getOptionValueSource(z)!=="default"});$.filter((X)=>X.conflictsWith.length>0).forEach((X)=>{let z=$.find((Z)=>X.conflictsWith.includes(Z.attributeName()));if(z)this._conflictingOption(X,z)})}_checkForConflictingOptions(){this._getCommandAndAncestors().forEach(($)=>{$._checkForConflictingLocalOptions()})}parseOptions($){let J=[],X=[],z=J,Z=$.slice();function Y(Q){return Q.length>1&&Q[0]==="-"}let G=null;while(Z.length){let Q=Z.shift();if(Q==="--"){if(z===X)z.push(Q);z.push(...Z);break}if(G&&!Y(Q)){this.emit(`option:${G.name()}`,Q);continue}if(G=null,Y(Q)){let P=this._findOption(Q);if(P){if(P.required){let W=Z.shift();if(W===void 0)this.optionMissingArgument(P);this.emit(`option:${P.name()}`,W)}else if(P.optional){let W=null;if(Z.length>0&&!Y(Z[0]))W=Z.shift();this.emit(`option:${P.name()}`,W)}else this.emit(`option:${P.name()}`);G=P.variadic?P:null;continue}}if(Q.length>2&&Q[0]==="-"&&Q[1]!=="-"){let P=this._findOption(`-${Q[1]}`);if(P){if(P.required||P.optional&&this._combineFlagAndOptionalValue)this.emit(`option:${P.name()}`,Q.slice(2));else this.emit(`option:${P.name()}`),Z.unshift(`-${Q.slice(2)}`);continue}}if(/^--[^=]+=/.test(Q)){let P=Q.indexOf("="),W=this._findOption(Q.slice(0,P));if(W&&(W.required||W.optional)){this.emit(`option:${W.name()}`,Q.slice(P+1));continue}}if(Y(Q))z=X;if((this._enablePositionalOptions||this._passThroughOptions)&&J.length===0&&X.length===0){if(this._findCommand(Q)){if(J.push(Q),Z.length>0)X.push(...Z);break}else if(this._getHelpCommand()&&Q===this._getHelpCommand().name()){if(J.push(Q),Z.length>0)J.push(...Z);break}else if(this._defaultCommandName){if(X.push(Q),Z.length>0)X.push(...Z);break}}if(this._passThroughOptions){if(z.push(Q),Z.length>0)z.push(...Z);break}z.push(Q)}return{operands:J,unknown:X}}opts(){if(this._storeOptionsAsProperties){let $={},J=this.options.length;for(let X=0;X<J;X++){let z=this.options[X].attributeName();$[z]=z===this._versionOptionName?this._version:this[z]}return $}return this._optionValues}optsWithGlobals(){return this._getCommandAndAncestors().reduce(($,J)=>Object.assign($,J.opts()),{})}error($,J){if(this._outputConfiguration.outputError(`${$}
`,this._outputConfiguration.writeErr),typeof this._showHelpAfterError==="string")this._outputConfiguration.writeErr(`${this._showHelpAfterError}
`);else if(this._showHelpAfterError)this._outputConfiguration.writeErr(`
`),this.outputHelp({error:!0});let X=J||{},z=X.exitCode||1,Z=X.code||"commander.error";this._exit(z,Z,$)}_parseOptionsEnv(){this.options.forEach(($)=>{if($.envVar&&$.envVar in L.env){let J=$.attributeName();if(this.getOptionValue(J)===void 0||["default","config","env"].includes(this.getOptionValueSource(J)))if($.required||$.optional)this.emit(`optionEnv:${$.name()}`,L.env[$.envVar]);else this.emit(`optionEnv:${$.name()}`)}})}_parseOptionsImplied(){let $=new L$(this.options),J=(X)=>{return this.getOptionValue(X)!==void 0&&!["default","implied"].includes(this.getOptionValueSource(X))};this.options.filter((X)=>X.implied!==void 0&&J(X.attributeName())&&$.valueFromOption(this.getOptionValue(X.attributeName()),X)).forEach((X)=>{Object.keys(X.implied).filter((z)=>!J(z)).forEach((z)=>{this.setOptionValueWithSource(z,X.implied[z],"implied")})})}missingArgument($){let J=`error: missing required argument '${$}'`;this.error(J,{code:"commander.missingArgument"})}optionMissingArgument($){let J=`error: option '${$.flags}' argument missing`;this.error(J,{code:"commander.optionMissingArgument"})}missingMandatoryOptionValue($){let J=`error: required option '${$.flags}' not specified`;this.error(J,{code:"commander.missingMandatoryOptionValue"})}_conflictingOption($,J){let X=(Y)=>{let G=Y.attributeName(),Q=this.getOptionValue(G),P=this.options.find((f)=>f.negate&&G===f.attributeName()),W=this.options.find((f)=>!f.negate&&G===f.attributeName());if(P&&(P.presetArg===void 0&&Q===!1||P.presetArg!==void 0&&Q===P.presetArg))return P;return W||Y},z=(Y)=>{let G=X(Y),Q=G.attributeName();if(this.getOptionValueSource(Q)==="env")return`environment variable '${G.envVar}'`;return`option '${G.flags}'`},Z=`error: ${z($)} cannot be used with ${z(J)}`;this.error(Z,{code:"commander.conflictingOption"})}unknownOption($){if(this._allowUnknownOption)return;let J="";if($.startsWith("--")&&this._showSuggestionAfterError){let z=[],Z=this;do{let Y=Z.createHelp().visibleOptions(Z).filter((G)=>G.long).map((G)=>G.long);z=z.concat(Y),Z=Z.parent}while(Z&&!Z._enablePositionalOptions);J=g0($,z)}let X=`error: unknown option '${$}'${J}`;this.error(X,{code:"commander.unknownOption"})}_excessArguments($){if(this._allowExcessArguments)return;let J=this.registeredArguments.length,X=J===1?"":"s",Z=`error: too many arguments${this.parent?` for '${this.name()}'`:""}. Expected ${J} argument${X} but got ${$.length}.`;this.error(Z,{code:"commander.excessArguments"})}unknownCommand(){let $=this.args[0],J="";if(this._showSuggestionAfterError){let z=[];this.createHelp().visibleCommands(this).forEach((Z)=>{if(z.push(Z.name()),Z.alias())z.push(Z.alias())}),J=g0($,z)}let X=`error: unknown command '${$}'${J}`;this.error(X,{code:"commander.unknownCommand"})}version($,J,X){if($===void 0)return this._version;this._version=$,J=J||"-V, --version",X=X||"output the version number";let z=this.createOption(J,X);return this._versionOptionName=z.attributeName(),this._registerOption(z),this.on("option:"+z.name(),()=>{this._outputConfiguration.writeOut(`${$}
`),this._exit(0,"commander.version",$)}),this}description($,J){if($===void 0&&J===void 0)return this._description;if(this._description=$,J)this._argsDescription=J;return this}summary($){if($===void 0)return this._summary;return this._summary=$,this}alias($){if($===void 0)return this._aliases[0];let J=this;if(this.commands.length!==0&&this.commands[this.commands.length-1]._executableHandler)J=this.commands[this.commands.length-1];if($===J._name)throw Error("Command alias can't be the same as its name");let X=this.parent?._findCommand($);if(X){let z=[X.name()].concat(X.aliases()).join("|");throw Error(`cannot add alias '${$}' to command '${this.name()}' as already have command '${z}'`)}return J._aliases.push($),this}aliases($){if($===void 0)return this._aliases;return $.forEach((J)=>this.alias(J)),this}usage($){if($===void 0){if(this._usage)return this._usage;let J=this.registeredArguments.map((X)=>{return K$(X)});return[].concat(this.options.length||this._helpOption!==null?"[options]":[],this.commands.length?"[command]":[],this.registeredArguments.length?J:[]).join(" ")}return this._usage=$,this}name($){if($===void 0)return this._name;return this._name=$,this}nameFromFilename($){return this._name=V.basename($,V.extname($)),this}executableDir($){if($===void 0)return this._executableDir;return this._executableDir=$,this}helpInformation($){let J=this.createHelp();if(J.helpWidth===void 0)J.helpWidth=$&&$.error?this._outputConfiguration.getErrHelpWidth():this._outputConfiguration.getOutHelpWidth();return J.formatHelp(this,J)}_getHelpContext($){$=$||{};let J={error:!!$.error},X;if(J.error)X=(z)=>this._outputConfiguration.writeErr(z);else X=(z)=>this._outputConfiguration.writeOut(z);return J.write=$.write||X,J.command=this,J}outputHelp($){let J;if(typeof $==="function")J=$,$=void 0;let X=this._getHelpContext($);this._getCommandAndAncestors().reverse().forEach((Z)=>Z.emit("beforeAllHelp",X)),this.emit("beforeHelp",X);let z=this.helpInformation(X);if(J){if(z=J(z),typeof z!=="string"&&!Buffer.isBuffer(z))throw Error("outputHelp callback must return a string or a Buffer")}if(X.write(z),this._getHelpOption()?.long)this.emit(this._getHelpOption().long);this.emit("afterHelp",X),this._getCommandAndAncestors().forEach((Z)=>Z.emit("afterAllHelp",X))}helpOption($,J){if(typeof $==="boolean"){if($)this._helpOption=this._helpOption??void 0;else this._helpOption=null;return this}return $=$??"-h, --help",J=J??"display help for command",this._helpOption=this.createOption($,J),this}_getHelpOption(){if(this._helpOption===void 0)this.helpOption(void 0,void 0);return this._helpOption}addHelpOption($){return this._helpOption=$,this}help($){this.outputHelp($);let J=L.exitCode||0;if(J===0&&$&&typeof $!=="function"&&$.error)J=1;this._exit(J,"commander.help","(outputHelp)")}addHelpText($,J){let X=["beforeAll","before","after","afterAll"];if(!X.includes($))throw Error(`Unexpected value for position to addHelpText.
Expecting one of '${X.join("', '")}'`);let z=`${$}Help`;return this.on(z,(Z)=>{let Y;if(typeof J==="function")Y=J({error:Z.error,command:Z.command});else Y=J;if(Y)Z.write(`${Y}
`)}),this}_outputHelpIfRequested($){let J=this._getHelpOption();if(J&&$.find((z)=>J.is(z)))this.outputHelp(),this._exit(0,"commander.helpDisplayed","(outputHelp)")}}function l0($){return $.map((J)=>{if(!J.startsWith("--inspect"))return J;let X,z="127.0.0.1",Z="9229",Y;if((Y=J.match(/^(--inspect(-brk)?)$/))!==null)X=Y[1];else if((Y=J.match(/^(--inspect(-brk|-port)?)=([^:]+)$/))!==null)if(X=Y[1],/^\d+$/.test(Y[3]))Z=Y[3];else z=Y[3];else if((Y=J.match(/^(--inspect(-brk|-port)?)=([^:]+):(\d+)$/))!==null)X=Y[1],z=Y[3],Z=Y[4];if(X&&Z!=="0")return`${X}=${z}:${parseInt(Z)+1}`;return J})}R$.Command=S0});var d0=q((j$)=>{var{Argument:s0}=m(),{Command:L0}=c0(),{CommanderError:T$,InvalidArgumentError:m0}=v(),{Help:E$}=f0(),{Option:i0}=B0();j$.program=new L0;j$.createCommand=($)=>new L0($);j$.createOption=($,J)=>new i0($,J);j$.createArgument=($,J)=>new s0($,J);j$.Command=L0;j$.Option=i0;j$.Argument=s0;j$.Help=E$;j$.CommanderError=T$;j$.InvalidArgumentError=m0;j$.InvalidOptionArgumentError=m0});var p0=s1(d0(),1),{program:E,createCommand:R2,createArgument:_2,createOption:T2,CommanderError:E2,InvalidArgumentError:j2,InvalidOptionArgumentError:M2,Command:V2,Argument:I2,Option:F2,Help:H2}=p0.default;import{existsSync as r0,mkdirSync as b$}from"node:fs";import{homedir as C$}from"node:os";import{join as n0}from"node:path";var w$=typeof globalThis.Bun<"u",i;if(w$)i=($)=>{let{Database:J}=D("bun:sqlite"),X=new J($);return{exec:(z)=>X.exec(z),prepare:(z)=>{let Z=X.prepare(z);return{run:(...Y)=>Z.run(...Y),get:(...Y)=>Z.get(...Y),all:(...Y)=>Z.all(...Y)}},close:()=>X.close()}};else i=($)=>{let X=new(D("better-sqlite3"))($);return{exec:(z)=>X.exec(z),prepare:(z)=>{let Z=X.prepare(z);return{run:(...Y)=>Z.run(...Y),get:(...Y)=>Z.get(...Y),all:(...Y)=>Z.all(...Y)}},close:()=>X.close()}};var k$=null;function R0(){return k$||process.env.WASP_DATA_DIR||n0(C$(),".wasp")}function t0(){return n0(R0(),"wasp.db")}var A=null;function _0(){return R0()}function w(){return r0(t0())}function T(){if(!A){let $=R0(),J=t0();if(!r0($))b$($,{recursive:!0});A=i(J),A.exec("PRAGMA journal_mode = WAL")}return A}function d(){T().exec(`
    CREATE TABLE IF NOT EXISTS contacts (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      identifier TEXT NOT NULL,
      platform TEXT NOT NULL DEFAULT 'whatsapp',
      name TEXT,
      trust TEXT NOT NULL DEFAULT 'trusted',
      added_at TEXT NOT NULL DEFAULT (datetime('now')),
      notes TEXT,
      UNIQUE(identifier, platform)
    );

    CREATE TABLE IF NOT EXISTS audit_log (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      timestamp TEXT NOT NULL DEFAULT (datetime('now')),
      identifier TEXT NOT NULL,
      platform TEXT NOT NULL,
      decision TEXT NOT NULL,
      reason TEXT
    );

    CREATE TABLE IF NOT EXISTS quarantine (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      identifier TEXT NOT NULL,
      platform TEXT NOT NULL DEFAULT 'whatsapp',
      message_preview TEXT,
      full_message TEXT,
      timestamp TEXT NOT NULL DEFAULT (datetime('now')),
      reviewed INTEGER NOT NULL DEFAULT 0
    );

    CREATE INDEX IF NOT EXISTS idx_contacts_identifier ON contacts(identifier);
    CREATE INDEX IF NOT EXISTS idx_audit_timestamp ON audit_log(timestamp);
    CREATE INDEX IF NOT EXISTS idx_quarantine_identifier ON quarantine(identifier);
    CREATE INDEX IF NOT EXISTS idx_quarantine_reviewed ON quarantine(reviewed);
  `)}function T0(){if(A)A.close(),A=null}function E0($){return{id:$.id,identifier:$.identifier,platform:$.platform,name:$.name,trust:$.trust,addedAt:$.added_at,notes:$.notes}}function x($,J="whatsapp",X="trusted",z,Z){let Y=T();Y.prepare(`
    INSERT INTO contacts (identifier, platform, trust, name, notes)
    VALUES (?, ?, ?, ?, ?)
    ON CONFLICT(identifier, platform) DO UPDATE SET
      trust = excluded.trust,
      name = COALESCE(excluded.name, contacts.name),
      notes = COALESCE(excluded.notes, contacts.notes)
  `).run($,J,X,z||null,Z||null);let Q=Y.prepare("SELECT * FROM contacts WHERE identifier = ? AND platform = ?").get($,J);if(!Q)throw Error(`Failed to retrieve contact after insert: ${$}`);return E0(Q)}function p($,J="whatsapp"){return T().prepare("DELETE FROM contacts WHERE identifier = ? AND platform = ?").run($,J).changes>0}function v$($,J="whatsapp"){let Z=T().prepare("SELECT * FROM contacts WHERE identifier = ? AND platform = ?").get($,J);if(!Z)return null;return E0(Z)}function r($,J){let X=T(),z="SELECT * FROM contacts WHERE 1=1",Z=[];if($)z+=" AND platform = ?",Z.push($);if(J)z+=" AND trust = ?",Z.push(J);return z+=" ORDER BY added_at DESC",X.prepare(z).all(...Z).map(E0)}function n($,J="whatsapp"){let X=v$($,J);if(!X)return{allowed:!1,trust:null,name:null,reason:"Contact not in whitelist"};if(X.trust==="limited")return{allowed:!0,trust:"limited",name:X.name,reason:"Limited trust - agent may view but should not act"};return{allowed:!0,trust:X.trust,name:X.name,reason:"Contact is trusted"}}function o0($,J){let X=x($,J.platform||"whatsapp",J.trust||"trusted",J.name,J.notes);if(console.log("Contact added/updated:"),console.log(`  Identifier: ${X.identifier}`),console.log(`  Platform:   ${X.platform}`),console.log(`  Trust:      ${X.trust}`),X.name)console.log(`  Name:       ${X.name}`);if(X.notes)console.log(`  Notes:      ${X.notes}`)}function h$($){return{id:$.id,timestamp:$.timestamp,identifier:$.identifier,platform:$.platform,decision:$.decision,reason:$.reason||""}}function t($,J,X,z){T().prepare(`
    INSERT INTO audit_log (identifier, platform, decision, reason)
    VALUES (?, ?, ?, ?)
  `).run($,J,X,z)}function b($){let J=T(),X="SELECT * FROM audit_log WHERE 1=1",z=[];if($.decision)X+=" AND decision = ?",z.push($.decision);if($.since)X+=" AND timestamp >= ?",z.push($.since);if(X+=" ORDER BY timestamp DESC",$.limit)X+=" LIMIT ?",z.push($.limit);return J.prepare(X).all(...z).map(h$)}function a0($,J){let X=J.platform||"whatsapp",z=n($,X),Z=!z.allowed?"deny":z.trust==="limited"?"limited":"allow";if(t($,X,Z,z.reason),J.json){console.log(JSON.stringify(z)),process.exit(z.allowed?0:1);return}if(J.quiet){process.exit(z.allowed?0:1);return}if(z.allowed){let Y=z.name?` (${z.name})`:"";if(console.log(`ALLOWED: ${$}${Y}`),console.log(`  Trust level: ${z.trust}`),z.trust==="limited")console.log("  Note: Limited trust - agent may view but should not act")}else console.log(`DENIED: ${$}`),console.log(`  Reason: ${z.reason}`);process.exit(z.allowed?0:1)}function e0($=!1){if(w()&&!$){console.log("wasp is already initialized."),console.log(`Data directory: ${_0()}`),console.log("Use --force to reinitialize.");return}d(),console.log("wasp initialized successfully."),console.log(`Data directory: ${_0()}`),console.log(""),console.log("Next steps:"),console.log('  wasp add "+440123456789" --name "Your Name" --trust sovereign'),console.log("  wasp list"),console.log("  wasp serve")}function $1($){let J=r($.platform,$.trust);if(J.length===0){console.log("No contacts found.");return}if($.json){console.log(JSON.stringify(J,null,2));return}console.log(`Found ${J.length} contact(s):
`);for(let X of J){let z=X.name?` (${X.name})`:"";if(console.log(`  ${X.identifier}${z}`),console.log(`    Platform: ${X.platform} | Trust: ${X.trust}`),X.notes)console.log(`    Notes: ${X.notes}`);console.log("")}}function J1($){let J=b({limit:$.limit||50,decision:$.denied?"deny":void 0});if(J.length===0){console.log("No audit entries found.");return}if($.json){console.log(JSON.stringify(J,null,2));return}console.log(`Last ${J.length} audit entries:
`);for(let X of J){let z=X.decision==="allow"?"✓":X.decision==="limited"?"~":"✗";console.log(`  ${z} ${X.timestamp} | ${X.identifier} (${X.platform})`),console.log(`    Decision: ${X.decision} - ${X.reason}`),console.log("")}}function X1($,J="whatsapp"){if(p($,J))console.log(`Removed: ${$} (${J})`);else console.log(`Not found: ${$} (${J})`)}function z1($){return{id:$.id,identifier:$.identifier,platform:$.platform,messagePreview:$.message_preview||"",fullMessage:$.full_message||"",timestamp:$.timestamp,reviewed:!!$.reviewed}}function Z1($=50){return T().prepare(`
    SELECT * FROM quarantine 
    WHERE reviewed = 0 
    ORDER BY timestamp DESC 
    LIMIT ?
  `).all($).map(z1)}function u$($,J="whatsapp"){return T().prepare(`
    SELECT * FROM quarantine 
    WHERE identifier = ? AND platform = ? AND reviewed = 0
    ORDER BY timestamp ASC
  `).all($,J).map(z1)}function Y1($,J="whatsapp"){let X=u$($,J);if(X.length>0)T().prepare(`
      UPDATE quarantine SET reviewed = 1 
      WHERE identifier = ? AND platform = ?
    `).run($,J);return X}function G1($,J="whatsapp"){return T().prepare(`
    DELETE FROM quarantine WHERE identifier = ? AND platform = ?
  `).run($,J).changes}async function Q1($){if($.approve){let Z=Y1($.approve);if(Z.length>0)x(Z[0].identifier,Z[0].platform,"trusted"),console.log(`✓ Approved ${Z[0].identifier}`),console.log(`  Released ${Z.length} quarantined message(s)`);else console.log(`No quarantined messages for: ${$.approve}`);return}if($.deny){let Z=G1($.deny);if(Z>0)x($.deny,"whatsapp","limited"),console.log(`✗ Denied ${$.deny}`),console.log(`  Deleted ${Z} message(s)`);else console.log(`No quarantined messages for: ${$.deny}`);return}let J=Z1(50);if(J.length===0){console.log(`
\uD83D\uDC1D Quarantine is empty - no messages awaiting review
`);return}let X=new Map;for(let Z of J){let Y=`${Z.identifier}|${Z.platform}`;if(!X.has(Y))X.set(Y,[]);X.get(Y)?.push(Z)}console.log(`
\uD83D\uDC1D Quarantine Review
`),console.log(`${X.size} sender(s), ${J.length} message(s) awaiting review
`),console.log(`${"─".repeat(60)}
`);let z=1;for(let[Z,Y]of X){let[G,Q]=Z.split("|");console.log(`${z}. ${G} (${Q})`),console.log(`   ${Y.length} message(s)`),console.log("");let P=Y[0];console.log(`   First: "${P.messagePreview}"`),console.log(`   Time:  ${P.timestamp}`),console.log(""),z++}if(console.log("─".repeat(60)),console.log(`
Actions:`),console.log("  wasp review --approve <identifier>   Add to trusted, release messages"),console.log("  wasp review --deny <identifier>      Block sender, delete messages"),console.log(""),$.interactive)console.log("Interactive mode not yet implemented."),console.log("Use --approve or --deny flags for now.")}function P1($=20){let J=b({limit:100,decision:"deny"}),X=new Set,z=[];for(let Z of J){let Y=`${Z.identifier}|${Z.platform}`;if(!X.has(Y)){if(X.add(Y),z.push(Z),z.length>=$)break}}if(z.length===0){console.log(`
No blocked contacts in recent history.
`);return}console.log(`
\uD83D\uDC1D Recently Blocked Contacts
`),console.log(`${"─".repeat(60)}
`);for(let Z of z)console.log(`  ${Z.identifier} (${Z.platform})`),console.log(`    Last seen: ${Z.timestamp}`),console.log(`    Reason: ${Z.reason}`),console.log("");console.log("─".repeat(60)),console.log(`
To allow a contact:`),console.log('  wasp add "<identifier>" --trust trusted'),console.log("")}var j0=($,J,X)=>{return(z,Z)=>{let Y=-1;return G(0);async function G(Q){if(Q<=Y)throw Error("next() called multiple times");Y=Q;let P,W=!1,f;if($[Q])f=$[Q][0][0],z.req.routeIndex=Q;else f=Q===$.length&&Z||void 0;if(f)try{P=await f(z,()=>G(Q+1))}catch(B){if(B instanceof Error&&J)z.error=B,P=await J(B,z),W=!0;else throw B}else if(z.finalized===!1&&X)P=await X(z);if(P&&(z.finalized===!1||W))z.res=P;return z}}};var W1=Symbol();var f1=async($,J=Object.create(null))=>{let{all:X=!1,dot:z=!1}=J,Y=($ instanceof o?$.raw.headers:$.headers).get("Content-Type");if(Y?.startsWith("multipart/form-data")||Y?.startsWith("application/x-www-form-urlencoded"))return g$($,{all:X,dot:z});return{}};async function g$($,J){let X=await $.formData();if(X)return l$(X,J);return{}}function l$($,J){let X=Object.create(null);if($.forEach((z,Z)=>{if(!(J.all||Z.endsWith("[]")))X[Z]=z;else c$(X,Z,z)}),J.dot)Object.entries(X).forEach(([z,Z])=>{if(z.includes("."))s$(X,z,Z),delete X[z]});return X}var c$=($,J,X)=>{if($[J]!==void 0)if(Array.isArray($[J]))$[J].push(X);else $[J]=[$[J],X];else if(!J.endsWith("[]"))$[J]=X;else $[J]=[X]},s$=($,J,X)=>{let z=$,Z=J.split(".");Z.forEach((Y,G)=>{if(G===Z.length-1)z[Y]=X;else{if(!z[Y]||typeof z[Y]!=="object"||Array.isArray(z[Y])||z[Y]instanceof File)z[Y]=Object.create(null);z=z[Y]}})};var V0=($)=>{let J=$.split("/");if(J[0]==="")J.shift();return J},B1=($)=>{let{groups:J,path:X}=m$($),z=V0(X);return i$(z,J)},m$=($)=>{let J=[];return $=$.replace(/\{[^}]+\}/g,(X,z)=>{let Z=`@${z}`;return J.push([Z,X]),Z}),{groups:J,path:$}},i$=($,J)=>{for(let X=J.length-1;X>=0;X--){let[z]=J[X];for(let Z=$.length-1;Z>=0;Z--)if($[Z].includes(z)){$[Z]=$[Z].replace(z,J[X][1]);break}}return $},a={},N1=($,J)=>{if($==="*")return"*";let X=$.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(X){let z=`${$}#${J}`;if(!a[z])if(X[2])a[z]=J&&J[0]!==":"&&J[0]!=="*"?[z,X[1],new RegExp(`^${X[2]}(?=/${J})`)]:[$,X[1],new RegExp(`^${X[2]}$`)];else a[z]=[$,X[1],!0];return a[z]}return null},e=($,J)=>{try{return J($)}catch{return $.replace(/(?:%[0-9A-Fa-f]{2})+/g,(X)=>{try{return J(X)}catch{return X}})}},d$=($)=>e($,decodeURI),I0=($)=>{let J=$.url,X=J.indexOf("/",J.indexOf(":")+4),z=X;for(;z<J.length;z++){let Z=J.charCodeAt(z);if(Z===37){let Y=J.indexOf("?",z),G=J.slice(X,Y===-1?void 0:Y);return d$(G.includes("%25")?G.replace(/%25/g,"%2525"):G)}else if(Z===63)break}return J.slice(X,z)};var U1=($)=>{let J=I0($);return J.length>1&&J.at(-1)==="/"?J.slice(0,-1):J},O=($,J,...X)=>{if(X.length)J=O(J,...X);return`${$?.[0]==="/"?"":"/"}${$}${J==="/"?"":`${$?.at(-1)==="/"?"":"/"}${J?.[0]==="/"?J.slice(1):J}`}`},$0=($)=>{if($.charCodeAt($.length-1)!==63||!$.includes(":"))return null;let J=$.split("/"),X=[],z="";return J.forEach((Z)=>{if(Z!==""&&!/\:/.test(Z))z+="/"+Z;else if(/\:/.test(Z))if(/\?/.test(Z)){if(X.length===0&&z==="")X.push("/");else X.push(z);let Y=Z.replace("?","");z+="/"+Y,X.push(z)}else z+="/"+Z}),X.filter((Z,Y,G)=>G.indexOf(Z)===Y)},M0=($)=>{if(!/[%+]/.test($))return $;if($.indexOf("+")!==-1)$=$.replace(/\+/g," ");return $.indexOf("%")!==-1?e($,F0):$},K1=($,J,X)=>{let z;if(!X&&J&&!/[%+]/.test(J)){let G=$.indexOf("?",8);if(G===-1)return;if(!$.startsWith(J,G+1))G=$.indexOf(`&${J}`,G+1);while(G!==-1){let Q=$.charCodeAt(G+J.length+1);if(Q===61){let P=G+J.length+2,W=$.indexOf("&",P);return M0($.slice(P,W===-1?void 0:W))}else if(Q==38||isNaN(Q))return"";G=$.indexOf(`&${J}`,G+1)}if(z=/[%+]/.test($),!z)return}let Z={};z??=/[%+]/.test($);let Y=$.indexOf("?",8);while(Y!==-1){let G=$.indexOf("&",Y+1),Q=$.indexOf("=",Y);if(Q>G&&G!==-1)Q=-1;let P=$.slice(Y+1,Q===-1?G===-1?void 0:G:Q);if(z)P=M0(P);if(Y=G,P==="")continue;let W;if(Q===-1)W="";else if(W=$.slice(Q+1,G===-1?void 0:G),z)W=M0(W);if(X){if(!(Z[P]&&Array.isArray(Z[P])))Z[P]=[];Z[P].push(W)}else Z[P]??=W}return J?Z[J]:Z},S1=K1,L1=($,J)=>{return K1($,J,!0)},F0=decodeURIComponent;var R1=($)=>e($,F0),o=class{raw;#$;#J;routeIndex=0;path;bodyCache={};constructor($,J="/",X=[[]]){this.raw=$,this.path=J,this.#J=X,this.#$={}}param($){return $?this.#X($):this.#Y()}#X($){let J=this.#J[0][this.routeIndex][1][$],X=this.#Z(J);return X&&/\%/.test(X)?R1(X):X}#Y(){let $={},J=Object.keys(this.#J[0][this.routeIndex][1]);for(let X of J){let z=this.#Z(this.#J[0][this.routeIndex][1][X]);if(z!==void 0)$[X]=/\%/.test(z)?R1(z):z}return $}#Z($){return this.#J[1]?this.#J[1][$]:$}query($){return S1(this.url,$)}queries($){return L1(this.url,$)}header($){if($)return this.raw.headers.get($)??void 0;let J={};return this.raw.headers.forEach((X,z)=>{J[z]=X}),J}async parseBody($){return this.bodyCache.parsedBody??=await f1(this,$)}#z=($)=>{let{bodyCache:J,raw:X}=this,z=J[$];if(z)return z;let Z=Object.keys(J)[0];if(Z)return J[Z].then((Y)=>{if(Z==="json")Y=JSON.stringify(Y);return new Response(Y)[$]()});return J[$]=X[$]()};json(){return this.#z("text").then(($)=>JSON.parse($))}text(){return this.#z("text")}arrayBuffer(){return this.#z("arrayBuffer")}blob(){return this.#z("blob")}formData(){return this.#z("formData")}addValidatedData($,J){this.#$[$]=J}valid($){return this.#$[$]}get url(){return this.raw.url}get method(){return this.raw.method}get[W1](){return this.#J}get matchedRoutes(){return this.#J[0].map(([[,$]])=>$)}get routePath(){return this.#J[0].map(([[,$]])=>$)[this.routeIndex].path}};var _1={Stringify:1,BeforeStream:2,Stream:3},p$=($,J)=>{let X=new String($);return X.isEscaped=!0,X.callbacks=J,X};var H0=async($,J,X,z,Z)=>{if(typeof $==="object"&&!($ instanceof String)){if(!($ instanceof Promise))$=$.toString();if($ instanceof Promise)$=await $}let Y=$.callbacks;if(!Y?.length)return Promise.resolve($);if(Z)Z[0]+=$;else Z=[$];let G=Promise.all(Y.map((Q)=>Q({phase:J,buffer:Z,context:z}))).then((Q)=>Promise.all(Q.filter(Boolean).map((P)=>H0(P,J,!1,z,Z))).then(()=>Z[0]));if(X)return p$(await G,Y);else return G};var r$="text/plain; charset=UTF-8",q0=($,J)=>{return{"Content-Type":$,...J}},T1=class{#$;#J;env={};#X;finalized=!1;error;#Y;#Z;#z;#f;#P;#W;#Q;#B;#N;constructor($,J){if(this.#$=$,J)this.#Z=J.executionCtx,this.env=J.env,this.#W=J.notFoundHandler,this.#N=J.path,this.#B=J.matchResult}get req(){return this.#J??=new o(this.#$,this.#N,this.#B),this.#J}get event(){if(this.#Z&&"respondWith"in this.#Z)return this.#Z;else throw Error("This context has no FetchEvent")}get executionCtx(){if(this.#Z)return this.#Z;else throw Error("This context has no ExecutionContext")}get res(){return this.#z||=new Response(null,{headers:this.#Q??=new Headers})}set res($){if(this.#z&&$){$=new Response($.body,$);for(let[J,X]of this.#z.headers.entries()){if(J==="content-type")continue;if(J==="set-cookie"){let z=this.#z.headers.getSetCookie();$.headers.delete("set-cookie");for(let Z of z)$.headers.append("set-cookie",Z)}else $.headers.set(J,X)}}this.#z=$,this.finalized=!0}render=(...$)=>{return this.#P??=(J)=>this.html(J),this.#P(...$)};setLayout=($)=>this.#f=$;getLayout=()=>this.#f;setRenderer=($)=>{this.#P=$};header=($,J,X)=>{if(this.finalized)this.#z=new Response(this.#z.body,this.#z);let z=this.#z?this.#z.headers:this.#Q??=new Headers;if(J===void 0)z.delete($);else if(X?.append)z.append($,J);else z.set($,J)};status=($)=>{this.#Y=$};set=($,J)=>{this.#X??=new Map,this.#X.set($,J)};get=($)=>{return this.#X?this.#X.get($):void 0};get var(){if(!this.#X)return{};return Object.fromEntries(this.#X)}#G($,J,X){let z=this.#z?new Headers(this.#z.headers):this.#Q??new Headers;if(typeof J==="object"&&"headers"in J){let Y=J.headers instanceof Headers?J.headers:new Headers(J.headers);for(let[G,Q]of Y)if(G.toLowerCase()==="set-cookie")z.append(G,Q);else z.set(G,Q)}if(X)for(let[Y,G]of Object.entries(X))if(typeof G==="string")z.set(Y,G);else{z.delete(Y);for(let Q of G)z.append(Y,Q)}let Z=typeof J==="number"?J:J?.status??this.#Y;return new Response($,{status:Z,headers:z})}newResponse=(...$)=>this.#G(...$);body=($,J,X)=>this.#G($,J,X);text=($,J,X)=>{return!this.#Q&&!this.#Y&&!J&&!X&&!this.finalized?new Response($):this.#G($,J,q0(r$,X))};json=($,J,X)=>{return this.#G(JSON.stringify($),J,q0("application/json",X))};html=($,J,X)=>{let z=(Z)=>this.#G(Z,J,q0("text/html; charset=UTF-8",X));return typeof $==="object"?H0($,_1.Stringify,!1,{}).then(z):z($)};redirect=($,J)=>{let X=String($);return this.header("Location",!/[^\x00-\xFF]/.test(X)?X:encodeURI(X)),this.newResponse(null,J??302)};notFound=()=>{return this.#W??=()=>new Response,this.#W(this)}};var K="ALL",E1="all",j1=["get","post","put","delete","options","patch"],J0="Can not add a route since the matcher is already built.",X0=class extends Error{};var M1="__COMPOSED_HANDLER";var n$=($)=>{return $.text("404 Not Found",404)},V1=($,J)=>{if("getResponse"in $){let X=$.getResponse();return J.newResponse(X.body,X)}return console.error($),J.text("Internal Server Error",500)},I1=class ${get;post;put;delete;options;patch;all;on;use;router;getPath;_basePath="/";#$="/";routes=[];constructor(J={}){[...j1,E1].forEach((Y)=>{this[Y]=(G,...Q)=>{if(typeof G==="string")this.#$=G;else this.#Y(Y,this.#$,G);return Q.forEach((P)=>{this.#Y(Y,this.#$,P)}),this}}),this.on=(Y,G,...Q)=>{for(let P of[G].flat()){this.#$=P;for(let W of[Y].flat())Q.map((f)=>{this.#Y(W.toUpperCase(),this.#$,f)})}return this},this.use=(Y,...G)=>{if(typeof Y==="string")this.#$=Y;else this.#$="*",G.unshift(Y);return G.forEach((Q)=>{this.#Y(K,this.#$,Q)}),this};let{strict:z,...Z}=J;Object.assign(this,Z),this.getPath=z??!0?J.getPath??I0:U1}#J(){let J=new $({router:this.router,getPath:this.getPath});return J.errorHandler=this.errorHandler,J.#X=this.#X,J.routes=this.routes,J}#X=n$;errorHandler=V1;route(J,X){let z=this.basePath(J);return X.routes.map((Z)=>{let Y;if(X.errorHandler===V1)Y=Z.handler;else Y=async(G,Q)=>(await j0([],X.errorHandler)(G,()=>Z.handler(G,Q))).res,Y[M1]=Z.handler;z.#Y(Z.method,Z.path,Y)}),this}basePath(J){let X=this.#J();return X._basePath=O(this._basePath,J),X}onError=(J)=>{return this.errorHandler=J,this};notFound=(J)=>{return this.#X=J,this};mount(J,X,z){let Z,Y;if(z)if(typeof z==="function")Y=z;else if(Y=z.optionHandler,z.replaceRequest===!1)Z=(P)=>P;else Z=z.replaceRequest;let G=Y?(P)=>{let W=Y(P);return Array.isArray(W)?W:[W]}:(P)=>{let W=void 0;try{W=P.executionCtx}catch{}return[P.env,W]};Z||=(()=>{let P=O(this._basePath,J),W=P==="/"?0:P.length;return(f)=>{let B=new URL(f.url);return B.pathname=B.pathname.slice(W)||"/",new Request(B,f)}})();let Q=async(P,W)=>{let f=await X(Z(P.req.raw),...G(P));if(f)return f;await W()};return this.#Y(K,O(J,"*"),Q),this}#Y(J,X,z){J=J.toUpperCase(),X=O(this._basePath,X);let Z={basePath:this._basePath,path:X,method:J,handler:z};this.router.add(J,X,[z,Z]),this.routes.push(Z)}#Z(J,X){if(J instanceof Error)return this.errorHandler(J,X);throw J}#z(J,X,z,Z){if(Z==="HEAD")return(async()=>new Response(null,await this.#z(J,X,z,"GET")))();let Y=this.getPath(J,{env:z}),G=this.router.match(Z,Y),Q=new T1(J,{path:Y,matchResult:G,env:z,executionCtx:X,notFoundHandler:this.#X});if(G[0].length===1){let W;try{W=G[0][0][0][0](Q,async()=>{Q.res=await this.#X(Q)})}catch(f){return this.#Z(f,Q)}return W instanceof Promise?W.then((f)=>f||(Q.finalized?Q.res:this.#X(Q))).catch((f)=>this.#Z(f,Q)):W??this.#X(Q)}let P=j0(G[0],this.errorHandler,this.#X);return(async()=>{try{let W=await P(Q);if(!W.finalized)throw Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return W.res}catch(W){return this.#Z(W,Q)}})()}fetch=(J,...X)=>{return this.#z(J,X[1],X[0],J.method)};request=(J,X,z,Z)=>{if(J instanceof Request)return this.fetch(X?new Request(J,X):J,z,Z);return J=J.toString(),this.fetch(new Request(/^https?:\/\//.test(J)?J:`http://localhost${O("/",J)}`,X),z,Z)};fire=()=>{addEventListener("fetch",(J)=>{J.respondWith(this.#z(J.request,J,void 0,J.request.method))})}};var h=[];function z0($,J){let X=this.buildAllMatchers(),z=(Z,Y)=>{let G=X[Z]||X[K],Q=G[2][Y];if(Q)return Q;let P=Y.match(G[0]);if(!P)return[[],h];let W=P.indexOf("",1);return[G[1][W],P]};return this.match=z,z($,J)}var Z0="[^/]+",u=".*",g="(?:|/.*)",y=Symbol(),t$=new Set(".\\+*[^]$()");function o$($,J){if($.length===1)return J.length===1?$<J?-1:1:-1;if(J.length===1)return 1;if($===u||$===g)return 1;else if(J===u||J===g)return-1;if($===Z0)return 1;else if(J===Z0)return-1;return $.length===J.length?$<J?-1:1:J.length-$.length}var F1=class ${#$;#J;#X=Object.create(null);insert(J,X,z,Z,Y){if(J.length===0){if(this.#$!==void 0)throw y;if(Y)return;this.#$=X;return}let[G,...Q]=J,P=G==="*"?Q.length===0?["","",u]:["","",Z0]:G==="/*"?["","",g]:G.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/),W;if(P){let f=P[1],B=P[2]||Z0;if(f&&P[2]){if(B===".*")throw y;if(B=B.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(B))throw y}if(W=this.#X[B],!W){if(Object.keys(this.#X).some((U)=>U!==u&&U!==g))throw y;if(Y)return;if(W=this.#X[B]=new $,f!=="")W.#J=Z.varIndex++}if(!Y&&f!=="")z.push([f,W.#J])}else if(W=this.#X[G],!W){if(Object.keys(this.#X).some((f)=>f.length>1&&f!==u&&f!==g))throw y;if(Y)return;W=this.#X[G]=new $}W.insert(Q,X,z,Z,Y)}buildRegExpStr(){let X=Object.keys(this.#X).sort(o$).map((z)=>{let Z=this.#X[z];return(typeof Z.#J==="number"?`(${z})@${Z.#J}`:t$.has(z)?`\\${z}`:z)+Z.buildRegExpStr()});if(typeof this.#$==="number")X.unshift(`#${this.#$}`);if(X.length===0)return"";if(X.length===1)return X[0];return"(?:"+X.join("|")+")"}};var H1=class{#$={varIndex:0};#J=new F1;insert($,J,X){let z=[],Z=[];for(let G=0;;){let Q=!1;if($=$.replace(/\{[^}]+\}/g,(P)=>{let W=`@\\${G}`;return Z[G]=[W,P],G++,Q=!0,W}),!Q)break}let Y=$.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let G=Z.length-1;G>=0;G--){let[Q]=Z[G];for(let P=Y.length-1;P>=0;P--)if(Y[P].indexOf(Q)!==-1){Y[P]=Y[P].replace(Q,Z[G][1]);break}}return this.#J.insert(Y,J,z,this.#$,X),z}buildRegExp(){let $=this.#J.buildRegExpStr();if($==="")return[/^$/,[],[]];let J=0,X=[],z=[];return $=$.replace(/#(\d+)|@(\d+)|\.\*\$/g,(Z,Y,G)=>{if(Y!==void 0)return X[++J]=Number(Y),"$()";if(G!==void 0)return z[Number(G)]=++J,"";return""}),[new RegExp(`^${$}`),X,z]}};var a$=[/^$/,[],Object.create(null)],q1=Object.create(null);function D1($){return q1[$]??=new RegExp($==="*"?"":`^${$.replace(/\/\*$|([.\\+*[^\]$()])/g,(J,X)=>X?`\\${X}`:"(?:|/.*)")}$`)}function e$(){q1=Object.create(null)}function $2($){let J=new H1,X=[];if($.length===0)return a$;let z=$.map((W)=>[!/\*|\/:/.test(W[0]),...W]).sort(([W,f],[B,U])=>W?1:B?-1:f.length-U.length),Z=Object.create(null);for(let W=0,f=-1,B=z.length;W<B;W++){let[U,N,R]=z[W];if(U)Z[N]=[R.map(([_])=>[_,Object.create(null)]),h];else f++;let S;try{S=J.insert(N,f,U)}catch(_){throw _===y?new X0(N):_}if(U)continue;X[f]=R.map(([_,I])=>{let c=Object.create(null);I-=1;for(;I>=0;I--){let[s,j]=S[I];c[s]=j}return[_,c]})}let[Y,G,Q]=J.buildRegExp();for(let W=0,f=X.length;W<f;W++)for(let B=0,U=X[W].length;B<U;B++){let N=X[W][B]?.[1];if(!N)continue;let R=Object.keys(N);for(let S=0,_=R.length;S<_;S++)N[R[S]]=Q[N[R[S]]]}let P=[];for(let W in G)P[W]=X[G[W]];return[Y,P,Z]}function C($,J){if(!$)return;for(let X of Object.keys($).sort((z,Z)=>Z.length-z.length))if(D1(X).test(J))return[...$[X]];return}var Y0=class{name="RegExpRouter";#$;#J;constructor(){this.#$={[K]:Object.create(null)},this.#J={[K]:Object.create(null)}}add($,J,X){let z=this.#$,Z=this.#J;if(!z||!Z)throw Error(J0);if(!z[$])[z,Z].forEach((Q)=>{Q[$]=Object.create(null),Object.keys(Q[K]).forEach((P)=>{Q[$][P]=[...Q[K][P]]})});if(J==="/*")J="*";let Y=(J.match(/\/:/g)||[]).length;if(/\*$/.test(J)){let Q=D1(J);if($===K)Object.keys(z).forEach((P)=>{z[P][J]||=C(z[P],J)||C(z[K],J)||[]});else z[$][J]||=C(z[$],J)||C(z[K],J)||[];Object.keys(z).forEach((P)=>{if($===K||$===P)Object.keys(z[P]).forEach((W)=>{Q.test(W)&&z[P][W].push([X,Y])})}),Object.keys(Z).forEach((P)=>{if($===K||$===P)Object.keys(Z[P]).forEach((W)=>Q.test(W)&&Z[P][W].push([X,Y]))});return}let G=$0(J)||[J];for(let Q=0,P=G.length;Q<P;Q++){let W=G[Q];Object.keys(Z).forEach((f)=>{if($===K||$===f)Z[f][W]||=[...C(z[f],W)||C(z[K],W)||[]],Z[f][W].push([X,Y-P+Q+1])})}}match=z0;buildAllMatchers(){let $=Object.create(null);return Object.keys(this.#J).concat(Object.keys(this.#$)).forEach((J)=>{$[J]||=this.#X(J)}),this.#$=this.#J=void 0,e$(),$}#X($){let J=[],X=$===K;if([this.#$,this.#J].forEach((z)=>{let Z=z[$]?Object.keys(z[$]).map((Y)=>[Y,z[$][Y]]):[];if(Z.length!==0)X||=!0,J.push(...Z);else if($!==K)J.push(...Object.keys(z[K]).map((Y)=>[Y,z[K][Y]]))}),!X)return null;else return $2(J)}};var J2=class{name="PreparedRegExpRouter";#$;#J;constructor($,J){this.#$=$,this.#J=J}#X($,J){let X=this.#$[$];X[1].forEach((z)=>z&&z.push(J)),Object.values(X[2]).forEach((z)=>z[0].push(J))}#Y($,J,X,z,Z){let Y=this.#$[$];if(!Z)Y[2][J][0].push([X,{}]);else z.forEach((G)=>{if(typeof G==="number")Y[1][G].push([X,Z]);else Y[2][G||J][0].push([X,Z])})}add($,J,X){if(!this.#$[$]){let Z=this.#$[K],Y={};for(let G in Z[2])Y[G]=[Z[2][G][0].slice(),h];this.#$[$]=[Z[0],Z[1].map((G)=>Array.isArray(G)?G.slice():0),Y]}if(J==="/*"||J==="*"){let Z=[X,{}];if($===K)for(let Y in this.#$)this.#X(Y,Z);else this.#X($,Z);return}let z=this.#J[J];if(!z)throw Error(`Path ${J} is not registered`);for(let[Z,Y]of z)if($===K)for(let G in this.#$)this.#Y(G,J,X,Z,Y);else this.#Y($,J,X,Z,Y)}buildAllMatchers(){return this.#$}match=z0};var D0=class{name="SmartRouter";#$=[];#J=[];constructor($){this.#$=$.routers}add($,J,X){if(!this.#J)throw Error(J0);this.#J.push([$,J,X])}match($,J){if(!this.#J)throw Error("Fatal error");let X=this.#$,z=this.#J,Z=X.length,Y=0,G;for(;Y<Z;Y++){let Q=X[Y];try{for(let P=0,W=z.length;P<W;P++)Q.add(...z[P]);G=Q.match($,J)}catch(P){if(P instanceof X0)continue;throw P}this.match=Q.match.bind(Q),this.#$=[Q],this.#J=void 0;break}if(Y===Z)throw Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,G}get activeRouter(){if(this.#J||this.#$.length!==1)throw Error("No active router has been determined yet.");return this.#$[0]}};var l=Object.create(null),A1=class ${#$;#J;#X;#Y=0;#Z=l;constructor(J,X,z){if(this.#J=z||Object.create(null),this.#$=[],J&&X){let Z=Object.create(null);Z[J]={handler:X,possibleKeys:[],score:0},this.#$=[Z]}this.#X=[]}insert(J,X,z){this.#Y=++this.#Y;let Z=this,Y=B1(X),G=[];for(let Q=0,P=Y.length;Q<P;Q++){let W=Y[Q],f=Y[Q+1],B=N1(W,f),U=Array.isArray(B)?B[0]:W;if(U in Z.#J){if(Z=Z.#J[U],B)G.push(B[1]);continue}if(Z.#J[U]=new $,B)Z.#X.push(B),G.push(B[1]);Z=Z.#J[U]}return Z.#$.push({[J]:{handler:z,possibleKeys:G.filter((Q,P,W)=>W.indexOf(Q)===P),score:this.#Y}}),Z}#z(J,X,z,Z){let Y=[];for(let G=0,Q=J.#$.length;G<Q;G++){let P=J.#$[G],W=P[X]||P[K],f={};if(W!==void 0){if(W.params=Object.create(null),Y.push(W),z!==l||Z&&Z!==l)for(let B=0,U=W.possibleKeys.length;B<U;B++){let N=W.possibleKeys[B],R=f[W.score];W.params[N]=Z?.[N]&&!R?Z[N]:z[N]??Z?.[N],f[W.score]=!0}}}return Y}search(J,X){let z=[];this.#Z=l;let Y=[this],G=V0(X),Q=[];for(let P=0,W=G.length;P<W;P++){let f=G[P],B=P===W-1,U=[];for(let N=0,R=Y.length;N<R;N++){let S=Y[N],_=S.#J[f];if(_)if(_.#Z=S.#Z,B){if(_.#J["*"])z.push(...this.#z(_.#J["*"],J,S.#Z));z.push(...this.#z(_,J,S.#Z))}else U.push(_);for(let I=0,c=S.#X.length;I<c;I++){let s=S.#X[I],j=S.#Z===l?{}:{...S.#Z};if(s==="*"){let F=S.#J["*"];if(F)z.push(...this.#z(F,J,S.#Z)),F.#Z=j,U.push(F);continue}let[k1,O0,k]=s;if(!f&&!(k instanceof RegExp))continue;let M=S.#J[k1],v1=G.slice(P).join("/");if(k instanceof RegExp){let F=k.exec(v1);if(F){if(j[O0]=F[0],z.push(...this.#z(M,J,S.#Z,j)),Object.keys(M.#J).length){M.#Z=j;let h1=F[0].match(/\//)?.length??0;(Q[h1]||=[]).push(M)}continue}}if(k===!0||k.test(f))if(j[O0]=f,B){if(z.push(...this.#z(M,J,j,S.#Z)),M.#J["*"])z.push(...this.#z(M.#J["*"],J,j,S.#Z))}else M.#Z=j,U.push(M)}}Y=U.concat(Q.shift()??[])}if(z.length>1)z.sort((P,W)=>{return P.score-W.score});return[z.map(({handler:P,params:W})=>[P,W])]}};var A0=class{name="TrieRouter";#$;constructor(){this.#$=new A1}add($,J,X){let z=$0(J);if(z){for(let Z=0,Y=z.length;Z<Y;Z++)this.#$.insert($,z[Z],X);return}this.#$.insert($,J,X)}match($,J){return this.#$.search($,J)}};var x0=class extends I1{constructor($={}){super($);this.router=$.router??new D0({routers:[new Y0,new A0]})}};var G0=new Map,X2={windowMs:60000,maxRequests:100};function x1($,J=X2){let X=Date.now(),z=G0.get($);if(!z||X-z.windowStart>=J.windowMs)return G0.set($,{count:1,windowStart:X}),{allowed:!0,remaining:J.maxRequests-1,resetMs:J.windowMs};if(z.count>=J.maxRequests)return{allowed:!1,remaining:0,resetMs:J.windowMs-(X-z.windowStart)};return z.count++,{allowed:!0,remaining:J.maxRequests-z.count,resetMs:J.windowMs-(X-z.windowStart)}}function z2($=300000){let J=Date.now(),X=0;for(let[z,Z]of G0.entries())if(J-Z.windowStart>$)G0.delete(z),X++;return X}var Z2=setInterval(()=>{z2()},300000);Z2.unref();var O1={windowMs:60000,maxRequests:100},y1=["whatsapp","telegram","email","discord","slack","signal","webchat"];function w1($){let J=$.req.header("x-forwarded-for");if(J){let X=J.split(",")[0]?.trim();if(X)return X}return $.req.header("x-real-ip")||"unknown"}function Q0($){return y1.includes($)}function P0($,J){let X=process.env.WASP_API_TOKEN,z=w1($);if(!X){if(!(z==="127.0.0.1"||z==="::1"||z==="localhost"||z==="unknown"))return $.json({error:"Admin endpoints require authentication. Set WASP_API_TOKEN or access from localhost."},401);return J()}let Z=$.req.header("authorization");if(!Z)return $.json({error:"Authorization header required"},401);if((Z.startsWith("Bearer ")?Z.slice(7):Z)!==X)return $.json({error:"Invalid API token"},401);return J()}function Y2(){let $=new x0;return $.get("/health",(J)=>{return J.json({ok:!0,timestamp:new Date().toISOString()})}),$.post("/check",async(J)=>{let X=w1(J),z=x1(`check:${X}`,O1);if(J.header("X-RateLimit-Limit",String(O1.maxRequests)),J.header("X-RateLimit-Remaining",String(z.remaining)),J.header("X-RateLimit-Reset",String(Math.ceil(z.resetMs/1000))),!z.allowed)return J.json({error:"Rate limit exceeded",retryAfterMs:z.resetMs},429);let Z;try{Z=await J.req.json()}catch{return J.json({error:"Invalid JSON body"},400)}let{identifier:Y,platform:G="whatsapp"}=Z;if(!Y)return J.json({error:"identifier is required"},400);if(!Q0(G))return J.json({error:`Invalid platform. Must be one of: ${y1.join(", ")}`},400);let Q=n(Y,G),P=!Q.allowed?"deny":Q.trust==="limited"?"limited":"allow";return t(Y,G,P,Q.reason),J.json(Q)}),$.get("/contacts",P0,(J)=>{let X=J.req.query("platform"),z=J.req.query("trust");if(X&&!Q0(X))return J.json({error:"Invalid platform filter"},400);let Z=r(X,z);return J.json({contacts:Z})}),$.post("/contacts",P0,async(J)=>{let X;try{X=await J.req.json()}catch{return J.json({error:"Invalid JSON body"},400)}let{identifier:z,platform:Z="whatsapp",trust:Y="trusted",name:G,notes:Q}=X;if(!z)return J.json({error:"identifier is required"},400);if(!Q0(Z))return J.json({error:"Invalid platform"},400);let P=["sovereign","trusted","limited"];if(!P.includes(Y))return J.json({error:`Invalid trust level. Must be one of: ${P.join(", ")}`},400);let W=x(z,Z,Y,G,Q);return J.json({contact:W})}),$.delete("/contacts/:identifier",P0,(J)=>{let X=J.req.param("identifier");if(!X)return J.json({error:"Missing identifier"},400);let z=decodeURIComponent(X),Z=J.req.query("platform")||"whatsapp";if(!Q0(Z))return J.json({error:"Invalid platform"},400);let Y=p(z,Z);return J.json({removed:Y})}),$.get("/audit",P0,(J)=>{let X=J.req.query("limit"),z=X?parseInt(X,10):100;if(Number.isNaN(z)||z<1||z>1000)return J.json({error:"limit must be between 1 and 1000"},400);let Z=J.req.query("decision");if(Z&&!["allow","deny","limited"].includes(Z))return J.json({error:"Invalid decision filter"},400);let Y=b({limit:z,decision:Z});return J.json({entries:Y})}),$}function b1($=3847){let J=Y2(),X=!!process.env.WASP_API_TOKEN;if(console.log(`wasp server listening on http://localhost:${$}`),console.log(""),console.log("Public endpoints:"),console.log("  POST /check         - Check if contact is allowed"),console.log("  GET  /health        - Health check"),console.log(""),console.log("Admin endpoints (protected):"),console.log("  GET  /contacts      - List contacts"),console.log("  POST /contacts      - Add contact"),console.log("  DELETE /contacts/:id - Remove contact"),console.log("  GET  /audit         - View audit log"),console.log(""),X)console.log("Authentication: API token required (WASP_API_TOKEN is set)");else console.log("Authentication: Localhost-only (set WASP_API_TOKEN for remote access)");Bun.serve({port:$,fetch:J.fetch})}function C1($){if(!w())console.error("wasp is not initialized. Run `wasp init` first."),process.exit(1);let J=$.port||3847;b1(J)}var G2="0.2.3";E.name("wasp").description("Security whitelist layer for Moltbot and agentic systems").version(G2);E.command("init").description("Initialize wasp database").option("-f, --force","Reinitialize even if already initialized").action(($)=>{e0($.force)});E.command("add <identifier>").description("Add a contact to the whitelist").option("-p, --platform <platform>","Platform (whatsapp, telegram, email, discord, slack, signal)","whatsapp").option("-t, --trust <level>","Trust level (sovereign, trusted, limited)","trusted").option("-n, --name <name>","Contact name").option("--notes <notes>","Notes about this contact").action(($,J)=>{H(),o0($,J)});E.command("remove <identifier>").description("Remove a contact from the whitelist").option("-p, --platform <platform>","Platform","whatsapp").action(($,J)=>{H(),X1($,J.platform)});E.command("list").description("List all contacts").option("-p, --platform <platform>","Filter by platform").option("-t, --trust <level>","Filter by trust level").option("-j, --json","Output as JSON").action(($)=>{H(),$1($)});E.command("check <identifier>").description("Check if a contact is allowed").option("-p, --platform <platform>","Platform","whatsapp").option("-j, --json","Output as JSON").option("-q, --quiet","Exit code only, no output").action(($,J)=>{H(),a0($,J)});E.command("log").description("View audit log").option("-l, --limit <number>","Number of entries to show","50").option("-d, --denied","Show only denied entries").option("-j, --json","Output as JSON").action(($)=>{H(),J1({...$,limit:parseInt($.limit,10)})});E.command("serve").description("Start HTTP server for Moltbot integration").option("-p, --port <number>","Port to listen on","3847").action(($)=>{H(),C1({port:parseInt($.port,10)})});E.command("review").description("Review quarantined messages and first-time contacts").option("--approve <identifier>","Approve sender and release messages").option("--deny <identifier>","Block sender and delete messages").option("-i, --interactive","Interactive review mode").action(async($)=>{H(),await Q1($)});E.command("blocked").description("Show recently blocked contacts").option("-l, --limit <number>","Number to show","20").action(($)=>{H(),P1(parseInt($.limit,10))});function H(){if(!w())console.log("wasp is not initialized. Initializing now..."),d(),console.log("")}E.parseAsync().then(()=>{T0(),process.exit(0)}).catch(($)=>{console.error($),T0(),process.exit(1)});
