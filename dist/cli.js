#!/usr/bin/env node
// @bun
var D0=Object.create;var{getPrototypeOf:A0,defineProperty:Df,getOwnPropertyNames:y0}=Object;var x0=Object.prototype.hasOwnProperty;var b0=(f,$,z)=>{z=f!=null?D0(A0(f)):{};let P=$||!f||!f.__esModule?Df(z,"default",{value:f,enumerable:!0}):z;for(let J of y0(f))if(!x0.call(P,J))Df(P,J,{get:()=>f[J],enumerable:!0});return P};var q=(f,$)=>()=>($||f(($={exports:{}}).exports,$),$.exports);var k=import.meta.require;var v=q((O0)=>{class Yf extends Error{constructor(f,$,z){super(z);Error.captureStackTrace(this,this.constructor),this.name=this.constructor.name,this.code=$,this.exitCode=f,this.nestedError=void 0}}class Af extends Yf{constructor(f){super(1,"commander.invalidArgument",f);Error.captureStackTrace(this,this.constructor),this.name=this.constructor.name}}O0.CommanderError=Yf;O0.InvalidArgumentError=Af});var s=q((l0)=>{var{InvalidArgumentError:v0}=v();class yf{constructor(f,$){switch(this.description=$||"",this.variadic=!1,this.parseArg=void 0,this.defaultValue=void 0,this.defaultValueDescription=void 0,this.argChoices=void 0,f[0]){case"<":this.required=!0,this._name=f.slice(1,-1);break;case"[":this.required=!1,this._name=f.slice(1,-1);break;default:this.required=!0,this._name=f;break}if(this._name.length>3&&this._name.slice(-3)==="...")this.variadic=!0,this._name=this._name.slice(0,-3)}name(){return this._name}_concatValue(f,$){if($===this.defaultValue||!Array.isArray($))return[f];return $.concat(f)}default(f,$){return this.defaultValue=f,this.defaultValueDescription=$,this}argParser(f){return this.parseArg=f,this}choices(f){return this.argChoices=f.slice(),this.parseArg=($,z)=>{if(!this.argChoices.includes($))throw new v0(`Allowed choices are ${this.argChoices.join(", ")}.`);if(this.variadic)return this._concatValue($,z);return $},this}argRequired(){return this.required=!0,this}argOptional(){return this.required=!1,this}}function u0(f){let $=f.name()+(f.variadic===!0?"...":"");return f.required?"<"+$+">":"["+$+"]"}l0.Argument=yf;l0.humanReadableArgName=u0});var Lf=q((i0)=>{var{humanReadableArgName:g0}=s();class xf{constructor(){this.helpWidth=void 0,this.sortSubcommands=!1,this.sortOptions=!1,this.showGlobalOptions=!1}visibleCommands(f){let $=f.commands.filter((P)=>!P._hidden),z=f._getHelpCommand();if(z&&!z._hidden)$.push(z);if(this.sortSubcommands)$.sort((P,J)=>{return P.name().localeCompare(J.name())});return $}compareOptions(f,$){let z=(P)=>{return P.short?P.short.replace(/^-/,""):P.long.replace(/^--/,"")};return z(f).localeCompare(z($))}visibleOptions(f){let $=f.options.filter((P)=>!P.hidden),z=f._getHelpOption();if(z&&!z.hidden){let P=z.short&&f._findOption(z.short),J=z.long&&f._findOption(z.long);if(!P&&!J)$.push(z);else if(z.long&&!J)$.push(f.createOption(z.long,z.description));else if(z.short&&!P)$.push(f.createOption(z.short,z.description))}if(this.sortOptions)$.sort(this.compareOptions);return $}visibleGlobalOptions(f){if(!this.showGlobalOptions)return[];let $=[];for(let z=f.parent;z;z=z.parent){let P=z.options.filter((J)=>!J.hidden);$.push(...P)}if(this.sortOptions)$.sort(this.compareOptions);return $}visibleArguments(f){if(f._argsDescription)f.registeredArguments.forEach(($)=>{$.description=$.description||f._argsDescription[$.name()]||""});if(f.registeredArguments.find(($)=>$.description))return f.registeredArguments;return[]}subcommandTerm(f){let $=f.registeredArguments.map((z)=>g0(z)).join(" ");return f._name+(f._aliases[0]?"|"+f._aliases[0]:"")+(f.options.length?" [options]":"")+($?" "+$:"")}optionTerm(f){return f.flags}argumentTerm(f){return f.name()}longestSubcommandTermLength(f,$){return $.visibleCommands(f).reduce((z,P)=>{return Math.max(z,$.subcommandTerm(P).length)},0)}longestOptionTermLength(f,$){return $.visibleOptions(f).reduce((z,P)=>{return Math.max(z,$.optionTerm(P).length)},0)}longestGlobalOptionTermLength(f,$){return $.visibleGlobalOptions(f).reduce((z,P)=>{return Math.max(z,$.optionTerm(P).length)},0)}longestArgumentTermLength(f,$){return $.visibleArguments(f).reduce((z,P)=>{return Math.max(z,$.argumentTerm(P).length)},0)}commandUsage(f){let $=f._name;if(f._aliases[0])$=$+"|"+f._aliases[0];let z="";for(let P=f.parent;P;P=P.parent)z=P.name()+" "+z;return z+$+" "+f.usage()}commandDescription(f){return f.description()}subcommandDescription(f){return f.summary()||f.description()}optionDescription(f){let $=[];if(f.argChoices)$.push(`choices: ${f.argChoices.map((z)=>JSON.stringify(z)).join(", ")}`);if(f.defaultValue!==void 0){if(f.required||f.optional||f.isBoolean()&&typeof f.defaultValue==="boolean")$.push(`default: ${f.defaultValueDescription||JSON.stringify(f.defaultValue)}`)}if(f.presetArg!==void 0&&f.optional)$.push(`preset: ${JSON.stringify(f.presetArg)}`);if(f.envVar!==void 0)$.push(`env: ${f.envVar}`);if($.length>0)return`${f.description} (${$.join(", ")})`;return f.description}argumentDescription(f){let $=[];if(f.argChoices)$.push(`choices: ${f.argChoices.map((z)=>JSON.stringify(z)).join(", ")}`);if(f.defaultValue!==void 0)$.push(`default: ${f.defaultValueDescription||JSON.stringify(f.defaultValue)}`);if($.length>0){let z=`(${$.join(", ")})`;if(f.description)return`${f.description} ${z}`;return z}return f.description}formatHelp(f,$){let z=$.padWidth(f,$),P=$.helpWidth||80,J=2,Q=2;function G(S,j){if(j){let T=`${S.padEnd(z+2)}${j}`;return $.wrap(T,P-2,z+2)}return S}function X(S){return S.join(`
`).replace(/^/gm," ".repeat(2))}let Z=[`Usage: ${$.commandUsage(f)}`,""],Y=$.commandDescription(f);if(Y.length>0)Z=Z.concat([$.wrap(Y,P,0),""]);let L=$.visibleArguments(f).map((S)=>{return G($.argumentTerm(S),$.argumentDescription(S))});if(L.length>0)Z=Z.concat(["Arguments:",X(L),""]);let N=$.visibleOptions(f).map((S)=>{return G($.optionTerm(S),$.optionDescription(S))});if(N.length>0)Z=Z.concat(["Options:",X(N),""]);if(this.showGlobalOptions){let S=$.visibleGlobalOptions(f).map((j)=>{return G($.optionTerm(j),$.optionDescription(j))});if(S.length>0)Z=Z.concat(["Global Options:",X(S),""])}let W=$.visibleCommands(f).map((S)=>{return G($.subcommandTerm(S),$.subcommandDescription(S))});if(W.length>0)Z=Z.concat(["Commands:",X(W),""]);return Z.join(`
`)}padWidth(f,$){return Math.max($.longestOptionTermLength(f,$),$.longestGlobalOptionTermLength(f,$),$.longestSubcommandTermLength(f,$),$.longestArgumentTermLength(f,$))}wrap(f,$,z,P=40){let Q=new RegExp(`[\\n][${" \\f\\t\\v\xA0\u1680\u2000-\u200A\u202F\u205F\u3000\uFEFF"}]+`);if(f.match(Q))return f;let G=$-z;if(G<P)return f;let X=f.slice(0,z),Z=f.slice(z).replace(`\r
`,`
`),Y=" ".repeat(z),N=`\\s${"\u200B"}`,W=new RegExp(`
|.{1,${G-1}}([${N}]|$)|[^${N}]+?([${N}]|$)`,"g"),S=Z.match(W)||[];return X+S.map((j,T)=>{if(j===`
`)return"";return(T>0?Y:"")+j.trimEnd()}).join(`
`)}}i0.Help=xf});var Nf=q((d0)=>{var{InvalidArgumentError:m0}=v();class bf{constructor(f,$){this.flags=f,this.description=$||"",this.required=f.includes("<"),this.optional=f.includes("["),this.variadic=/\w\.\.\.[>\]]$/.test(f),this.mandatory=!1;let z=r0(f);if(this.short=z.shortFlag,this.long=z.longFlag,this.negate=!1,this.long)this.negate=this.long.startsWith("--no-");this.defaultValue=void 0,this.defaultValueDescription=void 0,this.presetArg=void 0,this.envVar=void 0,this.parseArg=void 0,this.hidden=!1,this.argChoices=void 0,this.conflictsWith=[],this.implied=void 0}default(f,$){return this.defaultValue=f,this.defaultValueDescription=$,this}preset(f){return this.presetArg=f,this}conflicts(f){return this.conflictsWith=this.conflictsWith.concat(f),this}implies(f){let $=f;if(typeof f==="string")$={[f]:!0};return this.implied=Object.assign(this.implied||{},$),this}env(f){return this.envVar=f,this}argParser(f){return this.parseArg=f,this}makeOptionMandatory(f=!0){return this.mandatory=!!f,this}hideHelp(f=!0){return this.hidden=!!f,this}_concatValue(f,$){if($===this.defaultValue||!Array.isArray($))return[f];return $.concat(f)}choices(f){return this.argChoices=f.slice(),this.parseArg=($,z)=>{if(!this.argChoices.includes($))throw new m0(`Allowed choices are ${this.argChoices.join(", ")}.`);if(this.variadic)return this._concatValue($,z);return $},this}name(){if(this.long)return this.long.replace(/^--/,"");return this.short.replace(/^-/,"")}attributeName(){return t0(this.name().replace(/^no-/,""))}is(f){return this.short===f||this.long===f}isBoolean(){return!this.required&&!this.optional&&!this.negate}}class Of{constructor(f){this.positiveOptions=new Map,this.negativeOptions=new Map,this.dualOptions=new Set,f.forEach(($)=>{if($.negate)this.negativeOptions.set($.attributeName(),$);else this.positiveOptions.set($.attributeName(),$)}),this.negativeOptions.forEach(($,z)=>{if(this.positiveOptions.has(z))this.dualOptions.add(z)})}valueFromOption(f,$){let z=$.attributeName();if(!this.dualOptions.has(z))return!0;let P=this.negativeOptions.get(z).presetArg,J=P!==void 0?P:!1;return $.negate===(J===f)}}function t0(f){return f.split("-").reduce(($,z)=>{return $+z[0].toUpperCase()+z.slice(1)})}function r0(f){let $,z,P=f.split(/[ |,]+/);if(P.length>1&&!/^[[<]/.test(P[1]))$=P.shift();if(z=P.shift(),!$&&/^-[^-]$/.test(z))$=z,z=void 0;return{shortFlag:$,longFlag:z}}d0.Option=bf;d0.DualOptions=Of});var Cf=q((e0)=>{function o0(f,$){if(Math.abs(f.length-$.length)>3)return Math.max(f.length,$.length);let z=[];for(let P=0;P<=f.length;P++)z[P]=[P];for(let P=0;P<=$.length;P++)z[0][P]=P;for(let P=1;P<=$.length;P++)for(let J=1;J<=f.length;J++){let Q=1;if(f[J-1]===$[P-1])Q=0;else Q=1;if(z[J][P]=Math.min(z[J-1][P]+1,z[J][P-1]+1,z[J-1][P-1]+Q),J>1&&P>1&&f[J-1]===$[P-2]&&f[J-2]===$[P-1])z[J][P]=Math.min(z[J][P],z[J-2][P-2]+1)}return z[f.length][$.length]}function a0(f,$){if(!$||$.length===0)return"";$=Array.from(new Set($));let z=f.startsWith("--");if(z)f=f.slice(2),$=$.map((G)=>G.slice(2));let P=[],J=3,Q=0.4;if($.forEach((G)=>{if(G.length<=1)return;let X=o0(f,G),Z=Math.max(f.length,G.length);if((Z-X)/Z>Q){if(X<J)J=X,P=[G];else if(X===J)P.push(G)}}),P.sort((G,X)=>G.localeCompare(X)),z)P=P.map((G)=>`--${G}`);if(P.length>1)return`
(Did you mean one of ${P.join(", ")}?)`;if(P.length===1)return`
(Did you mean ${P[0]}?)`;return""}e0.suggestSimilar=a0});var lf=q((G1)=>{var $1=k("events").EventEmitter,Sf=k("child_process"),V=k("path"),Wf=k("fs"),U=k("process"),{Argument:z1,humanReadableArgName:P1}=s(),{CommanderError:If}=v(),{Help:J1}=Lf(),{Option:kf,DualOptions:Q1}=Nf(),{suggestSimilar:vf}=Cf();class Tf extends $1{constructor(f){super();this.commands=[],this.options=[],this.parent=null,this._allowUnknownOption=!1,this._allowExcessArguments=!0,this.registeredArguments=[],this._args=this.registeredArguments,this.args=[],this.rawArgs=[],this.processedArgs=[],this._scriptPath=null,this._name=f||"",this._optionValues={},this._optionValueSources={},this._storeOptionsAsProperties=!1,this._actionHandler=null,this._executableHandler=!1,this._executableFile=null,this._executableDir=null,this._defaultCommandName=null,this._exitCallback=null,this._aliases=[],this._combineFlagAndOptionalValue=!0,this._description="",this._summary="",this._argsDescription=void 0,this._enablePositionalOptions=!1,this._passThroughOptions=!1,this._lifeCycleHooks={},this._showHelpAfterError=!1,this._showSuggestionAfterError=!0,this._outputConfiguration={writeOut:($)=>U.stdout.write($),writeErr:($)=>U.stderr.write($),getOutHelpWidth:()=>U.stdout.isTTY?U.stdout.columns:void 0,getErrHelpWidth:()=>U.stderr.isTTY?U.stderr.columns:void 0,outputError:($,z)=>z($)},this._hidden=!1,this._helpOption=void 0,this._addImplicitHelpCommand=void 0,this._helpCommand=void 0,this._helpConfiguration={}}copyInheritedSettings(f){return this._outputConfiguration=f._outputConfiguration,this._helpOption=f._helpOption,this._helpCommand=f._helpCommand,this._helpConfiguration=f._helpConfiguration,this._exitCallback=f._exitCallback,this._storeOptionsAsProperties=f._storeOptionsAsProperties,this._combineFlagAndOptionalValue=f._combineFlagAndOptionalValue,this._allowExcessArguments=f._allowExcessArguments,this._enablePositionalOptions=f._enablePositionalOptions,this._showHelpAfterError=f._showHelpAfterError,this._showSuggestionAfterError=f._showSuggestionAfterError,this}_getCommandAndAncestors(){let f=[];for(let $=this;$;$=$.parent)f.push($);return f}command(f,$,z){let P=$,J=z;if(typeof P==="object"&&P!==null)J=P,P=null;J=J||{};let[,Q,G]=f.match(/([^ ]+) *(.*)/),X=this.createCommand(Q);if(P)X.description(P),X._executableHandler=!0;if(J.isDefault)this._defaultCommandName=X._name;if(X._hidden=!!(J.noHelp||J.hidden),X._executableFile=J.executableFile||null,G)X.arguments(G);if(this._registerCommand(X),X.parent=this,X.copyInheritedSettings(this),P)return this;return X}createCommand(f){return new Tf(f)}createHelp(){return Object.assign(new J1,this.configureHelp())}configureHelp(f){if(f===void 0)return this._helpConfiguration;return this._helpConfiguration=f,this}configureOutput(f){if(f===void 0)return this._outputConfiguration;return Object.assign(this._outputConfiguration,f),this}showHelpAfterError(f=!0){if(typeof f!=="string")f=!!f;return this._showHelpAfterError=f,this}showSuggestionAfterError(f=!0){return this._showSuggestionAfterError=!!f,this}addCommand(f,$){if(!f._name)throw Error(`Command passed to .addCommand() must have a name
- specify the name in Command constructor or using .name()`);if($=$||{},$.isDefault)this._defaultCommandName=f._name;if($.noHelp||$.hidden)f._hidden=!0;return this._registerCommand(f),f.parent=this,f._checkForBrokenPassThrough(),this}createArgument(f,$){return new z1(f,$)}argument(f,$,z,P){let J=this.createArgument(f,$);if(typeof z==="function")J.default(P).argParser(z);else J.default(z);return this.addArgument(J),this}arguments(f){return f.trim().split(/ +/).forEach(($)=>{this.argument($)}),this}addArgument(f){let $=this.registeredArguments.slice(-1)[0];if($&&$.variadic)throw Error(`only the last argument can be variadic '${$.name()}'`);if(f.required&&f.defaultValue!==void 0&&f.parseArg===void 0)throw Error(`a default value for a required argument is never used: '${f.name()}'`);return this.registeredArguments.push(f),this}helpCommand(f,$){if(typeof f==="boolean")return this._addImplicitHelpCommand=f,this;f=f??"help [command]";let[,z,P]=f.match(/([^ ]+) *(.*)/),J=$??"display help for command",Q=this.createCommand(z);if(Q.helpOption(!1),P)Q.arguments(P);if(J)Q.description(J);return this._addImplicitHelpCommand=!0,this._helpCommand=Q,this}addHelpCommand(f,$){if(typeof f!=="object")return this.helpCommand(f,$),this;return this._addImplicitHelpCommand=!0,this._helpCommand=f,this}_getHelpCommand(){if(this._addImplicitHelpCommand??(this.commands.length&&!this._actionHandler&&!this._findCommand("help"))){if(this._helpCommand===void 0)this.helpCommand(void 0,void 0);return this._helpCommand}return null}hook(f,$){let z=["preSubcommand","preAction","postAction"];if(!z.includes(f))throw Error(`Unexpected value for event passed to hook : '${f}'.
Expecting one of '${z.join("', '")}'`);if(this._lifeCycleHooks[f])this._lifeCycleHooks[f].push($);else this._lifeCycleHooks[f]=[$];return this}exitOverride(f){if(f)this._exitCallback=f;else this._exitCallback=($)=>{if($.code!=="commander.executeSubCommandAsync")throw $};return this}_exit(f,$,z){if(this._exitCallback)this._exitCallback(new If(f,$,z));U.exit(f)}action(f){let $=(z)=>{let P=this.registeredArguments.length,J=z.slice(0,P);if(this._storeOptionsAsProperties)J[P]=this;else J[P]=this.opts();return J.push(this),f.apply(this,J)};return this._actionHandler=$,this}createOption(f,$){return new kf(f,$)}_callParseArg(f,$,z,P){try{return f.parseArg($,z)}catch(J){if(J.code==="commander.invalidArgument"){let Q=`${P} ${J.message}`;this.error(Q,{exitCode:J.exitCode,code:J.code})}throw J}}_registerOption(f){let $=f.short&&this._findOption(f.short)||f.long&&this._findOption(f.long);if($){let z=f.long&&this._findOption(f.long)?f.long:f.short;throw Error(`Cannot add option '${f.flags}'${this._name&&` to command '${this._name}'`} due to conflicting flag '${z}'
-  already used by option '${$.flags}'`)}this.options.push(f)}_registerCommand(f){let $=(P)=>{return[P.name()].concat(P.aliases())},z=$(f).find((P)=>this._findCommand(P));if(z){let P=$(this._findCommand(z)).join("|"),J=$(f).join("|");throw Error(`cannot add command '${J}' as already have command '${P}'`)}this.commands.push(f)}addOption(f){this._registerOption(f);let $=f.name(),z=f.attributeName();if(f.negate){let J=f.long.replace(/^--no-/,"--");if(!this._findOption(J))this.setOptionValueWithSource(z,f.defaultValue===void 0?!0:f.defaultValue,"default")}else if(f.defaultValue!==void 0)this.setOptionValueWithSource(z,f.defaultValue,"default");let P=(J,Q,G)=>{if(J==null&&f.presetArg!==void 0)J=f.presetArg;let X=this.getOptionValue(z);if(J!==null&&f.parseArg)J=this._callParseArg(f,J,X,Q);else if(J!==null&&f.variadic)J=f._concatValue(J,X);if(J==null)if(f.negate)J=!1;else if(f.isBoolean()||f.optional)J=!0;else J="";this.setOptionValueWithSource(z,J,G)};if(this.on("option:"+$,(J)=>{let Q=`error: option '${f.flags}' argument '${J}' is invalid.`;P(J,Q,"cli")}),f.envVar)this.on("optionEnv:"+$,(J)=>{let Q=`error: option '${f.flags}' value '${J}' from env '${f.envVar}' is invalid.`;P(J,Q,"env")});return this}_optionEx(f,$,z,P,J){if(typeof $==="object"&&$ instanceof kf)throw Error("To add an Option object use addOption() instead of option() or requiredOption()");let Q=this.createOption($,z);if(Q.makeOptionMandatory(!!f.mandatory),typeof P==="function")Q.default(J).argParser(P);else if(P instanceof RegExp){let G=P;P=(X,Z)=>{let Y=G.exec(X);return Y?Y[0]:Z},Q.default(J).argParser(P)}else Q.default(P);return this.addOption(Q)}option(f,$,z,P){return this._optionEx({},f,$,z,P)}requiredOption(f,$,z,P){return this._optionEx({mandatory:!0},f,$,z,P)}combineFlagAndOptionalValue(f=!0){return this._combineFlagAndOptionalValue=!!f,this}allowUnknownOption(f=!0){return this._allowUnknownOption=!!f,this}allowExcessArguments(f=!0){return this._allowExcessArguments=!!f,this}enablePositionalOptions(f=!0){return this._enablePositionalOptions=!!f,this}passThroughOptions(f=!0){return this._passThroughOptions=!!f,this._checkForBrokenPassThrough(),this}_checkForBrokenPassThrough(){if(this.parent&&this._passThroughOptions&&!this.parent._enablePositionalOptions)throw Error(`passThroughOptions cannot be used for '${this._name}' without turning on enablePositionalOptions for parent command(s)`)}storeOptionsAsProperties(f=!0){if(this.options.length)throw Error("call .storeOptionsAsProperties() before adding options");if(Object.keys(this._optionValues).length)throw Error("call .storeOptionsAsProperties() before setting option values");return this._storeOptionsAsProperties=!!f,this}getOptionValue(f){if(this._storeOptionsAsProperties)return this[f];return this._optionValues[f]}setOptionValue(f,$){return this.setOptionValueWithSource(f,$,void 0)}setOptionValueWithSource(f,$,z){if(this._storeOptionsAsProperties)this[f]=$;else this._optionValues[f]=$;return this._optionValueSources[f]=z,this}getOptionValueSource(f){return this._optionValueSources[f]}getOptionValueSourceWithGlobals(f){let $;return this._getCommandAndAncestors().forEach((z)=>{if(z.getOptionValueSource(f)!==void 0)$=z.getOptionValueSource(f)}),$}_prepareUserArgs(f,$){if(f!==void 0&&!Array.isArray(f))throw Error("first parameter to parse must be array or undefined");if($=$||{},f===void 0&&$.from===void 0){if(U.versions?.electron)$.from="electron";let P=U.execArgv??[];if(P.includes("-e")||P.includes("--eval")||P.includes("-p")||P.includes("--print"))$.from="eval"}if(f===void 0)f=U.argv;this.rawArgs=f.slice();let z;switch($.from){case void 0:case"node":this._scriptPath=f[1],z=f.slice(2);break;case"electron":if(U.defaultApp)this._scriptPath=f[1],z=f.slice(2);else z=f.slice(1);break;case"user":z=f.slice(0);break;case"eval":z=f.slice(1);break;default:throw Error(`unexpected parse option { from: '${$.from}' }`)}if(!this._name&&this._scriptPath)this.nameFromFilename(this._scriptPath);return this._name=this._name||"program",z}parse(f,$){let z=this._prepareUserArgs(f,$);return this._parseCommand([],z),this}async parseAsync(f,$){let z=this._prepareUserArgs(f,$);return await this._parseCommand([],z),this}_executeSubCommand(f,$){$=$.slice();let z=!1,P=[".js",".ts",".tsx",".mjs",".cjs"];function J(Y,L){let N=V.resolve(Y,L);if(Wf.existsSync(N))return N;if(P.includes(V.extname(L)))return;let W=P.find((S)=>Wf.existsSync(`${N}${S}`));if(W)return`${N}${W}`;return}this._checkForMissingMandatoryOptions(),this._checkForConflictingOptions();let Q=f._executableFile||`${this._name}-${f._name}`,G=this._executableDir||"";if(this._scriptPath){let Y;try{Y=Wf.realpathSync(this._scriptPath)}catch(L){Y=this._scriptPath}G=V.resolve(V.dirname(Y),G)}if(G){let Y=J(G,Q);if(!Y&&!f._executableFile&&this._scriptPath){let L=V.basename(this._scriptPath,V.extname(this._scriptPath));if(L!==this._name)Y=J(G,`${L}-${f._name}`)}Q=Y||Q}z=P.includes(V.extname(Q));let X;if(U.platform!=="win32")if(z)$.unshift(Q),$=uf(U.execArgv).concat($),X=Sf.spawn(U.argv[0],$,{stdio:"inherit"});else X=Sf.spawn(Q,$,{stdio:"inherit"});else $.unshift(Q),$=uf(U.execArgv).concat($),X=Sf.spawn(U.execPath,$,{stdio:"inherit"});if(!X.killed)["SIGUSR1","SIGUSR2","SIGTERM","SIGINT","SIGHUP"].forEach((L)=>{U.on(L,()=>{if(X.killed===!1&&X.exitCode===null)X.kill(L)})});let Z=this._exitCallback;X.on("close",(Y)=>{if(Y=Y??1,!Z)U.exit(Y);else Z(new If(Y,"commander.executeSubCommandAsync","(close)"))}),X.on("error",(Y)=>{if(Y.code==="ENOENT"){let L=G?`searched for local subcommand relative to directory '${G}'`:"no directory for search for local subcommand, use .executableDir() to supply a custom directory",N=`'${Q}' does not exist
 - if '${f._name}' is not meant to be an executable command, remove description parameter from '.command()' and use '.description()' instead
 - if the default executable name is not suitable, use the executableFile option to supply a custom name or path
 - ${L}`;throw Error(N)}else if(Y.code==="EACCES")throw Error(`'${Q}' not executable`);if(!Z)U.exit(1);else{let L=new If(1,"commander.executeSubCommandAsync","(error)");L.nestedError=Y,Z(L)}}),this.runningCommand=X}_dispatchSubcommand(f,$,z){let P=this._findCommand(f);if(!P)this.help({error:!0});let J;return J=this._chainOrCallSubCommandHook(J,P,"preSubcommand"),J=this._chainOrCall(J,()=>{if(P._executableHandler)this._executeSubCommand(P,$.concat(z));else return P._parseCommand($,z)}),J}_dispatchHelpCommand(f){if(!f)this.help();let $=this._findCommand(f);if($&&!$._executableHandler)$.help();return this._dispatchSubcommand(f,[],[this._getHelpOption()?.long??this._getHelpOption()?.short??"--help"])}_checkNumberOfArguments(){if(this.registeredArguments.forEach((f,$)=>{if(f.required&&this.args[$]==null)this.missingArgument(f.name())}),this.registeredArguments.length>0&&this.registeredArguments[this.registeredArguments.length-1].variadic)return;if(this.args.length>this.registeredArguments.length)this._excessArguments(this.args)}_processArguments(){let f=(z,P,J)=>{let Q=P;if(P!==null&&z.parseArg){let G=`error: command-argument value '${P}' is invalid for argument '${z.name()}'.`;Q=this._callParseArg(z,P,J,G)}return Q};this._checkNumberOfArguments();let $=[];this.registeredArguments.forEach((z,P)=>{let J=z.defaultValue;if(z.variadic){if(P<this.args.length){if(J=this.args.slice(P),z.parseArg)J=J.reduce((Q,G)=>{return f(z,G,Q)},z.defaultValue)}else if(J===void 0)J=[]}else if(P<this.args.length){if(J=this.args[P],z.parseArg)J=f(z,J,z.defaultValue)}$[P]=J}),this.processedArgs=$}_chainOrCall(f,$){if(f&&f.then&&typeof f.then==="function")return f.then(()=>$());return $()}_chainOrCallHooks(f,$){let z=f,P=[];if(this._getCommandAndAncestors().reverse().filter((J)=>J._lifeCycleHooks[$]!==void 0).forEach((J)=>{J._lifeCycleHooks[$].forEach((Q)=>{P.push({hookedCommand:J,callback:Q})})}),$==="postAction")P.reverse();return P.forEach((J)=>{z=this._chainOrCall(z,()=>{return J.callback(J.hookedCommand,this)})}),z}_chainOrCallSubCommandHook(f,$,z){let P=f;if(this._lifeCycleHooks[z]!==void 0)this._lifeCycleHooks[z].forEach((J)=>{P=this._chainOrCall(P,()=>{return J(this,$)})});return P}_parseCommand(f,$){let z=this.parseOptions($);if(this._parseOptionsEnv(),this._parseOptionsImplied(),f=f.concat(z.operands),$=z.unknown,this.args=f.concat($),f&&this._findCommand(f[0]))return this._dispatchSubcommand(f[0],f.slice(1),$);if(this._getHelpCommand()&&f[0]===this._getHelpCommand().name())return this._dispatchHelpCommand(f[1]);if(this._defaultCommandName)return this._outputHelpIfRequested($),this._dispatchSubcommand(this._defaultCommandName,f,$);if(this.commands.length&&this.args.length===0&&!this._actionHandler&&!this._defaultCommandName)this.help({error:!0});this._outputHelpIfRequested(z.unknown),this._checkForMissingMandatoryOptions(),this._checkForConflictingOptions();let P=()=>{if(z.unknown.length>0)this.unknownOption(z.unknown[0])},J=`command:${this.name()}`;if(this._actionHandler){P(),this._processArguments();let Q;if(Q=this._chainOrCallHooks(Q,"preAction"),Q=this._chainOrCall(Q,()=>this._actionHandler(this.processedArgs)),this.parent)Q=this._chainOrCall(Q,()=>{this.parent.emit(J,f,$)});return Q=this._chainOrCallHooks(Q,"postAction"),Q}if(this.parent&&this.parent.listenerCount(J))P(),this._processArguments(),this.parent.emit(J,f,$);else if(f.length){if(this._findCommand("*"))return this._dispatchSubcommand("*",f,$);if(this.listenerCount("command:*"))this.emit("command:*",f,$);else if(this.commands.length)this.unknownCommand();else P(),this._processArguments()}else if(this.commands.length)P(),this.help({error:!0});else P(),this._processArguments()}_findCommand(f){if(!f)return;return this.commands.find(($)=>$._name===f||$._aliases.includes(f))}_findOption(f){return this.options.find(($)=>$.is(f))}_checkForMissingMandatoryOptions(){this._getCommandAndAncestors().forEach((f)=>{f.options.forEach(($)=>{if($.mandatory&&f.getOptionValue($.attributeName())===void 0)f.missingMandatoryOptionValue($)})})}_checkForConflictingLocalOptions(){let f=this.options.filter((z)=>{let P=z.attributeName();if(this.getOptionValue(P)===void 0)return!1;return this.getOptionValueSource(P)!=="default"});f.filter((z)=>z.conflictsWith.length>0).forEach((z)=>{let P=f.find((J)=>z.conflictsWith.includes(J.attributeName()));if(P)this._conflictingOption(z,P)})}_checkForConflictingOptions(){this._getCommandAndAncestors().forEach((f)=>{f._checkForConflictingLocalOptions()})}parseOptions(f){let $=[],z=[],P=$,J=f.slice();function Q(X){return X.length>1&&X[0]==="-"}let G=null;while(J.length){let X=J.shift();if(X==="--"){if(P===z)P.push(X);P.push(...J);break}if(G&&!Q(X)){this.emit(`option:${G.name()}`,X);continue}if(G=null,Q(X)){let Z=this._findOption(X);if(Z){if(Z.required){let Y=J.shift();if(Y===void 0)this.optionMissingArgument(Z);this.emit(`option:${Z.name()}`,Y)}else if(Z.optional){let Y=null;if(J.length>0&&!Q(J[0]))Y=J.shift();this.emit(`option:${Z.name()}`,Y)}else this.emit(`option:${Z.name()}`);G=Z.variadic?Z:null;continue}}if(X.length>2&&X[0]==="-"&&X[1]!=="-"){let Z=this._findOption(`-${X[1]}`);if(Z){if(Z.required||Z.optional&&this._combineFlagAndOptionalValue)this.emit(`option:${Z.name()}`,X.slice(2));else this.emit(`option:${Z.name()}`),J.unshift(`-${X.slice(2)}`);continue}}if(/^--[^=]+=/.test(X)){let Z=X.indexOf("="),Y=this._findOption(X.slice(0,Z));if(Y&&(Y.required||Y.optional)){this.emit(`option:${Y.name()}`,X.slice(Z+1));continue}}if(Q(X))P=z;if((this._enablePositionalOptions||this._passThroughOptions)&&$.length===0&&z.length===0){if(this._findCommand(X)){if($.push(X),J.length>0)z.push(...J);break}else if(this._getHelpCommand()&&X===this._getHelpCommand().name()){if($.push(X),J.length>0)$.push(...J);break}else if(this._defaultCommandName){if(z.push(X),J.length>0)z.push(...J);break}}if(this._passThroughOptions){if(P.push(X),J.length>0)P.push(...J);break}P.push(X)}return{operands:$,unknown:z}}opts(){if(this._storeOptionsAsProperties){let f={},$=this.options.length;for(let z=0;z<$;z++){let P=this.options[z].attributeName();f[P]=P===this._versionOptionName?this._version:this[P]}return f}return this._optionValues}optsWithGlobals(){return this._getCommandAndAncestors().reduce((f,$)=>Object.assign(f,$.opts()),{})}error(f,$){if(this._outputConfiguration.outputError(`${f}
`,this._outputConfiguration.writeErr),typeof this._showHelpAfterError==="string")this._outputConfiguration.writeErr(`${this._showHelpAfterError}
`);else if(this._showHelpAfterError)this._outputConfiguration.writeErr(`
`),this.outputHelp({error:!0});let z=$||{},P=z.exitCode||1,J=z.code||"commander.error";this._exit(P,J,f)}_parseOptionsEnv(){this.options.forEach((f)=>{if(f.envVar&&f.envVar in U.env){let $=f.attributeName();if(this.getOptionValue($)===void 0||["default","config","env"].includes(this.getOptionValueSource($)))if(f.required||f.optional)this.emit(`optionEnv:${f.name()}`,U.env[f.envVar]);else this.emit(`optionEnv:${f.name()}`)}})}_parseOptionsImplied(){let f=new Q1(this.options),$=(z)=>{return this.getOptionValue(z)!==void 0&&!["default","implied"].includes(this.getOptionValueSource(z))};this.options.filter((z)=>z.implied!==void 0&&$(z.attributeName())&&f.valueFromOption(this.getOptionValue(z.attributeName()),z)).forEach((z)=>{Object.keys(z.implied).filter((P)=>!$(P)).forEach((P)=>{this.setOptionValueWithSource(P,z.implied[P],"implied")})})}missingArgument(f){let $=`error: missing required argument '${f}'`;this.error($,{code:"commander.missingArgument"})}optionMissingArgument(f){let $=`error: option '${f.flags}' argument missing`;this.error($,{code:"commander.optionMissingArgument"})}missingMandatoryOptionValue(f){let $=`error: required option '${f.flags}' not specified`;this.error($,{code:"commander.missingMandatoryOptionValue"})}_conflictingOption(f,$){let z=(Q)=>{let G=Q.attributeName(),X=this.getOptionValue(G),Z=this.options.find((L)=>L.negate&&G===L.attributeName()),Y=this.options.find((L)=>!L.negate&&G===L.attributeName());if(Z&&(Z.presetArg===void 0&&X===!1||Z.presetArg!==void 0&&X===Z.presetArg))return Z;return Y||Q},P=(Q)=>{let G=z(Q),X=G.attributeName();if(this.getOptionValueSource(X)==="env")return`environment variable '${G.envVar}'`;return`option '${G.flags}'`},J=`error: ${P(f)} cannot be used with ${P($)}`;this.error(J,{code:"commander.conflictingOption"})}unknownOption(f){if(this._allowUnknownOption)return;let $="";if(f.startsWith("--")&&this._showSuggestionAfterError){let P=[],J=this;do{let Q=J.createHelp().visibleOptions(J).filter((G)=>G.long).map((G)=>G.long);P=P.concat(Q),J=J.parent}while(J&&!J._enablePositionalOptions);$=vf(f,P)}let z=`error: unknown option '${f}'${$}`;this.error(z,{code:"commander.unknownOption"})}_excessArguments(f){if(this._allowExcessArguments)return;let $=this.registeredArguments.length,z=$===1?"":"s",J=`error: too many arguments${this.parent?` for '${this.name()}'`:""}. Expected ${$} argument${z} but got ${f.length}.`;this.error(J,{code:"commander.excessArguments"})}unknownCommand(){let f=this.args[0],$="";if(this._showSuggestionAfterError){let P=[];this.createHelp().visibleCommands(this).forEach((J)=>{if(P.push(J.name()),J.alias())P.push(J.alias())}),$=vf(f,P)}let z=`error: unknown command '${f}'${$}`;this.error(z,{code:"commander.unknownCommand"})}version(f,$,z){if(f===void 0)return this._version;this._version=f,$=$||"-V, --version",z=z||"output the version number";let P=this.createOption($,z);return this._versionOptionName=P.attributeName(),this._registerOption(P),this.on("option:"+P.name(),()=>{this._outputConfiguration.writeOut(`${f}
`),this._exit(0,"commander.version",f)}),this}description(f,$){if(f===void 0&&$===void 0)return this._description;if(this._description=f,$)this._argsDescription=$;return this}summary(f){if(f===void 0)return this._summary;return this._summary=f,this}alias(f){if(f===void 0)return this._aliases[0];let $=this;if(this.commands.length!==0&&this.commands[this.commands.length-1]._executableHandler)$=this.commands[this.commands.length-1];if(f===$._name)throw Error("Command alias can't be the same as its name");let z=this.parent?._findCommand(f);if(z){let P=[z.name()].concat(z.aliases()).join("|");throw Error(`cannot add alias '${f}' to command '${this.name()}' as already have command '${P}'`)}return $._aliases.push(f),this}aliases(f){if(f===void 0)return this._aliases;return f.forEach(($)=>this.alias($)),this}usage(f){if(f===void 0){if(this._usage)return this._usage;let $=this.registeredArguments.map((z)=>{return P1(z)});return[].concat(this.options.length||this._helpOption!==null?"[options]":[],this.commands.length?"[command]":[],this.registeredArguments.length?$:[]).join(" ")}return this._usage=f,this}name(f){if(f===void 0)return this._name;return this._name=f,this}nameFromFilename(f){return this._name=V.basename(f,V.extname(f)),this}executableDir(f){if(f===void 0)return this._executableDir;return this._executableDir=f,this}helpInformation(f){let $=this.createHelp();if($.helpWidth===void 0)$.helpWidth=f&&f.error?this._outputConfiguration.getErrHelpWidth():this._outputConfiguration.getOutHelpWidth();return $.formatHelp(this,$)}_getHelpContext(f){f=f||{};let $={error:!!f.error},z;if($.error)z=(P)=>this._outputConfiguration.writeErr(P);else z=(P)=>this._outputConfiguration.writeOut(P);return $.write=f.write||z,$.command=this,$}outputHelp(f){let $;if(typeof f==="function")$=f,f=void 0;let z=this._getHelpContext(f);this._getCommandAndAncestors().reverse().forEach((J)=>J.emit("beforeAllHelp",z)),this.emit("beforeHelp",z);let P=this.helpInformation(z);if($){if(P=$(P),typeof P!=="string"&&!Buffer.isBuffer(P))throw Error("outputHelp callback must return a string or a Buffer")}if(z.write(P),this._getHelpOption()?.long)this.emit(this._getHelpOption().long);this.emit("afterHelp",z),this._getCommandAndAncestors().forEach((J)=>J.emit("afterAllHelp",z))}helpOption(f,$){if(typeof f==="boolean"){if(f)this._helpOption=this._helpOption??void 0;else this._helpOption=null;return this}return f=f??"-h, --help",$=$??"display help for command",this._helpOption=this.createOption(f,$),this}_getHelpOption(){if(this._helpOption===void 0)this.helpOption(void 0,void 0);return this._helpOption}addHelpOption(f){return this._helpOption=f,this}help(f){this.outputHelp(f);let $=U.exitCode||0;if($===0&&f&&typeof f!=="function"&&f.error)$=1;this._exit($,"commander.help","(outputHelp)")}addHelpText(f,$){let z=["beforeAll","before","after","afterAll"];if(!z.includes(f))throw Error(`Unexpected value for position to addHelpText.
Expecting one of '${z.join("', '")}'`);let P=`${f}Help`;return this.on(P,(J)=>{let Q;if(typeof $==="function")Q=$({error:J.error,command:J.command});else Q=$;if(Q)J.write(`${Q}
`)}),this}_outputHelpIfRequested(f){let $=this._getHelpOption();if($&&f.find((P)=>$.is(P)))this.outputHelp(),this._exit(0,"commander.helpDisplayed","(outputHelp)")}}function uf(f){return f.map(($)=>{if(!$.startsWith("--inspect"))return $;let z,P="127.0.0.1",J="9229",Q;if((Q=$.match(/^(--inspect(-brk)?)$/))!==null)z=Q[1];else if((Q=$.match(/^(--inspect(-brk|-port)?)=([^:]+)$/))!==null)if(z=Q[1],/^\d+$/.test(Q[3]))J=Q[3];else P=Q[3];else if((Q=$.match(/^(--inspect(-brk|-port)?)=([^:]+):(\d+)$/))!==null)z=Q[1],P=Q[3],J=Q[4];if(z&&J!=="0")return`${z}=${P}:${parseInt(J)+1}`;return $})}G1.Command=Tf});var sf=q((L1)=>{var{Argument:cf}=s(),{Command:Uf}=lf(),{CommanderError:Z1,InvalidArgumentError:hf}=v(),{Help:Y1}=Lf(),{Option:gf}=Nf();L1.program=new Uf;L1.createCommand=(f)=>new Uf(f);L1.createOption=(f,$)=>new gf(f,$);L1.createArgument=(f,$)=>new cf(f,$);L1.Command=Uf;L1.Option=gf;L1.Argument=cf;L1.Help=Y1;L1.CommanderError=Z1;L1.InvalidArgumentError=hf;L1.InvalidOptionArgumentError=hf});var mf=b0(sf(),1),{program:K,createCommand:$$,createArgument:z$,createOption:P$,CommanderError:J$,InvalidArgumentError:Q$,InvalidOptionArgumentError:G$,Command:X$,Argument:Z$,Option:Y$,Help:L$}=mf.default;import{existsSync as m,mkdirSync as rf,readFileSync as M1,writeFileSync as _1}from"fs";import{homedir as V1}from"os";import{join as df}from"path";var y=process.env.WASP_DATA_DIR||df(V1(),".wasp"),t=df(y,"wasp.json"),M=null;function jf(){return y}function x(){return m(t)}function tf(){return{contacts:[],auditLog:[],meta:{version:"0.0.1",createdAt:new Date().toISOString()}}}function E(){if(M)return M;if(!m(y))rf(y,{recursive:!0});if(!m(t))return M=tf(),H(),M;try{let f=M1(t,"utf-8");return M=JSON.parse(f),M}catch{return M=tf(),H(),M}}function H(){if(!M)return;if(!m(y))rf(y,{recursive:!0});_1(t,JSON.stringify(M,null,2))}function r(){E()}function nf(f=!1){if(x()&&!f){console.log("wasp is already initialized."),console.log(`Data directory: ${jf()}`),console.log("Use --force to reinitialize.");return}r(),console.log("wasp initialized successfully."),console.log(`Data directory: ${jf()}`),console.log(""),console.log("Next steps:"),console.log('  wasp add "+440123456789" --name "Your Name" --trust sovereign'),console.log("  wasp list"),console.log("  wasp serve")}var pf=1;function F1(){return pf=E().contacts.reduce((z,P)=>Math.max(z,P.id),0)+1,pf++}function d(f,$="whatsapp",z="trusted",P,J){let Q=E(),G=Q.contacts.findIndex((Z)=>Z.identifier===f&&Z.platform===$);if(G>=0){let Z=Q.contacts[G];if(Z.trust=z,P)Z.name=P;if(J)Z.notes=J;return H(),Z}let X={id:F1(),identifier:f,platform:$,name:P||null,trust:z,addedAt:new Date().toISOString(),notes:J||null};return Q.contacts.push(X),H(),X}function n(f,$="whatsapp"){let z=E(),P=z.contacts.length;z.contacts=z.contacts.filter((Q)=>!(Q.identifier===f&&Q.platform===$));let J=z.contacts.length<P;if(J)H();return J}function w1(f,$="whatsapp"){return E().contacts.find((P)=>P.identifier===f&&P.platform===$)||null}function p(f,$){return E().contacts.filter((P)=>{if(f&&P.platform!==f)return!1;if($&&P.trust!==$)return!1;return!0}).sort((P,J)=>new Date(J.addedAt).getTime()-new Date(P.addedAt).getTime())}function o(f,$="whatsapp"){let z=w1(f,$);if(!z)return{allowed:!1,trust:null,name:null,reason:"Contact not in whitelist"};if(z.trust==="limited")return{allowed:!0,trust:"limited",name:z.name,reason:"Limited trust - agent may view but should not act"};return{allowed:!0,trust:z.trust,name:z.name,reason:"Contact is trusted"}}function of(f,$){let z=d(f,$.platform||"whatsapp",$.trust||"trusted",$.name,$.notes);if(console.log("Contact added/updated:"),console.log(`  Identifier: ${z.identifier}`),console.log(`  Platform:   ${z.platform}`),console.log(`  Trust:      ${z.trust}`),z.name)console.log(`  Name:       ${z.name}`);if(z.notes)console.log(`  Notes:      ${z.notes}`)}function af(f,$="whatsapp"){if(n(f,$))console.log(`Removed: ${f} (${$})`);else console.log(`Not found: ${f} (${$})`)}function ef(f){let $=p(f.platform,f.trust);if($.length===0){console.log("No contacts found.");return}if(f.json){console.log(JSON.stringify($,null,2));return}console.log(`Found ${$.length} contact(s):
`);for(let z of $){let P=z.name?` (${z.name})`:"";if(console.log(`  ${z.identifier}${P}`),console.log(`    Platform: ${z.platform} | Trust: ${z.trust}`),z.notes)console.log(`    Notes: ${z.notes}`);console.log("")}}var f0=1;function H1(){return f0=E().auditLog.reduce((z,P)=>Math.max(z,P.id),0)+1,f0++}function a(f,$,z,P){let J=E(),Q={id:H1(),timestamp:new Date().toISOString(),identifier:f,platform:$,decision:z,reason:P};if(J.auditLog.push(Q),J.auditLog.length>1000)J.auditLog=J.auditLog.slice(-1000);H()}function e(f){let z=[...E().auditLog];if(f.decision)z=z.filter((P)=>P.decision===f.decision);if(f.since){let P=new Date(f.since);z=z.filter((J)=>new Date(J.timestamp)>=P)}if(z.sort((P,J)=>new Date(J.timestamp).getTime()-new Date(P.timestamp).getTime()),f.limit)z=z.slice(0,f.limit);return z}function $0(f,$){let z=$.platform||"whatsapp",P=o(f,z),J=!P.allowed?"deny":P.trust==="limited"?"limited":"allow";if(a(f,z,J,P.reason),$.json){console.log(JSON.stringify(P)),process.exit(P.allowed?0:1);return}if($.quiet){process.exit(P.allowed?0:1);return}if(P.allowed){let Q=P.name?` (${P.name})`:"";if(console.log(`ALLOWED: ${f}${Q}`),console.log(`  Trust level: ${P.trust}`),P.trust==="limited")console.log("  Note: Limited trust - agent may view but should not act")}else console.log(`DENIED: ${f}`),console.log(`  Reason: ${P.reason}`);process.exit(P.allowed?0:1)}function z0(f){let $=e({limit:f.limit||50,decision:f.denied?"deny":void 0});if($.length===0){console.log("No audit entries found.");return}if(f.json){console.log(JSON.stringify($,null,2));return}console.log(`Last ${$.length} audit entries:
`);for(let z of $){let P=z.decision==="allow"?"\u2713":z.decision==="limited"?"~":"\u2717";console.log(`  ${P} ${z.timestamp} | ${z.identifier} (${z.platform})`),console.log(`    Decision: ${z.decision} - ${z.reason}`),console.log("")}}var Rf=(f,$,z)=>{return(P,J)=>{let Q=-1;return G(0);async function G(X){if(X<=Q)throw Error("next() called multiple times");Q=X;let Z,Y=!1,L;if(f[X])L=f[X][0][0],P.req.routeIndex=X;else L=X===f.length&&J||void 0;if(L)try{Z=await L(P,()=>G(X+1))}catch(N){if(N instanceof Error&&$)P.error=N,Z=await $(N,P),Y=!0;else throw N}else if(P.finalized===!1&&z)Z=await z(P);if(Z&&(P.finalized===!1||Y))P.res=Z;return P}}};var P0=Symbol();var J0=async(f,$=Object.create(null))=>{let{all:z=!1,dot:P=!1}=$,Q=(f instanceof ff?f.raw.headers:f.headers).get("Content-Type");if(Q?.startsWith("multipart/form-data")||Q?.startsWith("application/x-www-form-urlencoded"))return q1(f,{all:z,dot:P});return{}};async function q1(f,$){let z=await f.formData();if(z)return D1(z,$);return{}}function D1(f,$){let z=Object.create(null);if(f.forEach((P,J)=>{if(!($.all||J.endsWith("[]")))z[J]=P;else A1(z,J,P)}),$.dot)Object.entries(z).forEach(([P,J])=>{if(P.includes("."))y1(z,P,J),delete z[P]});return z}var A1=(f,$,z)=>{if(f[$]!==void 0)if(Array.isArray(f[$]))f[$].push(z);else f[$]=[f[$],z];else if(!$.endsWith("[]"))f[$]=z;else f[$]=[z]},y1=(f,$,z)=>{let P=f,J=$.split(".");J.forEach((Q,G)=>{if(G===J.length-1)P[Q]=z;else{if(!P[Q]||typeof P[Q]!=="object"||Array.isArray(P[Q])||P[Q]instanceof File)P[Q]=Object.create(null);P=P[Q]}})};var Bf=(f)=>{let $=f.split("/");if($[0]==="")$.shift();return $},Q0=(f)=>{let{groups:$,path:z}=x1(f),P=Bf(z);return b1(P,$)},x1=(f)=>{let $=[];return f=f.replace(/\{[^}]+\}/g,(z,P)=>{let J=`@${P}`;return $.push([J,z]),J}),{groups:$,path:f}},b1=(f,$)=>{for(let z=$.length-1;z>=0;z--){let[P]=$[z];for(let J=f.length-1;J>=0;J--)if(f[J].includes(P)){f[J]=f[J].replace(P,$[z][1]);break}}return f},$f={},G0=(f,$)=>{if(f==="*")return"*";let z=f.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(z){let P=`${f}#${$}`;if(!$f[P])if(z[2])$f[P]=$&&$[0]!==":"&&$[0]!=="*"?[P,z[1],new RegExp(`^${z[2]}(?=/${$})`)]:[f,z[1],new RegExp(`^${z[2]}$`)];else $f[P]=[f,z[1],!0];return $f[P]}return null},zf=(f,$)=>{try{return $(f)}catch{return f.replace(/(?:%[0-9A-Fa-f]{2})+/g,(z)=>{try{return $(z)}catch{return z}})}},O1=(f)=>zf(f,decodeURI),Kf=(f)=>{let $=f.url,z=$.indexOf("/",$.indexOf(":")+4),P=z;for(;P<$.length;P++){let J=$.charCodeAt(P);if(J===37){let Q=$.indexOf("?",P),G=$.slice(z,Q===-1?void 0:Q);return O1(G.includes("%25")?G.replace(/%25/g,"%2525"):G)}else if(J===63)break}return $.slice(z,P)};var X0=(f)=>{let $=Kf(f);return $.length>1&&$.at(-1)==="/"?$.slice(0,-1):$},D=(f,$,...z)=>{if(z.length)$=D($,...z);return`${f?.[0]==="/"?"":"/"}${f}${$==="/"?"":`${f?.at(-1)==="/"?"":"/"}${$?.[0]==="/"?$.slice(1):$}`}`},Pf=(f)=>{if(f.charCodeAt(f.length-1)!==63||!f.includes(":"))return null;let $=f.split("/"),z=[],P="";return $.forEach((J)=>{if(J!==""&&!/\:/.test(J))P+="/"+J;else if(/\:/.test(J))if(/\?/.test(J)){if(z.length===0&&P==="")z.push("/");else z.push(P);let Q=J.replace("?","");P+="/"+Q,z.push(P)}else P+="/"+J}),z.filter((J,Q,G)=>G.indexOf(J)===Q)},Ef=(f)=>{if(!/[%+]/.test(f))return f;if(f.indexOf("+")!==-1)f=f.replace(/\+/g," ");return f.indexOf("%")!==-1?zf(f,Mf):f},Z0=(f,$,z)=>{let P;if(!z&&$&&!/[%+]/.test($)){let G=f.indexOf("?",8);if(G===-1)return;if(!f.startsWith($,G+1))G=f.indexOf(`&${$}`,G+1);while(G!==-1){let X=f.charCodeAt(G+$.length+1);if(X===61){let Z=G+$.length+2,Y=f.indexOf("&",Z);return Ef(f.slice(Z,Y===-1?void 0:Y))}else if(X==38||isNaN(X))return"";G=f.indexOf(`&${$}`,G+1)}if(P=/[%+]/.test(f),!P)return}let J={};P??=/[%+]/.test(f);let Q=f.indexOf("?",8);while(Q!==-1){let G=f.indexOf("&",Q+1),X=f.indexOf("=",Q);if(X>G&&G!==-1)X=-1;let Z=f.slice(Q+1,X===-1?G===-1?void 0:G:X);if(P)Z=Ef(Z);if(Q=G,Z==="")continue;let Y;if(X===-1)Y="";else if(Y=f.slice(X+1,G===-1?void 0:G),P)Y=Ef(Y);if(z){if(!(J[Z]&&Array.isArray(J[Z])))J[Z]=[];J[Z].push(Y)}else J[Z]??=Y}return $?J[$]:J},Y0=Z0,L0=(f,$)=>{return Z0(f,$,!0)},Mf=decodeURIComponent;var N0=(f)=>zf(f,Mf),ff=class{raw;#f;#$;routeIndex=0;path;bodyCache={};constructor(f,$="/",z=[[]]){this.raw=f,this.path=$,this.#$=z,this.#f={}}param(f){return f?this.#z(f):this.#Q()}#z(f){let $=this.#$[0][this.routeIndex][1][f],z=this.#J($);return z&&/\%/.test(z)?N0(z):z}#Q(){let f={},$=Object.keys(this.#$[0][this.routeIndex][1]);for(let z of $){let P=this.#J(this.#$[0][this.routeIndex][1][z]);if(P!==void 0)f[z]=/\%/.test(P)?N0(P):P}return f}#J(f){return this.#$[1]?this.#$[1][f]:f}query(f){return Y0(this.url,f)}queries(f){return L0(this.url,f)}header(f){if(f)return this.raw.headers.get(f)??void 0;let $={};return this.raw.headers.forEach((z,P)=>{$[P]=z}),$}async parseBody(f){return this.bodyCache.parsedBody??=await J0(this,f)}#P=(f)=>{let{bodyCache:$,raw:z}=this,P=$[f];if(P)return P;let J=Object.keys($)[0];if(J)return $[J].then((Q)=>{if(J==="json")Q=JSON.stringify(Q);return new Response(Q)[f]()});return $[f]=z[f]()};json(){return this.#P("text").then((f)=>JSON.parse(f))}text(){return this.#P("text")}arrayBuffer(){return this.#P("arrayBuffer")}blob(){return this.#P("blob")}formData(){return this.#P("formData")}addValidatedData(f,$){this.#f[f]=$}valid(f){return this.#f[f]}get url(){return this.raw.url}get method(){return this.raw.method}get[P0](){return this.#$}get matchedRoutes(){return this.#$[0].map(([[,f]])=>f)}get routePath(){return this.#$[0].map(([[,f]])=>f)[this.routeIndex].path}};var S0={Stringify:1,BeforeStream:2,Stream:3},C1=(f,$)=>{let z=new String(f);return z.isEscaped=!0,z.callbacks=$,z};var _f=async(f,$,z,P,J)=>{if(typeof f==="object"&&!(f instanceof String)){if(!(f instanceof Promise))f=f.toString();if(f instanceof Promise)f=await f}let Q=f.callbacks;if(!Q?.length)return Promise.resolve(f);if(J)J[0]+=f;else J=[f];let G=Promise.all(Q.map((X)=>X({phase:$,buffer:J,context:P}))).then((X)=>Promise.all(X.filter(Boolean).map((Z)=>_f(Z,$,!1,P,J))).then(()=>J[0]));if(z)return C1(await G,Q);else return G};var k1="text/plain; charset=UTF-8",Vf=(f,$)=>{return{"Content-Type":f,...$}},W0=class{#f;#$;env={};#z;finalized=!1;error;#Q;#J;#P;#L;#Z;#Y;#X;#N;#S;constructor(f,$){if(this.#f=f,$)this.#J=$.executionCtx,this.env=$.env,this.#Y=$.notFoundHandler,this.#S=$.path,this.#N=$.matchResult}get req(){return this.#$??=new ff(this.#f,this.#S,this.#N),this.#$}get event(){if(this.#J&&"respondWith"in this.#J)return this.#J;else throw Error("This context has no FetchEvent")}get executionCtx(){if(this.#J)return this.#J;else throw Error("This context has no ExecutionContext")}get res(){return this.#P||=new Response(null,{headers:this.#X??=new Headers})}set res(f){if(this.#P&&f){f=new Response(f.body,f);for(let[$,z]of this.#P.headers.entries()){if($==="content-type")continue;if($==="set-cookie"){let P=this.#P.headers.getSetCookie();f.headers.delete("set-cookie");for(let J of P)f.headers.append("set-cookie",J)}else f.headers.set($,z)}}this.#P=f,this.finalized=!0}render=(...f)=>{return this.#Z??=($)=>this.html($),this.#Z(...f)};setLayout=(f)=>this.#L=f;getLayout=()=>this.#L;setRenderer=(f)=>{this.#Z=f};header=(f,$,z)=>{if(this.finalized)this.#P=new Response(this.#P.body,this.#P);let P=this.#P?this.#P.headers:this.#X??=new Headers;if($===void 0)P.delete(f);else if(z?.append)P.append(f,$);else P.set(f,$)};status=(f)=>{this.#Q=f};set=(f,$)=>{this.#z??=new Map,this.#z.set(f,$)};get=(f)=>{return this.#z?this.#z.get(f):void 0};get var(){if(!this.#z)return{};return Object.fromEntries(this.#z)}#G(f,$,z){let P=this.#P?new Headers(this.#P.headers):this.#X??new Headers;if(typeof $==="object"&&"headers"in $){let Q=$.headers instanceof Headers?$.headers:new Headers($.headers);for(let[G,X]of Q)if(G.toLowerCase()==="set-cookie")P.append(G,X);else P.set(G,X)}if(z)for(let[Q,G]of Object.entries(z))if(typeof G==="string")P.set(Q,G);else{P.delete(Q);for(let X of G)P.append(Q,X)}let J=typeof $==="number"?$:$?.status??this.#Q;return new Response(f,{status:J,headers:P})}newResponse=(...f)=>this.#G(...f);body=(f,$,z)=>this.#G(f,$,z);text=(f,$,z)=>{return!this.#X&&!this.#Q&&!$&&!z&&!this.finalized?new Response(f):this.#G(f,$,Vf(k1,z))};json=(f,$,z)=>{return this.#G(JSON.stringify(f),$,Vf("application/json",z))};html=(f,$,z)=>{let P=(J)=>this.#G(J,$,Vf("text/html; charset=UTF-8",z));return typeof f==="object"?_f(f,S0.Stringify,!1,{}).then(P):P(f)};redirect=(f,$)=>{let z=String(f);return this.header("Location",!/[^\x00-\xFF]/.test(z)?z:encodeURI(z)),this.newResponse(null,$??302)};notFound=()=>{return this.#Y??=()=>new Response,this.#Y(this)}};var I="ALL",I0="all",T0=["get","post","put","delete","options","patch"],Jf="Can not add a route since the matcher is already built.",Qf=class extends Error{};var U0="__COMPOSED_HANDLER";var v1=(f)=>{return f.text("404 Not Found",404)},j0=(f,$)=>{if("getResponse"in f){let z=f.getResponse();return $.newResponse(z.body,z)}return console.error(f),$.text("Internal Server Error",500)},R0=class f{get;post;put;delete;options;patch;all;on;use;router;getPath;_basePath="/";#f="/";routes=[];constructor($={}){[...T0,I0].forEach((Q)=>{this[Q]=(G,...X)=>{if(typeof G==="string")this.#f=G;else this.#Q(Q,this.#f,G);return X.forEach((Z)=>{this.#Q(Q,this.#f,Z)}),this}}),this.on=(Q,G,...X)=>{for(let Z of[G].flat()){this.#f=Z;for(let Y of[Q].flat())X.map((L)=>{this.#Q(Y.toUpperCase(),this.#f,L)})}return this},this.use=(Q,...G)=>{if(typeof Q==="string")this.#f=Q;else this.#f="*",G.unshift(Q);return G.forEach((X)=>{this.#Q(I,this.#f,X)}),this};let{strict:P,...J}=$;Object.assign(this,J),this.getPath=P??!0?$.getPath??Kf:X0}#$(){let $=new f({router:this.router,getPath:this.getPath});return $.errorHandler=this.errorHandler,$.#z=this.#z,$.routes=this.routes,$}#z=v1;errorHandler=j0;route($,z){let P=this.basePath($);return z.routes.map((J)=>{let Q;if(z.errorHandler===j0)Q=J.handler;else Q=async(G,X)=>(await Rf([],z.errorHandler)(G,()=>J.handler(G,X))).res,Q[U0]=J.handler;P.#Q(J.method,J.path,Q)}),this}basePath($){let z=this.#$();return z._basePath=D(this._basePath,$),z}onError=($)=>{return this.errorHandler=$,this};notFound=($)=>{return this.#z=$,this};mount($,z,P){let J,Q;if(P)if(typeof P==="function")Q=P;else if(Q=P.optionHandler,P.replaceRequest===!1)J=(Z)=>Z;else J=P.replaceRequest;let G=Q?(Z)=>{let Y=Q(Z);return Array.isArray(Y)?Y:[Y]}:(Z)=>{let Y=void 0;try{Y=Z.executionCtx}catch{}return[Z.env,Y]};J||=(()=>{let Z=D(this._basePath,$),Y=Z==="/"?0:Z.length;return(L)=>{let N=new URL(L.url);return N.pathname=N.pathname.slice(Y)||"/",new Request(N,L)}})();let X=async(Z,Y)=>{let L=await z(J(Z.req.raw),...G(Z));if(L)return L;await Y()};return this.#Q(I,D($,"*"),X),this}#Q($,z,P){$=$.toUpperCase(),z=D(this._basePath,z);let J={basePath:this._basePath,path:z,method:$,handler:P};this.router.add($,z,[P,J]),this.routes.push(J)}#J($,z){if($ instanceof Error)return this.errorHandler($,z);throw $}#P($,z,P,J){if(J==="HEAD")return(async()=>new Response(null,await this.#P($,z,P,"GET")))();let Q=this.getPath($,{env:P}),G=this.router.match(J,Q),X=new W0($,{path:Q,matchResult:G,env:P,executionCtx:z,notFoundHandler:this.#z});if(G[0].length===1){let Y;try{Y=G[0][0][0][0](X,async()=>{X.res=await this.#z(X)})}catch(L){return this.#J(L,X)}return Y instanceof Promise?Y.then((L)=>L||(X.finalized?X.res:this.#z(X))).catch((L)=>this.#J(L,X)):Y??this.#z(X)}let Z=Rf(G[0],this.errorHandler,this.#z);return(async()=>{try{let Y=await Z(X);if(!Y.finalized)throw Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return Y.res}catch(Y){return this.#J(Y,X)}})()}fetch=($,...z)=>{return this.#P($,z[1],z[0],$.method)};request=($,z,P,J)=>{if($ instanceof Request)return this.fetch(z?new Request($,z):$,P,J);return $=$.toString(),this.fetch(new Request(/^https?:\/\//.test($)?$:`http://localhost${D("/",$)}`,z),P,J)};fire=()=>{addEventListener("fetch",($)=>{$.respondWith(this.#P($.request,$,void 0,$.request.method))})}};var u=[];function Gf(f,$){let z=this.buildAllMatchers(),P=(J,Q)=>{let G=z[J]||z[I],X=G[2][Q];if(X)return X;let Z=Q.match(G[0]);if(!Z)return[[],u];let Y=Z.indexOf("",1);return[G[1][Y],Z]};return this.match=P,P(f,$)}var Xf="[^/]+",l=".*",c="(?:|/.*)",A=Symbol(),u1=new Set(".\\+*[^]$()");function l1(f,$){if(f.length===1)return $.length===1?f<$?-1:1:-1;if($.length===1)return 1;if(f===l||f===c)return 1;else if($===l||$===c)return-1;if(f===Xf)return 1;else if($===Xf)return-1;return f.length===$.length?f<$?-1:1:$.length-f.length}var E0=class f{#f;#$;#z=Object.create(null);insert($,z,P,J,Q){if($.length===0){if(this.#f!==void 0)throw A;if(Q)return;this.#f=z;return}let[G,...X]=$,Z=G==="*"?X.length===0?["","",l]:["","",Xf]:G==="/*"?["","",c]:G.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/),Y;if(Z){let L=Z[1],N=Z[2]||Xf;if(L&&Z[2]){if(N===".*")throw A;if(N=N.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(N))throw A}if(Y=this.#z[N],!Y){if(Object.keys(this.#z).some((W)=>W!==l&&W!==c))throw A;if(Q)return;if(Y=this.#z[N]=new f,L!=="")Y.#$=J.varIndex++}if(!Q&&L!=="")P.push([L,Y.#$])}else if(Y=this.#z[G],!Y){if(Object.keys(this.#z).some((L)=>L.length>1&&L!==l&&L!==c))throw A;if(Q)return;Y=this.#z[G]=new f}Y.insert(X,z,P,J,Q)}buildRegExpStr(){let z=Object.keys(this.#z).sort(l1).map((P)=>{let J=this.#z[P];return(typeof J.#$==="number"?`(${P})@${J.#$}`:u1.has(P)?`\\${P}`:P)+J.buildRegExpStr()});if(typeof this.#f==="number")z.unshift(`#${this.#f}`);if(z.length===0)return"";if(z.length===1)return z[0];return"(?:"+z.join("|")+")"}};var B0=class{#f={varIndex:0};#$=new E0;insert(f,$,z){let P=[],J=[];for(let G=0;;){let X=!1;if(f=f.replace(/\{[^}]+\}/g,(Z)=>{let Y=`@\\${G}`;return J[G]=[Y,Z],G++,X=!0,Y}),!X)break}let Q=f.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let G=J.length-1;G>=0;G--){let[X]=J[G];for(let Z=Q.length-1;Z>=0;Z--)if(Q[Z].indexOf(X)!==-1){Q[Z]=Q[Z].replace(X,J[G][1]);break}}return this.#$.insert(Q,$,P,this.#f,z),P}buildRegExp(){let f=this.#$.buildRegExpStr();if(f==="")return[/^$/,[],[]];let $=0,z=[],P=[];return f=f.replace(/#(\d+)|@(\d+)|\.\*\$/g,(J,Q,G)=>{if(Q!==void 0)return z[++$]=Number(Q),"$()";if(G!==void 0)return P[Number(G)]=++$,"";return""}),[new RegExp(`^${f}`),z,P]}};var c1=[/^$/,[],Object.create(null)],K0=Object.create(null);function M0(f){return K0[f]??=new RegExp(f==="*"?"":`^${f.replace(/\/\*$|([.\\+*[^\]$()])/g,($,z)=>z?`\\${z}`:"(?:|/.*)")}$`)}function h1(){K0=Object.create(null)}function g1(f){let $=new B0,z=[];if(f.length===0)return c1;let P=f.map((Y)=>[!/\*|\/:/.test(Y[0]),...Y]).sort(([Y,L],[N,W])=>Y?1:N?-1:L.length-W.length),J=Object.create(null);for(let Y=0,L=-1,N=P.length;Y<N;Y++){let[W,S,j]=P[Y];if(W)J[S]=[j.map(([R])=>[R,Object.create(null)]),u];else L++;let T;try{T=$.insert(S,L,W)}catch(R){throw R===A?new Qf(S):R}if(W)continue;z[L]=j.map(([R,F])=>{let g=Object.create(null);F-=1;for(;F>=0;F--){let[i,B]=T[F];g[i]=B}return[R,g]})}let[Q,G,X]=$.buildRegExp();for(let Y=0,L=z.length;Y<L;Y++)for(let N=0,W=z[Y].length;N<W;N++){let S=z[Y][N]?.[1];if(!S)continue;let j=Object.keys(S);for(let T=0,R=j.length;T<R;T++)S[j[T]]=X[S[j[T]]]}let Z=[];for(let Y in G)Z[Y]=z[G[Y]];return[Q,Z,J]}function b(f,$){if(!f)return;for(let z of Object.keys(f).sort((P,J)=>J.length-P.length))if(M0(z).test($))return[...f[z]];return}var Zf=class{name="RegExpRouter";#f;#$;constructor(){this.#f={[I]:Object.create(null)},this.#$={[I]:Object.create(null)}}add(f,$,z){let P=this.#f,J=this.#$;if(!P||!J)throw Error(Jf);if(!P[f])[P,J].forEach((X)=>{X[f]=Object.create(null),Object.keys(X[I]).forEach((Z)=>{X[f][Z]=[...X[I][Z]]})});if($==="/*")$="*";let Q=($.match(/\/:/g)||[]).length;if(/\*$/.test($)){let X=M0($);if(f===I)Object.keys(P).forEach((Z)=>{P[Z][$]||=b(P[Z],$)||b(P[I],$)||[]});else P[f][$]||=b(P[f],$)||b(P[I],$)||[];Object.keys(P).forEach((Z)=>{if(f===I||f===Z)Object.keys(P[Z]).forEach((Y)=>{X.test(Y)&&P[Z][Y].push([z,Q])})}),Object.keys(J).forEach((Z)=>{if(f===I||f===Z)Object.keys(J[Z]).forEach((Y)=>X.test(Y)&&J[Z][Y].push([z,Q]))});return}let G=Pf($)||[$];for(let X=0,Z=G.length;X<Z;X++){let Y=G[X];Object.keys(J).forEach((L)=>{if(f===I||f===L)J[L][Y]||=[...b(P[L],Y)||b(P[I],Y)||[]],J[L][Y].push([z,Q-Z+X+1])})}}match=Gf;buildAllMatchers(){let f=Object.create(null);return Object.keys(this.#$).concat(Object.keys(this.#f)).forEach(($)=>{f[$]||=this.#z($)}),this.#f=this.#$=void 0,h1(),f}#z(f){let $=[],z=f===I;if([this.#f,this.#$].forEach((P)=>{let J=P[f]?Object.keys(P[f]).map((Q)=>[Q,P[f][Q]]):[];if(J.length!==0)z||=!0,$.push(...J);else if(f!==I)$.push(...Object.keys(P[I]).map((Q)=>[Q,P[I][Q]]))}),!z)return null;else return g1($)}};var i1=class{name="PreparedRegExpRouter";#f;#$;constructor(f,$){this.#f=f,this.#$=$}#z(f,$){let z=this.#f[f];z[1].forEach((P)=>P&&P.push($)),Object.values(z[2]).forEach((P)=>P[0].push($))}#Q(f,$,z,P,J){let Q=this.#f[f];if(!J)Q[2][$][0].push([z,{}]);else P.forEach((G)=>{if(typeof G==="number")Q[1][G].push([z,J]);else Q[2][G||$][0].push([z,J])})}add(f,$,z){if(!this.#f[f]){let J=this.#f[I],Q={};for(let G in J[2])Q[G]=[J[2][G][0].slice(),u];this.#f[f]=[J[0],J[1].map((G)=>Array.isArray(G)?G.slice():0),Q]}if($==="/*"||$==="*"){let J=[z,{}];if(f===I)for(let Q in this.#f)this.#z(Q,J);else this.#z(f,J);return}let P=this.#$[$];if(!P)throw Error(`Path ${$} is not registered`);for(let[J,Q]of P)if(f===I)for(let G in this.#f)this.#Q(G,$,z,J,Q);else this.#Q(f,$,z,J,Q)}buildAllMatchers(){return this.#f}match=Gf};var Ff=class{name="SmartRouter";#f=[];#$=[];constructor(f){this.#f=f.routers}add(f,$,z){if(!this.#$)throw Error(Jf);this.#$.push([f,$,z])}match(f,$){if(!this.#$)throw Error("Fatal error");let z=this.#f,P=this.#$,J=z.length,Q=0,G;for(;Q<J;Q++){let X=z[Q];try{for(let Z=0,Y=P.length;Z<Y;Z++)X.add(...P[Z]);G=X.match(f,$)}catch(Z){if(Z instanceof Qf)continue;throw Z}this.match=X.match.bind(X),this.#f=[X],this.#$=void 0;break}if(Q===J)throw Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,G}get activeRouter(){if(this.#$||this.#f.length!==1)throw Error("No active router has been determined yet.");return this.#f[0]}};var h=Object.create(null),_0=class f{#f;#$;#z;#Q=0;#J=h;constructor($,z,P){if(this.#$=P||Object.create(null),this.#f=[],$&&z){let J=Object.create(null);J[$]={handler:z,possibleKeys:[],score:0},this.#f=[J]}this.#z=[]}insert($,z,P){this.#Q=++this.#Q;let J=this,Q=Q0(z),G=[];for(let X=0,Z=Q.length;X<Z;X++){let Y=Q[X],L=Q[X+1],N=G0(Y,L),W=Array.isArray(N)?N[0]:Y;if(W in J.#$){if(J=J.#$[W],N)G.push(N[1]);continue}if(J.#$[W]=new f,N)J.#z.push(N),G.push(N[1]);J=J.#$[W]}return J.#f.push({[$]:{handler:P,possibleKeys:G.filter((X,Z,Y)=>Y.indexOf(X)===Z),score:this.#Q}}),J}#P($,z,P,J){let Q=[];for(let G=0,X=$.#f.length;G<X;G++){let Z=$.#f[G],Y=Z[z]||Z[I],L={};if(Y!==void 0){if(Y.params=Object.create(null),Q.push(Y),P!==h||J&&J!==h)for(let N=0,W=Y.possibleKeys.length;N<W;N++){let S=Y.possibleKeys[N],j=L[Y.score];Y.params[S]=J?.[S]&&!j?J[S]:P[S]??J?.[S],L[Y.score]=!0}}}return Q}search($,z){let P=[];this.#J=h;let Q=[this],G=Bf(z),X=[];for(let Z=0,Y=G.length;Z<Y;Z++){let L=G[Z],N=Z===Y-1,W=[];for(let S=0,j=Q.length;S<j;S++){let T=Q[S],R=T.#$[L];if(R)if(R.#J=T.#J,N){if(R.#$["*"])P.push(...this.#P(R.#$["*"],$,T.#J));P.push(...this.#P(R,$,T.#J))}else W.push(R);for(let F=0,g=T.#z.length;F<g;F++){let i=T.#z[F],B=T.#J===h?{}:{...T.#J};if(i==="*"){let w=T.#$["*"];if(w)P.push(...this.#P(w,$,T.#J)),w.#J=B,W.push(w);continue}let[w0,qf,C]=i;if(!L&&!(C instanceof RegExp))continue;let _=T.#$[w0],H0=G.slice(Z).join("/");if(C instanceof RegExp){let w=C.exec(H0);if(w){if(B[qf]=w[0],P.push(...this.#P(_,$,T.#J,B)),Object.keys(_.#$).length){_.#J=B;let q0=w[0].match(/\//)?.length??0;(X[q0]||=[]).push(_)}continue}}if(C===!0||C.test(L))if(B[qf]=L,N){if(P.push(...this.#P(_,$,B,T.#J)),_.#$["*"])P.push(...this.#P(_.#$["*"],$,B,T.#J))}else _.#J=B,W.push(_)}}Q=W.concat(X.shift()??[])}if(P.length>1)P.sort((Z,Y)=>{return Z.score-Y.score});return[P.map(({handler:Z,params:Y})=>[Z,Y])]}};var wf=class{name="TrieRouter";#f;constructor(){this.#f=new _0}add(f,$,z){let P=Pf($);if(P){for(let J=0,Q=P.length;J<Q;J++)this.#f.insert(f,P[J],z);return}this.#f.insert(f,$,z)}match(f,$){return this.#f.search(f,$)}};var Hf=class extends R0{constructor(f={}){super(f);this.router=f.router??new Ff({routers:[new Zf,new wf]})}};function s1(){let f=new Hf;return f.get("/health",($)=>{return $.json({ok:!0,timestamp:new Date().toISOString()})}),f.post("/check",async($)=>{let z=await $.req.json(),{identifier:P,platform:J="whatsapp"}=z;if(!P)return $.json({error:"identifier is required"},400);let Q=o(P,J),G=!Q.allowed?"deny":Q.trust==="limited"?"limited":"allow";return a(P,J,G,Q.reason),$.json(Q)}),f.get("/contacts",($)=>{let z=$.req.query("platform"),P=$.req.query("trust"),J=p(z,P);return $.json({contacts:J})}),f.post("/contacts",async($)=>{let z=await $.req.json(),{identifier:P,platform:J="whatsapp",trust:Q="trusted",name:G,notes:X}=z;if(!P)return $.json({error:"identifier is required"},400);let Z=d(P,J,Q,G,X);return $.json({contact:Z})}),f.delete("/contacts/:identifier",($)=>{let z=$.req.param("identifier"),P=$.req.query("platform")||"whatsapp",J=n(z,P);return $.json({removed:J})}),f.get("/audit",($)=>{let z=parseInt($.req.query("limit")||"100"),P=$.req.query("decision"),J=e({limit:z,decision:P});return $.json({entries:J})}),f}function V0(f=3847){let $=s1();console.log(`wasp server listening on http://localhost:${f}`),console.log("Endpoints:"),console.log("  POST /check         - Check if contact is allowed"),console.log("  GET  /contacts      - List contacts"),console.log("  POST /contacts      - Add contact"),console.log("  DELETE /contacts/:id - Remove contact"),console.log("  GET  /audit         - View audit log"),console.log("  GET  /health        - Health check"),Bun.serve({port:f,fetch:$.fetch})}function F0(f){if(!x())console.error("wasp is not initialized. Run `wasp init` first."),process.exit(1);let $=f.port||3847;V0($)}var m1="0.0.1";K.name("wasp").description("Security whitelist layer for Moltbot and agentic systems").version(m1);K.command("init").description("Initialize wasp database").option("-f, --force","Reinitialize even if already initialized").action((f)=>{nf(f.force)});K.command("add <identifier>").description("Add a contact to the whitelist").option("-p, --platform <platform>","Platform (whatsapp, telegram, email, discord, slack, signal)","whatsapp").option("-t, --trust <level>","Trust level (sovereign, trusted, limited)","trusted").option("-n, --name <name>","Contact name").option("--notes <notes>","Notes about this contact").action((f,$)=>{O(),of(f,$)});K.command("remove <identifier>").description("Remove a contact from the whitelist").option("-p, --platform <platform>","Platform","whatsapp").action((f,$)=>{O(),af(f,$.platform)});K.command("list").description("List all contacts").option("-p, --platform <platform>","Filter by platform").option("-t, --trust <level>","Filter by trust level").option("-j, --json","Output as JSON").action((f)=>{O(),ef(f)});K.command("check <identifier>").description("Check if a contact is allowed").option("-p, --platform <platform>","Platform","whatsapp").option("-j, --json","Output as JSON").option("-q, --quiet","Exit code only, no output").action((f,$)=>{O(),$0(f,$)});K.command("log").description("View audit log").option("-l, --limit <number>","Number of entries to show","50").option("-d, --denied","Show only denied entries").option("-j, --json","Output as JSON").action((f)=>{O(),z0({...f,limit:parseInt(f.limit)})});K.command("serve").description("Start HTTP server for Moltbot integration").option("-p, --port <number>","Port to listen on","3847").action((f)=>{O(),F0({port:parseInt(f.port)})});function O(){if(!x())console.log("wasp is not initialized. Initializing now..."),r(),console.log("")}K.parse();
