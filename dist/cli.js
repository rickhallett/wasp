#!/usr/bin/env node
// @bun
var V0=Object.create;var{getPrototypeOf:F0,defineProperty:Df,getOwnPropertyNames:D0}=Object;var H0=Object.prototype.hasOwnProperty;var q0=(f,$,z)=>{z=f!=null?V0(F0(f)):{};let P=$||!f||!f.__esModule?Df(z,"default",{value:f,enumerable:!0}):z;for(let J of D0(f))if(!H0.call(P,J))Df(P,J,{get:()=>f[J],enumerable:!0});return P};var D=(f,$)=>()=>($||f(($={exports:{}}).exports,$),$.exports);var O=import.meta.require;var b=D((w0)=>{class Gf extends Error{constructor(f,$,z){super(z);Error.captureStackTrace(this,this.constructor),this.name=this.constructor.name,this.code=$,this.exitCode=f,this.nestedError=void 0}}class Hf extends Gf{constructor(f){super(1,"commander.invalidArgument",f);Error.captureStackTrace(this,this.constructor),this.name=this.constructor.name}}w0.CommanderError=Gf;w0.InvalidArgumentError=Hf});var l=D((b0)=>{var{InvalidArgumentError:x0}=b();class qf{constructor(f,$){switch(this.description=$||"",this.variadic=!1,this.parseArg=void 0,this.defaultValue=void 0,this.defaultValueDescription=void 0,this.argChoices=void 0,f[0]){case"<":this.required=!0,this._name=f.slice(1,-1);break;case"[":this.required=!1,this._name=f.slice(1,-1);break;default:this.required=!0,this._name=f;break}if(this._name.length>3&&this._name.slice(-3)==="...")this.variadic=!0,this._name=this._name.slice(0,-3)}name(){return this._name}_concatValue(f,$){if($===this.defaultValue||!Array.isArray($))return[f];return $.concat(f)}default(f,$){return this.defaultValue=f,this.defaultValueDescription=$,this}argParser(f){return this.parseArg=f,this}choices(f){return this.argChoices=f.slice(),this.parseArg=($,z)=>{if(!this.argChoices.includes($))throw new x0(`Allowed choices are ${this.argChoices.join(", ")}.`);if(this.variadic)return this._concatValue($,z);return $},this}argRequired(){return this.required=!0,this}argOptional(){return this.required=!1,this}}function O0(f){let $=f.name()+(f.variadic===!0?"...":"");return f.required?"<"+$+">":"["+$+"]"}b0.Argument=qf;b0.humanReadableArgName=O0});var Xf=D((u0)=>{var{humanReadableArgName:v0}=l();class wf{constructor(){this.helpWidth=void 0,this.sortSubcommands=!1,this.sortOptions=!1,this.showGlobalOptions=!1}visibleCommands(f){let $=f.commands.filter((P)=>!P._hidden),z=f._getHelpCommand();if(z&&!z._hidden)$.push(z);if(this.sortSubcommands)$.sort((P,J)=>{return P.name().localeCompare(J.name())});return $}compareOptions(f,$){let z=(P)=>{return P.short?P.short.replace(/^-/,""):P.long.replace(/^--/,"")};return z(f).localeCompare(z($))}visibleOptions(f){let $=f.options.filter((P)=>!P.hidden),z=f._getHelpOption();if(z&&!z.hidden){let P=z.short&&f._findOption(z.short),J=z.long&&f._findOption(z.long);if(!P&&!J)$.push(z);else if(z.long&&!J)$.push(f.createOption(z.long,z.description));else if(z.short&&!P)$.push(f.createOption(z.short,z.description))}if(this.sortOptions)$.sort(this.compareOptions);return $}visibleGlobalOptions(f){if(!this.showGlobalOptions)return[];let $=[];for(let z=f.parent;z;z=z.parent){let P=z.options.filter((J)=>!J.hidden);$.push(...P)}if(this.sortOptions)$.sort(this.compareOptions);return $}visibleArguments(f){if(f._argsDescription)f.registeredArguments.forEach(($)=>{$.description=$.description||f._argsDescription[$.name()]||""});if(f.registeredArguments.find(($)=>$.description))return f.registeredArguments;return[]}subcommandTerm(f){let $=f.registeredArguments.map((z)=>v0(z)).join(" ");return f._name+(f._aliases[0]?"|"+f._aliases[0]:"")+(f.options.length?" [options]":"")+($?" "+$:"")}optionTerm(f){return f.flags}argumentTerm(f){return f.name()}longestSubcommandTermLength(f,$){return $.visibleCommands(f).reduce((z,P)=>{return Math.max(z,$.subcommandTerm(P).length)},0)}longestOptionTermLength(f,$){return $.visibleOptions(f).reduce((z,P)=>{return Math.max(z,$.optionTerm(P).length)},0)}longestGlobalOptionTermLength(f,$){return $.visibleGlobalOptions(f).reduce((z,P)=>{return Math.max(z,$.optionTerm(P).length)},0)}longestArgumentTermLength(f,$){return $.visibleArguments(f).reduce((z,P)=>{return Math.max(z,$.argumentTerm(P).length)},0)}commandUsage(f){let $=f._name;if(f._aliases[0])$=$+"|"+f._aliases[0];let z="";for(let P=f.parent;P;P=P.parent)z=P.name()+" "+z;return z+$+" "+f.usage()}commandDescription(f){return f.description()}subcommandDescription(f){return f.summary()||f.description()}optionDescription(f){let $=[];if(f.argChoices)$.push(`choices: ${f.argChoices.map((z)=>JSON.stringify(z)).join(", ")}`);if(f.defaultValue!==void 0){if(f.required||f.optional||f.isBoolean()&&typeof f.defaultValue==="boolean")$.push(`default: ${f.defaultValueDescription||JSON.stringify(f.defaultValue)}`)}if(f.presetArg!==void 0&&f.optional)$.push(`preset: ${JSON.stringify(f.presetArg)}`);if(f.envVar!==void 0)$.push(`env: ${f.envVar}`);if($.length>0)return`${f.description} (${$.join(", ")})`;return f.description}argumentDescription(f){let $=[];if(f.argChoices)$.push(`choices: ${f.argChoices.map((z)=>JSON.stringify(z)).join(", ")}`);if(f.defaultValue!==void 0)$.push(`default: ${f.defaultValueDescription||JSON.stringify(f.defaultValue)}`);if($.length>0){let z=`(${$.join(", ")})`;if(f.description)return`${f.description} ${z}`;return z}return f.description}formatHelp(f,$){let z=$.padWidth(f,$),P=$.helpWidth||80,J=2,Q=2;function X(N,R){if(R){let I=`${N.padEnd(z+2)}${R}`;return $.wrap(I,P-2,z+2)}return N}function G(N){return N.join(`
`).replace(/^/gm," ".repeat(2))}let S=[`Usage: ${$.commandUsage(f)}`,""],Y=$.commandDescription(f);if(Y.length>0)S=S.concat([$.wrap(Y,P,0),""]);let Z=$.visibleArguments(f).map((N)=>{return X($.argumentTerm(N),$.argumentDescription(N))});if(Z.length>0)S=S.concat(["Arguments:",G(Z),""]);let L=$.visibleOptions(f).map((N)=>{return X($.optionTerm(N),$.optionDescription(N))});if(L.length>0)S=S.concat(["Options:",G(L),""]);if(this.showGlobalOptions){let N=$.visibleGlobalOptions(f).map((R)=>{return X($.optionTerm(R),$.optionDescription(R))});if(N.length>0)S=S.concat(["Global Options:",G(N),""])}let E=$.visibleCommands(f).map((N)=>{return X($.subcommandTerm(N),$.subcommandDescription(N))});if(E.length>0)S=S.concat(["Commands:",G(E),""]);return S.join(`
`)}padWidth(f,$){return Math.max($.longestOptionTermLength(f,$),$.longestGlobalOptionTermLength(f,$),$.longestSubcommandTermLength(f,$),$.longestArgumentTermLength(f,$))}wrap(f,$,z,P=40){let Q=new RegExp(`[\\n][${" \\f\\t\\v\xA0\u1680\u2000-\u200A\u202F\u205F\u3000\uFEFF"}]+`);if(f.match(Q))return f;let X=$-z;if(X<P)return f;let G=f.slice(0,z),S=f.slice(z).replace(`\r
`,`
`),Y=" ".repeat(z),L=`\\s${"\u200B"}`,E=new RegExp(`
|.{1,${X-1}}([${L}]|$)|[^${L}]+?([${L}]|$)`,"g"),N=S.match(E)||[];return G+N.map((R,I)=>{if(R===`
`)return"";return(I>0?Y:"")+R.trimEnd()}).join(`
`)}}u0.Help=wf});var Sf=D((i0)=>{var{InvalidArgumentError:c0}=b();class Af{constructor(f,$){this.flags=f,this.description=$||"",this.required=f.includes("<"),this.optional=f.includes("["),this.variadic=/\w\.\.\.[>\]]$/.test(f),this.mandatory=!1;let z=g0(f);if(this.short=z.shortFlag,this.long=z.longFlag,this.negate=!1,this.long)this.negate=this.long.startsWith("--no-");this.defaultValue=void 0,this.defaultValueDescription=void 0,this.presetArg=void 0,this.envVar=void 0,this.parseArg=void 0,this.hidden=!1,this.argChoices=void 0,this.conflictsWith=[],this.implied=void 0}default(f,$){return this.defaultValue=f,this.defaultValueDescription=$,this}preset(f){return this.presetArg=f,this}conflicts(f){return this.conflictsWith=this.conflictsWith.concat(f),this}implies(f){let $=f;if(typeof f==="string")$={[f]:!0};return this.implied=Object.assign(this.implied||{},$),this}env(f){return this.envVar=f,this}argParser(f){return this.parseArg=f,this}makeOptionMandatory(f=!0){return this.mandatory=!!f,this}hideHelp(f=!0){return this.hidden=!!f,this}_concatValue(f,$){if($===this.defaultValue||!Array.isArray($))return[f];return $.concat(f)}choices(f){return this.argChoices=f.slice(),this.parseArg=($,z)=>{if(!this.argChoices.includes($))throw new c0(`Allowed choices are ${this.argChoices.join(", ")}.`);if(this.variadic)return this._concatValue($,z);return $},this}name(){if(this.long)return this.long.replace(/^--/,"");return this.short.replace(/^-/,"")}attributeName(){return l0(this.name().replace(/^no-/,""))}is(f){return this.short===f||this.long===f}isBoolean(){return!this.required&&!this.optional&&!this.negate}}class yf{constructor(f){this.positiveOptions=new Map,this.negativeOptions=new Map,this.dualOptions=new Set,f.forEach(($)=>{if($.negate)this.negativeOptions.set($.attributeName(),$);else this.positiveOptions.set($.attributeName(),$)}),this.negativeOptions.forEach(($,z)=>{if(this.positiveOptions.has(z))this.dualOptions.add(z)})}valueFromOption(f,$){let z=$.attributeName();if(!this.dualOptions.has(z))return!0;let P=this.negativeOptions.get(z).presetArg,J=P!==void 0?P:!1;return $.negate===(J===f)}}function l0(f){return f.split("-").reduce(($,z)=>{return $+z[0].toUpperCase()+z.slice(1)})}function g0(f){let $,z,P=f.split(/[ |,]+/);if(P.length>1&&!/^[[<]/.test(P[1]))$=P.shift();if(z=P.shift(),!$&&/^-[^-]$/.test(z))$=z,z=void 0;return{shortFlag:$,longFlag:z}}i0.Option=Af;i0.DualOptions=yf});var xf=D((t0)=>{function r0(f,$){if(Math.abs(f.length-$.length)>3)return Math.max(f.length,$.length);let z=[];for(let P=0;P<=f.length;P++)z[P]=[P];for(let P=0;P<=$.length;P++)z[0][P]=P;for(let P=1;P<=$.length;P++)for(let J=1;J<=f.length;J++){let Q=1;if(f[J-1]===$[P-1])Q=0;else Q=1;if(z[J][P]=Math.min(z[J-1][P]+1,z[J][P-1]+1,z[J-1][P-1]+Q),J>1&&P>1&&f[J-1]===$[P-2]&&f[J-2]===$[P-1])z[J][P]=Math.min(z[J][P],z[J-2][P-2]+1)}return z[f.length][$.length]}function d0(f,$){if(!$||$.length===0)return"";$=Array.from(new Set($));let z=f.startsWith("--");if(z)f=f.slice(2),$=$.map((X)=>X.slice(2));let P=[],J=3,Q=0.4;if($.forEach((X)=>{if(X.length<=1)return;let G=r0(f,X),S=Math.max(f.length,X.length);if((S-G)/S>Q){if(G<J)J=G,P=[X];else if(G===J)P.push(X)}}),P.sort((X,G)=>X.localeCompare(G)),z)P=P.map((X)=>`--${X}`);if(P.length>1)return`
(Did you mean one of ${P.join(", ")}?)`;if(P.length===1)return`
(Did you mean ${P[0]}?)`;return""}t0.suggestSimilar=d0});var kf=D(($1)=>{var n0=O("events").EventEmitter,Yf=O("child_process"),M=O("path"),Zf=O("fs"),T=O("process"),{Argument:o0,humanReadableArgName:a0}=l(),{CommanderError:Lf}=b(),{Help:e0}=Xf(),{Option:Of,DualOptions:f1}=Sf(),{suggestSimilar:bf}=xf();class Nf extends n0{constructor(f){super();this.commands=[],this.options=[],this.parent=null,this._allowUnknownOption=!1,this._allowExcessArguments=!0,this.registeredArguments=[],this._args=this.registeredArguments,this.args=[],this.rawArgs=[],this.processedArgs=[],this._scriptPath=null,this._name=f||"",this._optionValues={},this._optionValueSources={},this._storeOptionsAsProperties=!1,this._actionHandler=null,this._executableHandler=!1,this._executableFile=null,this._executableDir=null,this._defaultCommandName=null,this._exitCallback=null,this._aliases=[],this._combineFlagAndOptionalValue=!0,this._description="",this._summary="",this._argsDescription=void 0,this._enablePositionalOptions=!1,this._passThroughOptions=!1,this._lifeCycleHooks={},this._showHelpAfterError=!1,this._showSuggestionAfterError=!0,this._outputConfiguration={writeOut:($)=>T.stdout.write($),writeErr:($)=>T.stderr.write($),getOutHelpWidth:()=>T.stdout.isTTY?T.stdout.columns:void 0,getErrHelpWidth:()=>T.stderr.isTTY?T.stderr.columns:void 0,outputError:($,z)=>z($)},this._hidden=!1,this._helpOption=void 0,this._addImplicitHelpCommand=void 0,this._helpCommand=void 0,this._helpConfiguration={}}copyInheritedSettings(f){return this._outputConfiguration=f._outputConfiguration,this._helpOption=f._helpOption,this._helpCommand=f._helpCommand,this._helpConfiguration=f._helpConfiguration,this._exitCallback=f._exitCallback,this._storeOptionsAsProperties=f._storeOptionsAsProperties,this._combineFlagAndOptionalValue=f._combineFlagAndOptionalValue,this._allowExcessArguments=f._allowExcessArguments,this._enablePositionalOptions=f._enablePositionalOptions,this._showHelpAfterError=f._showHelpAfterError,this._showSuggestionAfterError=f._showSuggestionAfterError,this}_getCommandAndAncestors(){let f=[];for(let $=this;$;$=$.parent)f.push($);return f}command(f,$,z){let P=$,J=z;if(typeof P==="object"&&P!==null)J=P,P=null;J=J||{};let[,Q,X]=f.match(/([^ ]+) *(.*)/),G=this.createCommand(Q);if(P)G.description(P),G._executableHandler=!0;if(J.isDefault)this._defaultCommandName=G._name;if(G._hidden=!!(J.noHelp||J.hidden),G._executableFile=J.executableFile||null,X)G.arguments(X);if(this._registerCommand(G),G.parent=this,G.copyInheritedSettings(this),P)return this;return G}createCommand(f){return new Nf(f)}createHelp(){return Object.assign(new e0,this.configureHelp())}configureHelp(f){if(f===void 0)return this._helpConfiguration;return this._helpConfiguration=f,this}configureOutput(f){if(f===void 0)return this._outputConfiguration;return Object.assign(this._outputConfiguration,f),this}showHelpAfterError(f=!0){if(typeof f!=="string")f=!!f;return this._showHelpAfterError=f,this}showSuggestionAfterError(f=!0){return this._showSuggestionAfterError=!!f,this}addCommand(f,$){if(!f._name)throw Error(`Command passed to .addCommand() must have a name
- specify the name in Command constructor or using .name()`);if($=$||{},$.isDefault)this._defaultCommandName=f._name;if($.noHelp||$.hidden)f._hidden=!0;return this._registerCommand(f),f.parent=this,f._checkForBrokenPassThrough(),this}createArgument(f,$){return new o0(f,$)}argument(f,$,z,P){let J=this.createArgument(f,$);if(typeof z==="function")J.default(P).argParser(z);else J.default(z);return this.addArgument(J),this}arguments(f){return f.trim().split(/ +/).forEach(($)=>{this.argument($)}),this}addArgument(f){let $=this.registeredArguments.slice(-1)[0];if($&&$.variadic)throw Error(`only the last argument can be variadic '${$.name()}'`);if(f.required&&f.defaultValue!==void 0&&f.parseArg===void 0)throw Error(`a default value for a required argument is never used: '${f.name()}'`);return this.registeredArguments.push(f),this}helpCommand(f,$){if(typeof f==="boolean")return this._addImplicitHelpCommand=f,this;f=f??"help [command]";let[,z,P]=f.match(/([^ ]+) *(.*)/),J=$??"display help for command",Q=this.createCommand(z);if(Q.helpOption(!1),P)Q.arguments(P);if(J)Q.description(J);return this._addImplicitHelpCommand=!0,this._helpCommand=Q,this}addHelpCommand(f,$){if(typeof f!=="object")return this.helpCommand(f,$),this;return this._addImplicitHelpCommand=!0,this._helpCommand=f,this}_getHelpCommand(){if(this._addImplicitHelpCommand??(this.commands.length&&!this._actionHandler&&!this._findCommand("help"))){if(this._helpCommand===void 0)this.helpCommand(void 0,void 0);return this._helpCommand}return null}hook(f,$){let z=["preSubcommand","preAction","postAction"];if(!z.includes(f))throw Error(`Unexpected value for event passed to hook : '${f}'.
Expecting one of '${z.join("', '")}'`);if(this._lifeCycleHooks[f])this._lifeCycleHooks[f].push($);else this._lifeCycleHooks[f]=[$];return this}exitOverride(f){if(f)this._exitCallback=f;else this._exitCallback=($)=>{if($.code!=="commander.executeSubCommandAsync")throw $};return this}_exit(f,$,z){if(this._exitCallback)this._exitCallback(new Lf(f,$,z));T.exit(f)}action(f){let $=(z)=>{let P=this.registeredArguments.length,J=z.slice(0,P);if(this._storeOptionsAsProperties)J[P]=this;else J[P]=this.opts();return J.push(this),f.apply(this,J)};return this._actionHandler=$,this}createOption(f,$){return new Of(f,$)}_callParseArg(f,$,z,P){try{return f.parseArg($,z)}catch(J){if(J.code==="commander.invalidArgument"){let Q=`${P} ${J.message}`;this.error(Q,{exitCode:J.exitCode,code:J.code})}throw J}}_registerOption(f){let $=f.short&&this._findOption(f.short)||f.long&&this._findOption(f.long);if($){let z=f.long&&this._findOption(f.long)?f.long:f.short;throw Error(`Cannot add option '${f.flags}'${this._name&&` to command '${this._name}'`} due to conflicting flag '${z}'
-  already used by option '${$.flags}'`)}this.options.push(f)}_registerCommand(f){let $=(P)=>{return[P.name()].concat(P.aliases())},z=$(f).find((P)=>this._findCommand(P));if(z){let P=$(this._findCommand(z)).join("|"),J=$(f).join("|");throw Error(`cannot add command '${J}' as already have command '${P}'`)}this.commands.push(f)}addOption(f){this._registerOption(f);let $=f.name(),z=f.attributeName();if(f.negate){let J=f.long.replace(/^--no-/,"--");if(!this._findOption(J))this.setOptionValueWithSource(z,f.defaultValue===void 0?!0:f.defaultValue,"default")}else if(f.defaultValue!==void 0)this.setOptionValueWithSource(z,f.defaultValue,"default");let P=(J,Q,X)=>{if(J==null&&f.presetArg!==void 0)J=f.presetArg;let G=this.getOptionValue(z);if(J!==null&&f.parseArg)J=this._callParseArg(f,J,G,Q);else if(J!==null&&f.variadic)J=f._concatValue(J,G);if(J==null)if(f.negate)J=!1;else if(f.isBoolean()||f.optional)J=!0;else J="";this.setOptionValueWithSource(z,J,X)};if(this.on("option:"+$,(J)=>{let Q=`error: option '${f.flags}' argument '${J}' is invalid.`;P(J,Q,"cli")}),f.envVar)this.on("optionEnv:"+$,(J)=>{let Q=`error: option '${f.flags}' value '${J}' from env '${f.envVar}' is invalid.`;P(J,Q,"env")});return this}_optionEx(f,$,z,P,J){if(typeof $==="object"&&$ instanceof Of)throw Error("To add an Option object use addOption() instead of option() or requiredOption()");let Q=this.createOption($,z);if(Q.makeOptionMandatory(!!f.mandatory),typeof P==="function")Q.default(J).argParser(P);else if(P instanceof RegExp){let X=P;P=(G,S)=>{let Y=X.exec(G);return Y?Y[0]:S},Q.default(J).argParser(P)}else Q.default(P);return this.addOption(Q)}option(f,$,z,P){return this._optionEx({},f,$,z,P)}requiredOption(f,$,z,P){return this._optionEx({mandatory:!0},f,$,z,P)}combineFlagAndOptionalValue(f=!0){return this._combineFlagAndOptionalValue=!!f,this}allowUnknownOption(f=!0){return this._allowUnknownOption=!!f,this}allowExcessArguments(f=!0){return this._allowExcessArguments=!!f,this}enablePositionalOptions(f=!0){return this._enablePositionalOptions=!!f,this}passThroughOptions(f=!0){return this._passThroughOptions=!!f,this._checkForBrokenPassThrough(),this}_checkForBrokenPassThrough(){if(this.parent&&this._passThroughOptions&&!this.parent._enablePositionalOptions)throw Error(`passThroughOptions cannot be used for '${this._name}' without turning on enablePositionalOptions for parent command(s)`)}storeOptionsAsProperties(f=!0){if(this.options.length)throw Error("call .storeOptionsAsProperties() before adding options");if(Object.keys(this._optionValues).length)throw Error("call .storeOptionsAsProperties() before setting option values");return this._storeOptionsAsProperties=!!f,this}getOptionValue(f){if(this._storeOptionsAsProperties)return this[f];return this._optionValues[f]}setOptionValue(f,$){return this.setOptionValueWithSource(f,$,void 0)}setOptionValueWithSource(f,$,z){if(this._storeOptionsAsProperties)this[f]=$;else this._optionValues[f]=$;return this._optionValueSources[f]=z,this}getOptionValueSource(f){return this._optionValueSources[f]}getOptionValueSourceWithGlobals(f){let $;return this._getCommandAndAncestors().forEach((z)=>{if(z.getOptionValueSource(f)!==void 0)$=z.getOptionValueSource(f)}),$}_prepareUserArgs(f,$){if(f!==void 0&&!Array.isArray(f))throw Error("first parameter to parse must be array or undefined");if($=$||{},f===void 0&&$.from===void 0){if(T.versions?.electron)$.from="electron";let P=T.execArgv??[];if(P.includes("-e")||P.includes("--eval")||P.includes("-p")||P.includes("--print"))$.from="eval"}if(f===void 0)f=T.argv;this.rawArgs=f.slice();let z;switch($.from){case void 0:case"node":this._scriptPath=f[1],z=f.slice(2);break;case"electron":if(T.defaultApp)this._scriptPath=f[1],z=f.slice(2);else z=f.slice(1);break;case"user":z=f.slice(0);break;case"eval":z=f.slice(1);break;default:throw Error(`unexpected parse option { from: '${$.from}' }`)}if(!this._name&&this._scriptPath)this.nameFromFilename(this._scriptPath);return this._name=this._name||"program",z}parse(f,$){let z=this._prepareUserArgs(f,$);return this._parseCommand([],z),this}async parseAsync(f,$){let z=this._prepareUserArgs(f,$);return await this._parseCommand([],z),this}_executeSubCommand(f,$){$=$.slice();let z=!1,P=[".js",".ts",".tsx",".mjs",".cjs"];function J(Y,Z){let L=M.resolve(Y,Z);if(Zf.existsSync(L))return L;if(P.includes(M.extname(Z)))return;let E=P.find((N)=>Zf.existsSync(`${L}${N}`));if(E)return`${L}${E}`;return}this._checkForMissingMandatoryOptions(),this._checkForConflictingOptions();let Q=f._executableFile||`${this._name}-${f._name}`,X=this._executableDir||"";if(this._scriptPath){let Y;try{Y=Zf.realpathSync(this._scriptPath)}catch(Z){Y=this._scriptPath}X=M.resolve(M.dirname(Y),X)}if(X){let Y=J(X,Q);if(!Y&&!f._executableFile&&this._scriptPath){let Z=M.basename(this._scriptPath,M.extname(this._scriptPath));if(Z!==this._name)Y=J(X,`${Z}-${f._name}`)}Q=Y||Q}z=P.includes(M.extname(Q));let G;if(T.platform!=="win32")if(z)$.unshift(Q),$=Cf(T.execArgv).concat($),G=Yf.spawn(T.argv[0],$,{stdio:"inherit"});else G=Yf.spawn(Q,$,{stdio:"inherit"});else $.unshift(Q),$=Cf(T.execArgv).concat($),G=Yf.spawn(T.execPath,$,{stdio:"inherit"});if(!G.killed)["SIGUSR1","SIGUSR2","SIGTERM","SIGINT","SIGHUP"].forEach((Z)=>{T.on(Z,()=>{if(G.killed===!1&&G.exitCode===null)G.kill(Z)})});let S=this._exitCallback;G.on("close",(Y)=>{if(Y=Y??1,!S)T.exit(Y);else S(new Lf(Y,"commander.executeSubCommandAsync","(close)"))}),G.on("error",(Y)=>{if(Y.code==="ENOENT"){let Z=X?`searched for local subcommand relative to directory '${X}'`:"no directory for search for local subcommand, use .executableDir() to supply a custom directory",L=`'${Q}' does not exist
 - if '${f._name}' is not meant to be an executable command, remove description parameter from '.command()' and use '.description()' instead
 - if the default executable name is not suitable, use the executableFile option to supply a custom name or path
 - ${Z}`;throw Error(L)}else if(Y.code==="EACCES")throw Error(`'${Q}' not executable`);if(!S)T.exit(1);else{let Z=new Lf(1,"commander.executeSubCommandAsync","(error)");Z.nestedError=Y,S(Z)}}),this.runningCommand=G}_dispatchSubcommand(f,$,z){let P=this._findCommand(f);if(!P)this.help({error:!0});let J;return J=this._chainOrCallSubCommandHook(J,P,"preSubcommand"),J=this._chainOrCall(J,()=>{if(P._executableHandler)this._executeSubCommand(P,$.concat(z));else return P._parseCommand($,z)}),J}_dispatchHelpCommand(f){if(!f)this.help();let $=this._findCommand(f);if($&&!$._executableHandler)$.help();return this._dispatchSubcommand(f,[],[this._getHelpOption()?.long??this._getHelpOption()?.short??"--help"])}_checkNumberOfArguments(){if(this.registeredArguments.forEach((f,$)=>{if(f.required&&this.args[$]==null)this.missingArgument(f.name())}),this.registeredArguments.length>0&&this.registeredArguments[this.registeredArguments.length-1].variadic)return;if(this.args.length>this.registeredArguments.length)this._excessArguments(this.args)}_processArguments(){let f=(z,P,J)=>{let Q=P;if(P!==null&&z.parseArg){let X=`error: command-argument value '${P}' is invalid for argument '${z.name()}'.`;Q=this._callParseArg(z,P,J,X)}return Q};this._checkNumberOfArguments();let $=[];this.registeredArguments.forEach((z,P)=>{let J=z.defaultValue;if(z.variadic){if(P<this.args.length){if(J=this.args.slice(P),z.parseArg)J=J.reduce((Q,X)=>{return f(z,X,Q)},z.defaultValue)}else if(J===void 0)J=[]}else if(P<this.args.length){if(J=this.args[P],z.parseArg)J=f(z,J,z.defaultValue)}$[P]=J}),this.processedArgs=$}_chainOrCall(f,$){if(f&&f.then&&typeof f.then==="function")return f.then(()=>$());return $()}_chainOrCallHooks(f,$){let z=f,P=[];if(this._getCommandAndAncestors().reverse().filter((J)=>J._lifeCycleHooks[$]!==void 0).forEach((J)=>{J._lifeCycleHooks[$].forEach((Q)=>{P.push({hookedCommand:J,callback:Q})})}),$==="postAction")P.reverse();return P.forEach((J)=>{z=this._chainOrCall(z,()=>{return J.callback(J.hookedCommand,this)})}),z}_chainOrCallSubCommandHook(f,$,z){let P=f;if(this._lifeCycleHooks[z]!==void 0)this._lifeCycleHooks[z].forEach((J)=>{P=this._chainOrCall(P,()=>{return J(this,$)})});return P}_parseCommand(f,$){let z=this.parseOptions($);if(this._parseOptionsEnv(),this._parseOptionsImplied(),f=f.concat(z.operands),$=z.unknown,this.args=f.concat($),f&&this._findCommand(f[0]))return this._dispatchSubcommand(f[0],f.slice(1),$);if(this._getHelpCommand()&&f[0]===this._getHelpCommand().name())return this._dispatchHelpCommand(f[1]);if(this._defaultCommandName)return this._outputHelpIfRequested($),this._dispatchSubcommand(this._defaultCommandName,f,$);if(this.commands.length&&this.args.length===0&&!this._actionHandler&&!this._defaultCommandName)this.help({error:!0});this._outputHelpIfRequested(z.unknown),this._checkForMissingMandatoryOptions(),this._checkForConflictingOptions();let P=()=>{if(z.unknown.length>0)this.unknownOption(z.unknown[0])},J=`command:${this.name()}`;if(this._actionHandler){P(),this._processArguments();let Q;if(Q=this._chainOrCallHooks(Q,"preAction"),Q=this._chainOrCall(Q,()=>this._actionHandler(this.processedArgs)),this.parent)Q=this._chainOrCall(Q,()=>{this.parent.emit(J,f,$)});return Q=this._chainOrCallHooks(Q,"postAction"),Q}if(this.parent&&this.parent.listenerCount(J))P(),this._processArguments(),this.parent.emit(J,f,$);else if(f.length){if(this._findCommand("*"))return this._dispatchSubcommand("*",f,$);if(this.listenerCount("command:*"))this.emit("command:*",f,$);else if(this.commands.length)this.unknownCommand();else P(),this._processArguments()}else if(this.commands.length)P(),this.help({error:!0});else P(),this._processArguments()}_findCommand(f){if(!f)return;return this.commands.find(($)=>$._name===f||$._aliases.includes(f))}_findOption(f){return this.options.find(($)=>$.is(f))}_checkForMissingMandatoryOptions(){this._getCommandAndAncestors().forEach((f)=>{f.options.forEach(($)=>{if($.mandatory&&f.getOptionValue($.attributeName())===void 0)f.missingMandatoryOptionValue($)})})}_checkForConflictingLocalOptions(){let f=this.options.filter((z)=>{let P=z.attributeName();if(this.getOptionValue(P)===void 0)return!1;return this.getOptionValueSource(P)!=="default"});f.filter((z)=>z.conflictsWith.length>0).forEach((z)=>{let P=f.find((J)=>z.conflictsWith.includes(J.attributeName()));if(P)this._conflictingOption(z,P)})}_checkForConflictingOptions(){this._getCommandAndAncestors().forEach((f)=>{f._checkForConflictingLocalOptions()})}parseOptions(f){let $=[],z=[],P=$,J=f.slice();function Q(G){return G.length>1&&G[0]==="-"}let X=null;while(J.length){let G=J.shift();if(G==="--"){if(P===z)P.push(G);P.push(...J);break}if(X&&!Q(G)){this.emit(`option:${X.name()}`,G);continue}if(X=null,Q(G)){let S=this._findOption(G);if(S){if(S.required){let Y=J.shift();if(Y===void 0)this.optionMissingArgument(S);this.emit(`option:${S.name()}`,Y)}else if(S.optional){let Y=null;if(J.length>0&&!Q(J[0]))Y=J.shift();this.emit(`option:${S.name()}`,Y)}else this.emit(`option:${S.name()}`);X=S.variadic?S:null;continue}}if(G.length>2&&G[0]==="-"&&G[1]!=="-"){let S=this._findOption(`-${G[1]}`);if(S){if(S.required||S.optional&&this._combineFlagAndOptionalValue)this.emit(`option:${S.name()}`,G.slice(2));else this.emit(`option:${S.name()}`),J.unshift(`-${G.slice(2)}`);continue}}if(/^--[^=]+=/.test(G)){let S=G.indexOf("="),Y=this._findOption(G.slice(0,S));if(Y&&(Y.required||Y.optional)){this.emit(`option:${Y.name()}`,G.slice(S+1));continue}}if(Q(G))P=z;if((this._enablePositionalOptions||this._passThroughOptions)&&$.length===0&&z.length===0){if(this._findCommand(G)){if($.push(G),J.length>0)z.push(...J);break}else if(this._getHelpCommand()&&G===this._getHelpCommand().name()){if($.push(G),J.length>0)$.push(...J);break}else if(this._defaultCommandName){if(z.push(G),J.length>0)z.push(...J);break}}if(this._passThroughOptions){if(P.push(G),J.length>0)P.push(...J);break}P.push(G)}return{operands:$,unknown:z}}opts(){if(this._storeOptionsAsProperties){let f={},$=this.options.length;for(let z=0;z<$;z++){let P=this.options[z].attributeName();f[P]=P===this._versionOptionName?this._version:this[P]}return f}return this._optionValues}optsWithGlobals(){return this._getCommandAndAncestors().reduce((f,$)=>Object.assign(f,$.opts()),{})}error(f,$){if(this._outputConfiguration.outputError(`${f}
`,this._outputConfiguration.writeErr),typeof this._showHelpAfterError==="string")this._outputConfiguration.writeErr(`${this._showHelpAfterError}
`);else if(this._showHelpAfterError)this._outputConfiguration.writeErr(`
`),this.outputHelp({error:!0});let z=$||{},P=z.exitCode||1,J=z.code||"commander.error";this._exit(P,J,f)}_parseOptionsEnv(){this.options.forEach((f)=>{if(f.envVar&&f.envVar in T.env){let $=f.attributeName();if(this.getOptionValue($)===void 0||["default","config","env"].includes(this.getOptionValueSource($)))if(f.required||f.optional)this.emit(`optionEnv:${f.name()}`,T.env[f.envVar]);else this.emit(`optionEnv:${f.name()}`)}})}_parseOptionsImplied(){let f=new f1(this.options),$=(z)=>{return this.getOptionValue(z)!==void 0&&!["default","implied"].includes(this.getOptionValueSource(z))};this.options.filter((z)=>z.implied!==void 0&&$(z.attributeName())&&f.valueFromOption(this.getOptionValue(z.attributeName()),z)).forEach((z)=>{Object.keys(z.implied).filter((P)=>!$(P)).forEach((P)=>{this.setOptionValueWithSource(P,z.implied[P],"implied")})})}missingArgument(f){let $=`error: missing required argument '${f}'`;this.error($,{code:"commander.missingArgument"})}optionMissingArgument(f){let $=`error: option '${f.flags}' argument missing`;this.error($,{code:"commander.optionMissingArgument"})}missingMandatoryOptionValue(f){let $=`error: required option '${f.flags}' not specified`;this.error($,{code:"commander.missingMandatoryOptionValue"})}_conflictingOption(f,$){let z=(Q)=>{let X=Q.attributeName(),G=this.getOptionValue(X),S=this.options.find((Z)=>Z.negate&&X===Z.attributeName()),Y=this.options.find((Z)=>!Z.negate&&X===Z.attributeName());if(S&&(S.presetArg===void 0&&G===!1||S.presetArg!==void 0&&G===S.presetArg))return S;return Y||Q},P=(Q)=>{let X=z(Q),G=X.attributeName();if(this.getOptionValueSource(G)==="env")return`environment variable '${X.envVar}'`;return`option '${X.flags}'`},J=`error: ${P(f)} cannot be used with ${P($)}`;this.error(J,{code:"commander.conflictingOption"})}unknownOption(f){if(this._allowUnknownOption)return;let $="";if(f.startsWith("--")&&this._showSuggestionAfterError){let P=[],J=this;do{let Q=J.createHelp().visibleOptions(J).filter((X)=>X.long).map((X)=>X.long);P=P.concat(Q),J=J.parent}while(J&&!J._enablePositionalOptions);$=bf(f,P)}let z=`error: unknown option '${f}'${$}`;this.error(z,{code:"commander.unknownOption"})}_excessArguments(f){if(this._allowExcessArguments)return;let $=this.registeredArguments.length,z=$===1?"":"s",J=`error: too many arguments${this.parent?` for '${this.name()}'`:""}. Expected ${$} argument${z} but got ${f.length}.`;this.error(J,{code:"commander.excessArguments"})}unknownCommand(){let f=this.args[0],$="";if(this._showSuggestionAfterError){let P=[];this.createHelp().visibleCommands(this).forEach((J)=>{if(P.push(J.name()),J.alias())P.push(J.alias())}),$=bf(f,P)}let z=`error: unknown command '${f}'${$}`;this.error(z,{code:"commander.unknownCommand"})}version(f,$,z){if(f===void 0)return this._version;this._version=f,$=$||"-V, --version",z=z||"output the version number";let P=this.createOption($,z);return this._versionOptionName=P.attributeName(),this._registerOption(P),this.on("option:"+P.name(),()=>{this._outputConfiguration.writeOut(`${f}
`),this._exit(0,"commander.version",f)}),this}description(f,$){if(f===void 0&&$===void 0)return this._description;if(this._description=f,$)this._argsDescription=$;return this}summary(f){if(f===void 0)return this._summary;return this._summary=f,this}alias(f){if(f===void 0)return this._aliases[0];let $=this;if(this.commands.length!==0&&this.commands[this.commands.length-1]._executableHandler)$=this.commands[this.commands.length-1];if(f===$._name)throw Error("Command alias can't be the same as its name");let z=this.parent?._findCommand(f);if(z){let P=[z.name()].concat(z.aliases()).join("|");throw Error(`cannot add alias '${f}' to command '${this.name()}' as already have command '${P}'`)}return $._aliases.push(f),this}aliases(f){if(f===void 0)return this._aliases;return f.forEach(($)=>this.alias($)),this}usage(f){if(f===void 0){if(this._usage)return this._usage;let $=this.registeredArguments.map((z)=>{return a0(z)});return[].concat(this.options.length||this._helpOption!==null?"[options]":[],this.commands.length?"[command]":[],this.registeredArguments.length?$:[]).join(" ")}return this._usage=f,this}name(f){if(f===void 0)return this._name;return this._name=f,this}nameFromFilename(f){return this._name=M.basename(f,M.extname(f)),this}executableDir(f){if(f===void 0)return this._executableDir;return this._executableDir=f,this}helpInformation(f){let $=this.createHelp();if($.helpWidth===void 0)$.helpWidth=f&&f.error?this._outputConfiguration.getErrHelpWidth():this._outputConfiguration.getOutHelpWidth();return $.formatHelp(this,$)}_getHelpContext(f){f=f||{};let $={error:!!f.error},z;if($.error)z=(P)=>this._outputConfiguration.writeErr(P);else z=(P)=>this._outputConfiguration.writeOut(P);return $.write=f.write||z,$.command=this,$}outputHelp(f){let $;if(typeof f==="function")$=f,f=void 0;let z=this._getHelpContext(f);this._getCommandAndAncestors().reverse().forEach((J)=>J.emit("beforeAllHelp",z)),this.emit("beforeHelp",z);let P=this.helpInformation(z);if($){if(P=$(P),typeof P!=="string"&&!Buffer.isBuffer(P))throw Error("outputHelp callback must return a string or a Buffer")}if(z.write(P),this._getHelpOption()?.long)this.emit(this._getHelpOption().long);this.emit("afterHelp",z),this._getCommandAndAncestors().forEach((J)=>J.emit("afterAllHelp",z))}helpOption(f,$){if(typeof f==="boolean"){if(f)this._helpOption=this._helpOption??void 0;else this._helpOption=null;return this}return f=f??"-h, --help",$=$??"display help for command",this._helpOption=this.createOption(f,$),this}_getHelpOption(){if(this._helpOption===void 0)this.helpOption(void 0,void 0);return this._helpOption}addHelpOption(f){return this._helpOption=f,this}help(f){this.outputHelp(f);let $=T.exitCode||0;if($===0&&f&&typeof f!=="function"&&f.error)$=1;this._exit($,"commander.help","(outputHelp)")}addHelpText(f,$){let z=["beforeAll","before","after","afterAll"];if(!z.includes(f))throw Error(`Unexpected value for position to addHelpText.
Expecting one of '${z.join("', '")}'`);let P=`${f}Help`;return this.on(P,(J)=>{let Q;if(typeof $==="function")Q=$({error:J.error,command:J.command});else Q=$;if(Q)J.write(`${Q}
`)}),this}_outputHelpIfRequested(f){let $=this._getHelpOption();if($&&f.find((P)=>$.is(P)))this.outputHelp(),this._exit(0,"commander.helpDisplayed","(outputHelp)")}}function Cf(f){return f.map(($)=>{if(!$.startsWith("--inspect"))return $;let z,P="127.0.0.1",J="9229",Q;if((Q=$.match(/^(--inspect(-brk)?)$/))!==null)z=Q[1];else if((Q=$.match(/^(--inspect(-brk|-port)?)=([^:]+)$/))!==null)if(z=Q[1],/^\d+$/.test(Q[3]))J=Q[3];else P=Q[3];else if((Q=$.match(/^(--inspect(-brk|-port)?)=([^:]+):(\d+)$/))!==null)z=Q[1],P=Q[3],J=Q[4];if(z&&J!=="0")return`${z}=${P}:${parseInt(J)+1}`;return $})}$1.Command=Nf});var cf=D((Q1)=>{var{Argument:vf}=l(),{Command:Ef}=kf(),{CommanderError:P1,InvalidArgumentError:uf}=b(),{Help:J1}=Xf(),{Option:hf}=Sf();Q1.program=new Ef;Q1.createCommand=(f)=>new Ef(f);Q1.createOption=(f,$)=>new hf(f,$);Q1.createArgument=(f,$)=>new vf(f,$);Q1.Command=Ef;Q1.Option=hf;Q1.Argument=vf;Q1.Help=J1;Q1.CommanderError=P1;Q1.InvalidArgumentError=uf;Q1.InvalidOptionArgumentError=uf});var lf=q0(cf(),1),{program:B,createCommand:t1,createArgument:p1,createOption:n1,CommanderError:o1,InvalidArgumentError:a1,InvalidOptionArgumentError:e1,Command:f$,Argument:$$,Option:z$,Help:P$}=lf.default;import{Database as R1}from"bun:sqlite";import{existsSync as gf,mkdirSync as U1}from"fs";import{homedir as j1}from"os";import{join as sf}from"path";var i=process.env.WASP_DATA_DIR||sf(j1(),".wasp"),mf=sf(i,"wasp.db"),g=null;function Wf(){return i}function w(){return gf(mf)}function _(){if(!g){if(!gf(i))U1(i,{recursive:!0});g=new R1(mf),g.exec("PRAGMA journal_mode = WAL")}return g}function s(){_().exec(`
    CREATE TABLE IF NOT EXISTS contacts (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      identifier TEXT NOT NULL,
      platform TEXT NOT NULL DEFAULT 'whatsapp',
      name TEXT,
      trust TEXT NOT NULL DEFAULT 'trusted',
      added_at TEXT NOT NULL DEFAULT (datetime('now')),
      notes TEXT,
      UNIQUE(identifier, platform)
    );

    CREATE TABLE IF NOT EXISTS audit_log (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      timestamp TEXT NOT NULL DEFAULT (datetime('now')),
      identifier TEXT NOT NULL,
      platform TEXT NOT NULL,
      decision TEXT NOT NULL,
      reason TEXT
    );

    CREATE INDEX IF NOT EXISTS idx_contacts_identifier ON contacts(identifier);
    CREATE INDEX IF NOT EXISTS idx_audit_timestamp ON audit_log(timestamp);
  `)}function rf(f=!1){if(w()&&!f){console.log("wasp is already initialized."),console.log(`Data directory: ${Wf()}`),console.log("Use --force to reinitialize.");return}s(),console.log("wasp initialized successfully."),console.log(`Data directory: ${Wf()}`),console.log(""),console.log("Next steps:"),console.log('  wasp add "+440123456789" --name "Your Name" --trust sovereign'),console.log("  wasp list"),console.log("  wasp serve")}function m(f,$="whatsapp",z="trusted",P,J){let Q=_();Q.prepare(`
    INSERT INTO contacts (identifier, platform, trust, name, notes)
    VALUES (?, ?, ?, ?, ?)
    ON CONFLICT(identifier, platform) DO UPDATE SET
      trust = excluded.trust,
      name = COALESCE(excluded.name, contacts.name),
      notes = COALESCE(excluded.notes, contacts.notes)
  `).run(f,$,z,P||null,J||null);let G=Q.prepare("SELECT * FROM contacts WHERE identifier = ? AND platform = ?").get(f,$);return{id:G.id,identifier:G.identifier,platform:G.platform,name:G.name,trust:G.trust,addedAt:G.added_at,notes:G.notes}}function r(f,$="whatsapp"){return _().prepare("DELETE FROM contacts WHERE identifier = ? AND platform = ?").run(f,$).changes>0}function B1(f,$="whatsapp"){let J=_().prepare("SELECT * FROM contacts WHERE identifier = ? AND platform = ?").get(f,$);if(!J)return null;return{id:J.id,identifier:J.identifier,platform:J.platform,name:J.name,trust:J.trust,addedAt:J.added_at,notes:J.notes}}function d(f,$){let z=_(),P="SELECT * FROM contacts WHERE 1=1",J=[];if(f)P+=" AND platform = ?",J.push(f);if($)P+=" AND trust = ?",J.push($);return P+=" ORDER BY added_at DESC",z.prepare(P).all(...J).map((G)=>({id:G.id,identifier:G.identifier,platform:G.platform,name:G.name,trust:G.trust,addedAt:G.added_at,notes:G.notes}))}function t(f,$="whatsapp"){let z=B1(f,$);if(!z)return{allowed:!1,trust:null,name:null,reason:"Contact not in whitelist"};if(z.trust==="limited")return{allowed:!0,trust:"limited",name:z.name,reason:"Limited trust - agent may view but should not act"};return{allowed:!0,trust:z.trust,name:z.name,reason:"Contact is trusted"}}function df(f,$){let z=m(f,$.platform||"whatsapp",$.trust||"trusted",$.name,$.notes);if(console.log("Contact added/updated:"),console.log(`  Identifier: ${z.identifier}`),console.log(`  Platform:   ${z.platform}`),console.log(`  Trust:      ${z.trust}`),z.name)console.log(`  Name:       ${z.name}`);if(z.notes)console.log(`  Notes:      ${z.notes}`)}function tf(f,$="whatsapp"){if(r(f,$))console.log(`Removed: ${f} (${$})`);else console.log(`Not found: ${f} (${$})`)}function pf(f){let $=d(f.platform,f.trust);if($.length===0){console.log("No contacts found.");return}if(f.json){console.log(JSON.stringify($,null,2));return}console.log(`Found ${$.length} contact(s):
`);for(let z of $){let P=z.name?` (${z.name})`:"";if(console.log(`  ${z.identifier}${P}`),console.log(`    Platform: ${z.platform} | Trust: ${z.trust}`),z.notes)console.log(`    Notes: ${z.notes}`);console.log("")}}function p(f,$,z,P){_().prepare(`
    INSERT INTO audit_log (identifier, platform, decision, reason)
    VALUES (?, ?, ?, ?)
  `).run(f,$,z,P)}function n(f){let $=_(),z="SELECT * FROM audit_log WHERE 1=1",P=[];if(f.decision)z+=" AND decision = ?",P.push(f.decision);if(f.since)z+=" AND timestamp >= ?",P.push(f.since);if(z+=" ORDER BY timestamp DESC",f.limit)z+=" LIMIT ?",P.push(f.limit);return $.prepare(z).all(...P).map((X)=>({id:X.id,timestamp:X.timestamp,identifier:X.identifier,platform:X.platform,decision:X.decision,reason:X.reason}))}function nf(f,$){let z=$.platform||"whatsapp",P=t(f,z),J=!P.allowed?"deny":P.trust==="limited"?"limited":"allow";if(p(f,z,J,P.reason),$.json){console.log(JSON.stringify(P)),process.exit(P.allowed?0:1);return}if($.quiet){process.exit(P.allowed?0:1);return}if(P.allowed){let Q=P.name?` (${P.name})`:"";if(console.log(`ALLOWED: ${f}${Q}`),console.log(`  Trust level: ${P.trust}`),P.trust==="limited")console.log("  Note: Limited trust - agent may view but should not act")}else console.log(`DENIED: ${f}`),console.log(`  Reason: ${P.reason}`);process.exit(P.allowed?0:1)}function of(f){let $=n({limit:f.limit||50,decision:f.denied?"deny":void 0});if($.length===0){console.log("No audit entries found.");return}if(f.json){console.log(JSON.stringify($,null,2));return}console.log(`Last ${$.length} audit entries:
`);for(let z of $){let P=z.decision==="allow"?"\u2713":z.decision==="limited"?"~":"\u2717";console.log(`  ${P} ${z.timestamp} | ${z.identifier} (${z.platform})`),console.log(`    Decision: ${z.decision} - ${z.reason}`),console.log("")}}var If=(f,$,z)=>{return(P,J)=>{let Q=-1;return X(0);async function X(G){if(G<=Q)throw Error("next() called multiple times");Q=G;let S,Y=!1,Z;if(f[G])Z=f[G][0][0],P.req.routeIndex=G;else Z=G===f.length&&J||void 0;if(Z)try{S=await Z(P,()=>X(G+1))}catch(L){if(L instanceof Error&&$)P.error=L,S=await $(L,P),Y=!0;else throw L}else if(P.finalized===!1&&z)S=await z(P);if(S&&(P.finalized===!1||Y))P.res=S;return P}}};var af=Symbol();var ef=async(f,$=Object.create(null))=>{let{all:z=!1,dot:P=!1}=$,Q=(f instanceof o?f.raw.headers:f.headers).get("Content-Type");if(Q?.startsWith("multipart/form-data")||Q?.startsWith("application/x-www-form-urlencoded"))return K1(f,{all:z,dot:P});return{}};async function K1(f,$){let z=await f.formData();if(z)return M1(z,$);return{}}function M1(f,$){let z=Object.create(null);if(f.forEach((P,J)=>{if(!($.all||J.endsWith("[]")))z[J]=P;else _1(z,J,P)}),$.dot)Object.entries(z).forEach(([P,J])=>{if(P.includes("."))V1(z,P,J),delete z[P]});return z}var _1=(f,$,z)=>{if(f[$]!==void 0)if(Array.isArray(f[$]))f[$].push(z);else f[$]=[f[$],z];else if(!$.endsWith("[]"))f[$]=z;else f[$]=[z]},V1=(f,$,z)=>{let P=f,J=$.split(".");J.forEach((Q,X)=>{if(X===J.length-1)P[Q]=z;else{if(!P[Q]||typeof P[Q]!=="object"||Array.isArray(P[Q])||P[Q]instanceof File)P[Q]=Object.create(null);P=P[Q]}})};var Rf=(f)=>{let $=f.split("/");if($[0]==="")$.shift();return $},f0=(f)=>{let{groups:$,path:z}=F1(f),P=Rf(z);return D1(P,$)},F1=(f)=>{let $=[];return f=f.replace(/\{[^}]+\}/g,(z,P)=>{let J=`@${P}`;return $.push([J,z]),J}),{groups:$,path:f}},D1=(f,$)=>{for(let z=$.length-1;z>=0;z--){let[P]=$[z];for(let J=f.length-1;J>=0;J--)if(f[J].includes(P)){f[J]=f[J].replace(P,$[z][1]);break}}return f},a={},$0=(f,$)=>{if(f==="*")return"*";let z=f.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(z){let P=`${f}#${$}`;if(!a[P])if(z[2])a[P]=$&&$[0]!==":"&&$[0]!=="*"?[P,z[1],new RegExp(`^${z[2]}(?=/${$})`)]:[f,z[1],new RegExp(`^${z[2]}$`)];else a[P]=[f,z[1],!0];return a[P]}return null},e=(f,$)=>{try{return $(f)}catch{return f.replace(/(?:%[0-9A-Fa-f]{2})+/g,(z)=>{try{return $(z)}catch{return z}})}},H1=(f)=>e(f,decodeURI),Uf=(f)=>{let $=f.url,z=$.indexOf("/",$.indexOf(":")+4),P=z;for(;P<$.length;P++){let J=$.charCodeAt(P);if(J===37){let Q=$.indexOf("?",P),X=$.slice(z,Q===-1?void 0:Q);return H1(X.includes("%25")?X.replace(/%25/g,"%2525"):X)}else if(J===63)break}return $.slice(z,P)};var z0=(f)=>{let $=Uf(f);return $.length>1&&$.at(-1)==="/"?$.slice(0,-1):$},H=(f,$,...z)=>{if(z.length)$=H($,...z);return`${f?.[0]==="/"?"":"/"}${f}${$==="/"?"":`${f?.at(-1)==="/"?"":"/"}${$?.[0]==="/"?$.slice(1):$}`}`},ff=(f)=>{if(f.charCodeAt(f.length-1)!==63||!f.includes(":"))return null;let $=f.split("/"),z=[],P="";return $.forEach((J)=>{if(J!==""&&!/\:/.test(J))P+="/"+J;else if(/\:/.test(J))if(/\?/.test(J)){if(z.length===0&&P==="")z.push("/");else z.push(P);let Q=J.replace("?","");P+="/"+Q,z.push(P)}else P+="/"+J}),z.filter((J,Q,X)=>X.indexOf(J)===Q)},Tf=(f)=>{if(!/[%+]/.test(f))return f;if(f.indexOf("+")!==-1)f=f.replace(/\+/g," ");return f.indexOf("%")!==-1?e(f,jf):f},P0=(f,$,z)=>{let P;if(!z&&$&&!/[%+]/.test($)){let X=f.indexOf("?",8);if(X===-1)return;if(!f.startsWith($,X+1))X=f.indexOf(`&${$}`,X+1);while(X!==-1){let G=f.charCodeAt(X+$.length+1);if(G===61){let S=X+$.length+2,Y=f.indexOf("&",S);return Tf(f.slice(S,Y===-1?void 0:Y))}else if(G==38||isNaN(G))return"";X=f.indexOf(`&${$}`,X+1)}if(P=/[%+]/.test(f),!P)return}let J={};P??=/[%+]/.test(f);let Q=f.indexOf("?",8);while(Q!==-1){let X=f.indexOf("&",Q+1),G=f.indexOf("=",Q);if(G>X&&X!==-1)G=-1;let S=f.slice(Q+1,G===-1?X===-1?void 0:X:G);if(P)S=Tf(S);if(Q=X,S==="")continue;let Y;if(G===-1)Y="";else if(Y=f.slice(G+1,X===-1?void 0:X),P)Y=Tf(Y);if(z){if(!(J[S]&&Array.isArray(J[S])))J[S]=[];J[S].push(Y)}else J[S]??=Y}return $?J[$]:J},J0=P0,Q0=(f,$)=>{return P0(f,$,!0)},jf=decodeURIComponent;var G0=(f)=>e(f,jf),o=class{raw;#f;#$;routeIndex=0;path;bodyCache={};constructor(f,$="/",z=[[]]){this.raw=f,this.path=$,this.#$=z,this.#f={}}param(f){return f?this.#z(f):this.#Q()}#z(f){let $=this.#$[0][this.routeIndex][1][f],z=this.#J($);return z&&/\%/.test(z)?G0(z):z}#Q(){let f={},$=Object.keys(this.#$[0][this.routeIndex][1]);for(let z of $){let P=this.#J(this.#$[0][this.routeIndex][1][z]);if(P!==void 0)f[z]=/\%/.test(P)?G0(P):P}return f}#J(f){return this.#$[1]?this.#$[1][f]:f}query(f){return J0(this.url,f)}queries(f){return Q0(this.url,f)}header(f){if(f)return this.raw.headers.get(f)??void 0;let $={};return this.raw.headers.forEach((z,P)=>{$[P]=z}),$}async parseBody(f){return this.bodyCache.parsedBody??=await ef(this,f)}#P=(f)=>{let{bodyCache:$,raw:z}=this,P=$[f];if(P)return P;let J=Object.keys($)[0];if(J)return $[J].then((Q)=>{if(J==="json")Q=JSON.stringify(Q);return new Response(Q)[f]()});return $[f]=z[f]()};json(){return this.#P("text").then((f)=>JSON.parse(f))}text(){return this.#P("text")}arrayBuffer(){return this.#P("arrayBuffer")}blob(){return this.#P("blob")}formData(){return this.#P("formData")}addValidatedData(f,$){this.#f[f]=$}valid(f){return this.#f[f]}get url(){return this.raw.url}get method(){return this.raw.method}get[af](){return this.#$}get matchedRoutes(){return this.#$[0].map(([[,f]])=>f)}get routePath(){return this.#$[0].map(([[,f]])=>f)[this.routeIndex].path}};var X0={Stringify:1,BeforeStream:2,Stream:3},q1=(f,$)=>{let z=new String(f);return z.isEscaped=!0,z.callbacks=$,z};var Bf=async(f,$,z,P,J)=>{if(typeof f==="object"&&!(f instanceof String)){if(!(f instanceof Promise))f=f.toString();if(f instanceof Promise)f=await f}let Q=f.callbacks;if(!Q?.length)return Promise.resolve(f);if(J)J[0]+=f;else J=[f];let X=Promise.all(Q.map((G)=>G({phase:$,buffer:J,context:P}))).then((G)=>Promise.all(G.filter(Boolean).map((S)=>Bf(S,$,!1,P,J))).then(()=>J[0]));if(z)return q1(await X,Q);else return X};var w1="text/plain; charset=UTF-8",Kf=(f,$)=>{return{"Content-Type":f,...$}},S0=class{#f;#$;env={};#z;finalized=!1;error;#Q;#J;#P;#Z;#S;#Y;#X;#L;#N;constructor(f,$){if(this.#f=f,$)this.#J=$.executionCtx,this.env=$.env,this.#Y=$.notFoundHandler,this.#N=$.path,this.#L=$.matchResult}get req(){return this.#$??=new o(this.#f,this.#N,this.#L),this.#$}get event(){if(this.#J&&"respondWith"in this.#J)return this.#J;else throw Error("This context has no FetchEvent")}get executionCtx(){if(this.#J)return this.#J;else throw Error("This context has no ExecutionContext")}get res(){return this.#P||=new Response(null,{headers:this.#X??=new Headers})}set res(f){if(this.#P&&f){f=new Response(f.body,f);for(let[$,z]of this.#P.headers.entries()){if($==="content-type")continue;if($==="set-cookie"){let P=this.#P.headers.getSetCookie();f.headers.delete("set-cookie");for(let J of P)f.headers.append("set-cookie",J)}else f.headers.set($,z)}}this.#P=f,this.finalized=!0}render=(...f)=>{return this.#S??=($)=>this.html($),this.#S(...f)};setLayout=(f)=>this.#Z=f;getLayout=()=>this.#Z;setRenderer=(f)=>{this.#S=f};header=(f,$,z)=>{if(this.finalized)this.#P=new Response(this.#P.body,this.#P);let P=this.#P?this.#P.headers:this.#X??=new Headers;if($===void 0)P.delete(f);else if(z?.append)P.append(f,$);else P.set(f,$)};status=(f)=>{this.#Q=f};set=(f,$)=>{this.#z??=new Map,this.#z.set(f,$)};get=(f)=>{return this.#z?this.#z.get(f):void 0};get var(){if(!this.#z)return{};return Object.fromEntries(this.#z)}#G(f,$,z){let P=this.#P?new Headers(this.#P.headers):this.#X??new Headers;if(typeof $==="object"&&"headers"in $){let Q=$.headers instanceof Headers?$.headers:new Headers($.headers);for(let[X,G]of Q)if(X.toLowerCase()==="set-cookie")P.append(X,G);else P.set(X,G)}if(z)for(let[Q,X]of Object.entries(z))if(typeof X==="string")P.set(Q,X);else{P.delete(Q);for(let G of X)P.append(Q,G)}let J=typeof $==="number"?$:$?.status??this.#Q;return new Response(f,{status:J,headers:P})}newResponse=(...f)=>this.#G(...f);body=(f,$,z)=>this.#G(f,$,z);text=(f,$,z)=>{return!this.#X&&!this.#Q&&!$&&!z&&!this.finalized?new Response(f):this.#G(f,$,Kf(w1,z))};json=(f,$,z)=>{return this.#G(JSON.stringify(f),$,Kf("application/json",z))};html=(f,$,z)=>{let P=(J)=>this.#G(J,$,Kf("text/html; charset=UTF-8",z));return typeof f==="object"?Bf(f,X0.Stringify,!1,{}).then(P):P(f)};redirect=(f,$)=>{let z=String(f);return this.header("Location",!/[^\x00-\xFF]/.test(z)?z:encodeURI(z)),this.newResponse(null,$??302)};notFound=()=>{return this.#Y??=()=>new Response,this.#Y(this)}};var W="ALL",Y0="all",Z0=["get","post","put","delete","options","patch"],$f="Can not add a route since the matcher is already built.",zf=class extends Error{};var L0="__COMPOSED_HANDLER";var A1=(f)=>{return f.text("404 Not Found",404)},N0=(f,$)=>{if("getResponse"in f){let z=f.getResponse();return $.newResponse(z.body,z)}return console.error(f),$.text("Internal Server Error",500)},E0=class f{get;post;put;delete;options;patch;all;on;use;router;getPath;_basePath="/";#f="/";routes=[];constructor($={}){[...Z0,Y0].forEach((Q)=>{this[Q]=(X,...G)=>{if(typeof X==="string")this.#f=X;else this.#Q(Q,this.#f,X);return G.forEach((S)=>{this.#Q(Q,this.#f,S)}),this}}),this.on=(Q,X,...G)=>{for(let S of[X].flat()){this.#f=S;for(let Y of[Q].flat())G.map((Z)=>{this.#Q(Y.toUpperCase(),this.#f,Z)})}return this},this.use=(Q,...X)=>{if(typeof Q==="string")this.#f=Q;else this.#f="*",X.unshift(Q);return X.forEach((G)=>{this.#Q(W,this.#f,G)}),this};let{strict:P,...J}=$;Object.assign(this,J),this.getPath=P??!0?$.getPath??Uf:z0}#$(){let $=new f({router:this.router,getPath:this.getPath});return $.errorHandler=this.errorHandler,$.#z=this.#z,$.routes=this.routes,$}#z=A1;errorHandler=N0;route($,z){let P=this.basePath($);return z.routes.map((J)=>{let Q;if(z.errorHandler===N0)Q=J.handler;else Q=async(X,G)=>(await If([],z.errorHandler)(X,()=>J.handler(X,G))).res,Q[L0]=J.handler;P.#Q(J.method,J.path,Q)}),this}basePath($){let z=this.#$();return z._basePath=H(this._basePath,$),z}onError=($)=>{return this.errorHandler=$,this};notFound=($)=>{return this.#z=$,this};mount($,z,P){let J,Q;if(P)if(typeof P==="function")Q=P;else if(Q=P.optionHandler,P.replaceRequest===!1)J=(S)=>S;else J=P.replaceRequest;let X=Q?(S)=>{let Y=Q(S);return Array.isArray(Y)?Y:[Y]}:(S)=>{let Y=void 0;try{Y=S.executionCtx}catch{}return[S.env,Y]};J||=(()=>{let S=H(this._basePath,$),Y=S==="/"?0:S.length;return(Z)=>{let L=new URL(Z.url);return L.pathname=L.pathname.slice(Y)||"/",new Request(L,Z)}})();let G=async(S,Y)=>{let Z=await z(J(S.req.raw),...X(S));if(Z)return Z;await Y()};return this.#Q(W,H($,"*"),G),this}#Q($,z,P){$=$.toUpperCase(),z=H(this._basePath,z);let J={basePath:this._basePath,path:z,method:$,handler:P};this.router.add($,z,[P,J]),this.routes.push(J)}#J($,z){if($ instanceof Error)return this.errorHandler($,z);throw $}#P($,z,P,J){if(J==="HEAD")return(async()=>new Response(null,await this.#P($,z,P,"GET")))();let Q=this.getPath($,{env:P}),X=this.router.match(J,Q),G=new S0($,{path:Q,matchResult:X,env:P,executionCtx:z,notFoundHandler:this.#z});if(X[0].length===1){let Y;try{Y=X[0][0][0][0](G,async()=>{G.res=await this.#z(G)})}catch(Z){return this.#J(Z,G)}return Y instanceof Promise?Y.then((Z)=>Z||(G.finalized?G.res:this.#z(G))).catch((Z)=>this.#J(Z,G)):Y??this.#z(G)}let S=If(X[0],this.errorHandler,this.#z);return(async()=>{try{let Y=await S(G);if(!Y.finalized)throw Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return Y.res}catch(Y){return this.#J(Y,G)}})()}fetch=($,...z)=>{return this.#P($,z[1],z[0],$.method)};request=($,z,P,J)=>{if($ instanceof Request)return this.fetch(z?new Request($,z):$,P,J);return $=$.toString(),this.fetch(new Request(/^https?:\/\//.test($)?$:`http://localhost${H("/",$)}`,z),P,J)};fire=()=>{addEventListener("fetch",($)=>{$.respondWith(this.#P($.request,$,void 0,$.request.method))})}};var C=[];function Pf(f,$){let z=this.buildAllMatchers(),P=(J,Q)=>{let X=z[J]||z[W],G=X[2][Q];if(G)return G;let S=Q.match(X[0]);if(!S)return[[],C];let Y=S.indexOf("",1);return[X[1][Y],S]};return this.match=P,P(f,$)}var Jf="[^/]+",k=".*",v="(?:|/.*)",q=Symbol(),y1=new Set(".\\+*[^]$()");function x1(f,$){if(f.length===1)return $.length===1?f<$?-1:1:-1;if($.length===1)return 1;if(f===k||f===v)return 1;else if($===k||$===v)return-1;if(f===Jf)return 1;else if($===Jf)return-1;return f.length===$.length?f<$?-1:1:$.length-f.length}var W0=class f{#f;#$;#z=Object.create(null);insert($,z,P,J,Q){if($.length===0){if(this.#f!==void 0)throw q;if(Q)return;this.#f=z;return}let[X,...G]=$,S=X==="*"?G.length===0?["","",k]:["","",Jf]:X==="/*"?["","",v]:X.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/),Y;if(S){let Z=S[1],L=S[2]||Jf;if(Z&&S[2]){if(L===".*")throw q;if(L=L.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(L))throw q}if(Y=this.#z[L],!Y){if(Object.keys(this.#z).some((E)=>E!==k&&E!==v))throw q;if(Q)return;if(Y=this.#z[L]=new f,Z!=="")Y.#$=J.varIndex++}if(!Q&&Z!=="")P.push([Z,Y.#$])}else if(Y=this.#z[X],!Y){if(Object.keys(this.#z).some((Z)=>Z.length>1&&Z!==k&&Z!==v))throw q;if(Q)return;Y=this.#z[X]=new f}Y.insert(G,z,P,J,Q)}buildRegExpStr(){let z=Object.keys(this.#z).sort(x1).map((P)=>{let J=this.#z[P];return(typeof J.#$==="number"?`(${P})@${J.#$}`:y1.has(P)?`\\${P}`:P)+J.buildRegExpStr()});if(typeof this.#f==="number")z.unshift(`#${this.#f}`);if(z.length===0)return"";if(z.length===1)return z[0];return"(?:"+z.join("|")+")"}};var I0=class{#f={varIndex:0};#$=new W0;insert(f,$,z){let P=[],J=[];for(let X=0;;){let G=!1;if(f=f.replace(/\{[^}]+\}/g,(S)=>{let Y=`@\\${X}`;return J[X]=[Y,S],X++,G=!0,Y}),!G)break}let Q=f.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let X=J.length-1;X>=0;X--){let[G]=J[X];for(let S=Q.length-1;S>=0;S--)if(Q[S].indexOf(G)!==-1){Q[S]=Q[S].replace(G,J[X][1]);break}}return this.#$.insert(Q,$,P,this.#f,z),P}buildRegExp(){let f=this.#$.buildRegExpStr();if(f==="")return[/^$/,[],[]];let $=0,z=[],P=[];return f=f.replace(/#(\d+)|@(\d+)|\.\*\$/g,(J,Q,X)=>{if(Q!==void 0)return z[++$]=Number(Q),"$()";if(X!==void 0)return P[Number(X)]=++$,"";return""}),[new RegExp(`^${f}`),z,P]}};var O1=[/^$/,[],Object.create(null)],T0=Object.create(null);function R0(f){return T0[f]??=new RegExp(f==="*"?"":`^${f.replace(/\/\*$|([.\\+*[^\]$()])/g,($,z)=>z?`\\${z}`:"(?:|/.*)")}$`)}function b1(){T0=Object.create(null)}function C1(f){let $=new I0,z=[];if(f.length===0)return O1;let P=f.map((Y)=>[!/\*|\/:/.test(Y[0]),...Y]).sort(([Y,Z],[L,E])=>Y?1:L?-1:Z.length-E.length),J=Object.create(null);for(let Y=0,Z=-1,L=P.length;Y<L;Y++){let[E,N,R]=P[Y];if(E)J[N]=[R.map(([U])=>[U,Object.create(null)]),C];else Z++;let I;try{I=$.insert(N,Z,E)}catch(U){throw U===q?new zf(N):U}if(E)continue;z[Z]=R.map(([U,V])=>{let h=Object.create(null);V-=1;for(;V>=0;V--){let[c,j]=I[V];h[c]=j}return[U,h]})}let[Q,X,G]=$.buildRegExp();for(let Y=0,Z=z.length;Y<Z;Y++)for(let L=0,E=z[Y].length;L<E;L++){let N=z[Y][L]?.[1];if(!N)continue;let R=Object.keys(N);for(let I=0,U=R.length;I<U;I++)N[R[I]]=G[N[R[I]]]}let S=[];for(let Y in X)S[Y]=z[X[Y]];return[Q,S,J]}function A(f,$){if(!f)return;for(let z of Object.keys(f).sort((P,J)=>J.length-P.length))if(R0(z).test($))return[...f[z]];return}var Qf=class{name="RegExpRouter";#f;#$;constructor(){this.#f={[W]:Object.create(null)},this.#$={[W]:Object.create(null)}}add(f,$,z){let P=this.#f,J=this.#$;if(!P||!J)throw Error($f);if(!P[f])[P,J].forEach((G)=>{G[f]=Object.create(null),Object.keys(G[W]).forEach((S)=>{G[f][S]=[...G[W][S]]})});if($==="/*")$="*";let Q=($.match(/\/:/g)||[]).length;if(/\*$/.test($)){let G=R0($);if(f===W)Object.keys(P).forEach((S)=>{P[S][$]||=A(P[S],$)||A(P[W],$)||[]});else P[f][$]||=A(P[f],$)||A(P[W],$)||[];Object.keys(P).forEach((S)=>{if(f===W||f===S)Object.keys(P[S]).forEach((Y)=>{G.test(Y)&&P[S][Y].push([z,Q])})}),Object.keys(J).forEach((S)=>{if(f===W||f===S)Object.keys(J[S]).forEach((Y)=>G.test(Y)&&J[S][Y].push([z,Q]))});return}let X=ff($)||[$];for(let G=0,S=X.length;G<S;G++){let Y=X[G];Object.keys(J).forEach((Z)=>{if(f===W||f===Z)J[Z][Y]||=[...A(P[Z],Y)||A(P[W],Y)||[]],J[Z][Y].push([z,Q-S+G+1])})}}match=Pf;buildAllMatchers(){let f=Object.create(null);return Object.keys(this.#$).concat(Object.keys(this.#f)).forEach(($)=>{f[$]||=this.#z($)}),this.#f=this.#$=void 0,b1(),f}#z(f){let $=[],z=f===W;if([this.#f,this.#$].forEach((P)=>{let J=P[f]?Object.keys(P[f]).map((Q)=>[Q,P[f][Q]]):[];if(J.length!==0)z||=!0,$.push(...J);else if(f!==W)$.push(...Object.keys(P[W]).map((Q)=>[Q,P[W][Q]]))}),!z)return null;else return C1($)}};var k1=class{name="PreparedRegExpRouter";#f;#$;constructor(f,$){this.#f=f,this.#$=$}#z(f,$){let z=this.#f[f];z[1].forEach((P)=>P&&P.push($)),Object.values(z[2]).forEach((P)=>P[0].push($))}#Q(f,$,z,P,J){let Q=this.#f[f];if(!J)Q[2][$][0].push([z,{}]);else P.forEach((X)=>{if(typeof X==="number")Q[1][X].push([z,J]);else Q[2][X||$][0].push([z,J])})}add(f,$,z){if(!this.#f[f]){let J=this.#f[W],Q={};for(let X in J[2])Q[X]=[J[2][X][0].slice(),C];this.#f[f]=[J[0],J[1].map((X)=>Array.isArray(X)?X.slice():0),Q]}if($==="/*"||$==="*"){let J=[z,{}];if(f===W)for(let Q in this.#f)this.#z(Q,J);else this.#z(f,J);return}let P=this.#$[$];if(!P)throw Error(`Path ${$} is not registered`);for(let[J,Q]of P)if(f===W)for(let X in this.#f)this.#Q(X,$,z,J,Q);else this.#Q(f,$,z,J,Q)}buildAllMatchers(){return this.#f}match=Pf};var Mf=class{name="SmartRouter";#f=[];#$=[];constructor(f){this.#f=f.routers}add(f,$,z){if(!this.#$)throw Error($f);this.#$.push([f,$,z])}match(f,$){if(!this.#$)throw Error("Fatal error");let z=this.#f,P=this.#$,J=z.length,Q=0,X;for(;Q<J;Q++){let G=z[Q];try{for(let S=0,Y=P.length;S<Y;S++)G.add(...P[S]);X=G.match(f,$)}catch(S){if(S instanceof zf)continue;throw S}this.match=G.match.bind(G),this.#f=[G],this.#$=void 0;break}if(Q===J)throw Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,X}get activeRouter(){if(this.#$||this.#f.length!==1)throw Error("No active router has been determined yet.");return this.#f[0]}};var u=Object.create(null),U0=class f{#f;#$;#z;#Q=0;#J=u;constructor($,z,P){if(this.#$=P||Object.create(null),this.#f=[],$&&z){let J=Object.create(null);J[$]={handler:z,possibleKeys:[],score:0},this.#f=[J]}this.#z=[]}insert($,z,P){this.#Q=++this.#Q;let J=this,Q=f0(z),X=[];for(let G=0,S=Q.length;G<S;G++){let Y=Q[G],Z=Q[G+1],L=$0(Y,Z),E=Array.isArray(L)?L[0]:Y;if(E in J.#$){if(J=J.#$[E],L)X.push(L[1]);continue}if(J.#$[E]=new f,L)J.#z.push(L),X.push(L[1]);J=J.#$[E]}return J.#f.push({[$]:{handler:P,possibleKeys:X.filter((G,S,Y)=>Y.indexOf(G)===S),score:this.#Q}}),J}#P($,z,P,J){let Q=[];for(let X=0,G=$.#f.length;X<G;X++){let S=$.#f[X],Y=S[z]||S[W],Z={};if(Y!==void 0){if(Y.params=Object.create(null),Q.push(Y),P!==u||J&&J!==u)for(let L=0,E=Y.possibleKeys.length;L<E;L++){let N=Y.possibleKeys[L],R=Z[Y.score];Y.params[N]=J?.[N]&&!R?J[N]:P[N]??J?.[N],Z[Y.score]=!0}}}return Q}search($,z){let P=[];this.#J=u;let Q=[this],X=Rf(z),G=[];for(let S=0,Y=X.length;S<Y;S++){let Z=X[S],L=S===Y-1,E=[];for(let N=0,R=Q.length;N<R;N++){let I=Q[N],U=I.#$[Z];if(U)if(U.#J=I.#J,L){if(U.#$["*"])P.push(...this.#P(U.#$["*"],$,I.#J));P.push(...this.#P(U,$,I.#J))}else E.push(U);for(let V=0,h=I.#z.length;V<h;V++){let c=I.#z[V],j=I.#J===u?{}:{...I.#J};if(c==="*"){let F=I.#$["*"];if(F)P.push(...this.#P(F,$,I.#J)),F.#J=j,E.push(F);continue}let[K0,Ff,x]=c;if(!Z&&!(x instanceof RegExp))continue;let K=I.#$[K0],M0=X.slice(S).join("/");if(x instanceof RegExp){let F=x.exec(M0);if(F){if(j[Ff]=F[0],P.push(...this.#P(K,$,I.#J,j)),Object.keys(K.#$).length){K.#J=j;let _0=F[0].match(/\//)?.length??0;(G[_0]||=[]).push(K)}continue}}if(x===!0||x.test(Z))if(j[Ff]=Z,L){if(P.push(...this.#P(K,$,j,I.#J)),K.#$["*"])P.push(...this.#P(K.#$["*"],$,j,I.#J))}else K.#J=j,E.push(K)}}Q=E.concat(G.shift()??[])}if(P.length>1)P.sort((S,Y)=>{return S.score-Y.score});return[P.map(({handler:S,params:Y})=>[S,Y])]}};var _f=class{name="TrieRouter";#f;constructor(){this.#f=new U0}add(f,$,z){let P=ff($);if(P){for(let J=0,Q=P.length;J<Q;J++)this.#f.insert(f,P[J],z);return}this.#f.insert(f,$,z)}match(f,$){return this.#f.search(f,$)}};var Vf=class extends E0{constructor(f={}){super(f);this.router=f.router??new Mf({routers:[new Qf,new _f]})}};function v1(){let f=new Vf;return f.get("/health",($)=>{return $.json({ok:!0,timestamp:new Date().toISOString()})}),f.post("/check",async($)=>{let z=await $.req.json(),{identifier:P,platform:J="whatsapp"}=z;if(!P)return $.json({error:"identifier is required"},400);let Q=t(P,J),X=!Q.allowed?"deny":Q.trust==="limited"?"limited":"allow";return p(P,J,X,Q.reason),$.json(Q)}),f.get("/contacts",($)=>{let z=$.req.query("platform"),P=$.req.query("trust"),J=d(z,P);return $.json({contacts:J})}),f.post("/contacts",async($)=>{let z=await $.req.json(),{identifier:P,platform:J="whatsapp",trust:Q="trusted",name:X,notes:G}=z;if(!P)return $.json({error:"identifier is required"},400);let S=m(P,J,Q,X,G);return $.json({contact:S})}),f.delete("/contacts/:identifier",($)=>{let z=$.req.param("identifier"),P=$.req.query("platform")||"whatsapp",J=r(z,P);return $.json({removed:J})}),f.get("/audit",($)=>{let z=parseInt($.req.query("limit")||"100"),P=$.req.query("decision"),J=n({limit:z,decision:P});return $.json({entries:J})}),f}function j0(f=3847){let $=v1();console.log(`wasp server listening on http://localhost:${f}`),console.log("Endpoints:"),console.log("  POST /check         - Check if contact is allowed"),console.log("  GET  /contacts      - List contacts"),console.log("  POST /contacts      - Add contact"),console.log("  DELETE /contacts/:id - Remove contact"),console.log("  GET  /audit         - View audit log"),console.log("  GET  /health        - Health check"),Bun.serve({port:f,fetch:$.fetch})}function B0(f){if(!w())console.error("wasp is not initialized. Run `wasp init` first."),process.exit(1);let $=f.port||3847;j0($)}var u1="0.0.1";B.name("wasp").description("Security whitelist layer for Moltbot and agentic systems").version(u1);B.command("init").description("Initialize wasp database").option("-f, --force","Reinitialize even if already initialized").action((f)=>{rf(f.force)});B.command("add <identifier>").description("Add a contact to the whitelist").option("-p, --platform <platform>","Platform (whatsapp, telegram, email, discord, slack, signal)","whatsapp").option("-t, --trust <level>","Trust level (sovereign, trusted, limited)","trusted").option("-n, --name <name>","Contact name").option("--notes <notes>","Notes about this contact").action((f,$)=>{y(),df(f,$)});B.command("remove <identifier>").description("Remove a contact from the whitelist").option("-p, --platform <platform>","Platform","whatsapp").action((f,$)=>{y(),tf(f,$.platform)});B.command("list").description("List all contacts").option("-p, --platform <platform>","Filter by platform").option("-t, --trust <level>","Filter by trust level").option("-j, --json","Output as JSON").action((f)=>{y(),pf(f)});B.command("check <identifier>").description("Check if a contact is allowed").option("-p, --platform <platform>","Platform","whatsapp").option("-j, --json","Output as JSON").option("-q, --quiet","Exit code only, no output").action((f,$)=>{y(),nf(f,$)});B.command("log").description("View audit log").option("-l, --limit <number>","Number of entries to show","50").option("-d, --denied","Show only denied entries").option("-j, --json","Output as JSON").action((f)=>{y(),of({...f,limit:parseInt(f.limit)})});B.command("serve").description("Start HTTP server for Moltbot integration").option("-p, --port <number>","Port to listen on","3847").action((f)=>{y(),B0({port:parseInt(f.port)})});function y(){if(!w())console.log("wasp is not initialized. Initializing now..."),s(),console.log("")}B.parse();
