#!/usr/bin/env bash
# Agent self-healing bootstrap script
# Idempotent â€” safe to run repeatedly

set -e

echo "ğŸ”§ Running bootstrap..."

# Check Bun
if ! command -v bun &>/dev/null; then
    echo "âŒ Bun not found."
    if command -v mise &>/dev/null; then
        echo "   â†’ Installing via mise..."
        mise install bun@latest
        mise use bun@latest
    else
        echo "   â†’ Install Bun: curl -fsSL https://bun.sh/install | bash"
        exit 1
    fi
fi
echo "âœ… Bun $(bun --version)"

# Install dependencies
echo "ğŸ“¥ Installing dependencies..."
bun install

# Check env
if [ ! -f ".env.local" ]; then
    if [ -f ".env.example" ]; then
        echo "âš ï¸  No .env.local found. Creating from .env.example..."
        cp .env.example .env.local
        echo "   â†’ Fill in the values in .env.local"
    fi
fi

# Run gate to verify environment
echo ""
echo "ğŸš¦ Verifying environment..."
./bin/gate 2>/dev/null && echo "âœ… Gate passed" || echo "âš ï¸  Gate has issues (run ./bin/gate for details)"

echo ""
echo "âœ… Bootstrap complete."
